<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RBX | Supreme Command</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #00E052; --danger: #FF453A; --warning: #FFD60A; --bg: #000000; --card: #111111; --border: rgba(255,255,255,0.1); --blue: #00A3FF; }
        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: white; margin: 0; padding: 10px; line-height: 1.4; }
        
        #pin-screen { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #admin-content { display: none; }

        .stats-header { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; 
            position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 10px 0;
        }
        .stat-card { background: var(--card); padding: 10px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-card div { font-size: 16px; font-weight: 900; color: var(--neon); }
        .stat-card label { font-size: 8px; text-transform: uppercase; opacity: 0.5; display: block; }
        
        .time-filter { grid-column: 1 / span 3; background: #111; color: var(--neon); border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-size: 10px; margin-bottom: 5px; outline: none; width: 100%; }

        .card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 15px; margin-bottom: 15px; }
        h2 { font-size: 11px; color: var(--neon); text-transform: uppercase; margin: 0 0 12px 0; letter-spacing: 2px; }

        input, select { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; outline: none; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; font-size: 12px; text-transform: uppercase; }
        .btn-neon { background: var(--neon); color: #000; }
        .btn-risk { background: #1a1a1a; color: var(--danger); border: 1px solid var(--danger); margin-top: 8px; }

        #profile-preview { background: rgba(0,224,82,0.05); border: 1px solid var(--neon); border-radius: 15px; padding: 15px; display: none; margin-top: 15px; }
        .prof-header { display: flex; align-items: center; gap: 12px; }
        .prof-header img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--neon); }

        .tab-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; }
        .tab-btn { background: #111; color: #666; border: 1px solid #222; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 11px; }
        .tab-btn.active { background: var(--neon); color: black; }
        .feed-container { background: #080808; border-radius: 20px; padding: 10px; min-height: 400px; border: 1px solid var(--border); }
        .feed-item { display: flex; align-items: center; gap: 12px; background: #151515; padding: 12px; border-radius: 15px; margin-bottom: 8px; border: 1px solid #222; }

        @media (min-width: 900px) {
            body { padding: 30px; display: grid; grid-template-columns: 380px 1fr; gap: 30px; }
            .stats-header { grid-column: 1 / span 2; grid-template-columns: repeat(6, 1fr); }
            .time-filter { grid-column: 1 / span 6; }
        }
    </style>
</head>
<body>

    <div id="pin-screen">
        <h2 style="font-size: 14px; margin-bottom: 20px;">SYSTEM ENCRYPTION ACTIVE</h2>
        <input type="password" id="pin-input" placeholder="ENTER PIN" style="width: 220px; text-align: center; letter-spacing: 8px; font-size: 20px;">
        <button class="btn btn-neon" onclick="checkPin()" style="width: 220px;">ACCESS DATABASE</button>
    </div>

    <div id="admin-content">
        <div class="stats-header">
            <select class="time-filter" id="stats-time-range" onchange="calculateAnalytics()">
                <option value="today">RANGE: TODAY</option>
                <option value="yesterday">RANGE: YESTERDAY</option>
                <option value="7days">RANGE: LAST 7 DAYS</option>
                <option value="month">RANGE: THIS MONTH</option>
                <option value="lifetime">RANGE: LIFETIME</option>
            </select>
            <div class="stat-card"><div id="c-users">0</div><label>Users</label></div>
            <div class="stat-card"><div id="c-posts">0</div><label>Posts</label></div>
            <div class="stat-card"><div id="c-risk">0</div><label>Risk</label></div>
            <div class="stat-card"><div id="c-polls">0</div><label>Polls</label></div>
            <div class="stat-card"><div id="c-views" style="color: var(--blue);">0</div><label>Views</label></div>
            <div class="stat-card"><div id="c-clicks" style="color: var(--warning);">0</div><label>Clicks</label></div>
        </div>

        <div class="sidebar">
            <div class="card">
                <h2>User Command</h2>
                <input type="text" id="search-handle" placeholder="@handle">
                <button class="btn btn-neon" onclick="lookupUser()">FETCH USER</button>
                <button class="btn btn-risk" onclick="loadRiskUsers()">VIEW RISK USERS</button>

                <div id="profile-preview">
                    <div class="prof-header">
                        <img id="p-img" src="">
                        <div><b id="p-handle"></b><div id="p-uid" style="font-size: 9px; opacity: 0.5;"></div></div>
                    </div>
                    <button class="btn btn-risk" style="margin-top:15px" onclick="banSelectedUser()">PERMA BAN USER</button>
                </div>
            </div>

            <div class="card">
                <h2>System Controls</h2>
                <select id="m-toggle">
                    <option value="false">ðŸŸ¢ STATUS: LIVE</option>
                    <option value="true">ðŸ”´ STATUS: MAINTENANCE</option>
                </select>
                <label style="font-size: 9px; opacity: 0.5; margin-bottom: 5px; display: block;">EVENT CLOCK</label>
                <input type="datetime-local" id="target-time">
                <button class="btn btn-neon" onclick="updateSystem()">SYNC MAINFRAME</button>
            </div>
        </div>

        <div class="main-content">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="loadFeed('post', this)">POSTS</button>
                <button class="tab-btn" onclick="loadFeed('users', this)">USERS</button>
                <button class="tab-btn" onclick="loadFeed('poll', this)">POLLS</button>
            </div>
            <div class="feed-container" id="feed-display"></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
        authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
        databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
        projectId: "itzhoyoo-f9f7e",
        storageBucket: "itzhoyoo-f9f7e.filestorage.app",
        messagingSenderId: "1094792075584",
        appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let selectedUID = null;

    window.checkPin = () => {
        if(document.getElementById('pin-input').value === "08042006") {
            document.getElementById('pin-screen').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            initMain();
        } else { alert("ACCESS DENIED"); }
    };

    function initMain() {
        updateStats();
        calculateAnalytics();
        loadFeed('post');
    }

    // --- ANALYTICS (Views/Clicks) ---
    window.calculateAnalytics = async () => {
        const range = document.getElementById('stats-time-range').value;
        const now = Date.now();
        const todayStart = new Date().setHours(0,0,0,0);
        let min = 0;

        if(range === 'today') min = todayStart;
        else if(range === 'yesterday') min = todayStart - 86400000;
        else if(range === '7days') min = now - (7 * 86400000);
        else if(range === 'month') min = new Date(new Date().getFullYear(), new Date().getMonth(), 1).getTime();

        ['views', 'clicks'].forEach(async (path) => {
            const snap = await get(ref(db, path));
            if(!snap.exists()) return document.getElementById(`c-${path}`).innerText = "0";
            const items = Object.values(snap.val());
            const count = items.filter(i => {
                const ts = i.timestamp || 0;
                if(range === 'lifetime') return true;
                if(range === 'yesterday') return ts >= min && ts < todayStart;
                return ts >= min;
            }).length;
            document.getElementById(`c-${path}`).innerText = count;
        });
    };

    // --- USER COMMANDS ---
    window.lookupUser = async () => {
        const handle = document.getElementById('search-handle').value.trim().toLowerCase().replace('@','');
        const snap = await get(ref(db, 'users'));
        if(!snap.exists()) return alert("No users in DB");
        
        let found = null;
        Object.entries(snap.val()).forEach(([uid, data]) => {
            if(data.handle?.toLowerCase() === handle) found = {uid, ...data};
        });

        if(found) {
            selectedUID = found.uid;
            document.getElementById('profile-preview').style.display = "block";
            document.getElementById('p-img').src = found.profilePic || '';
            document.getElementById('p-handle').innerText = "@" + found.handle;
            document.getElementById('p-uid').innerText = found.uid;
        } else { alert("User not found"); }
    };

    window.loadRiskUsers = async () => {
        const display = document.getElementById('feed-display');
        display.innerHTML = "Filtering Risk...";
        const snap = await get(ref(db, 'users'));
        display.innerHTML = "";
        Object.entries(snap.val() || {}).forEach(([uid, u]) => {
            if((u.trustScore || 100) < 30) {
                const div = document.createElement('div');
                div.className = "feed-item";
                div.style.border = "1px solid var(--danger)";
                div.innerHTML = `<div><b>@${u.handle}</b><br><small>Score: ${u.trustScore}%</small></div>`;
                display.appendChild(div);
            }
        });
    };

    // --- SYSTEM ---
    window.updateSystem = () => {
        const m = document.getElementById('m-toggle').value === "true";
        const time = new Date(document.getElementById('target-time').value).getTime() || 0;
        update(ref(db, 'app_settings'), { maintenance: m, timer: time });
        alert("Mainframe Updated");
    };

    function updateStats() {
        ['users', 'post', 'poll'].forEach(path => {
            onValue(ref(db, path), snap => {
                const count = snap.exists() ? Object.keys(snap.val()).length : 0;
                document.getElementById(`c-${path === 'post' ? 'posts' : (path === 'poll' ? 'polls' : 'users')}`).innerText = count;
            });
        });
    }

    window.loadFeed = async (type, btn) => {
        if(btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        const snap = await get(ref(db, type));
        const display = document.getElementById('feed-display');
        display.innerHTML = "";
        if(!snap.exists()) return;
        Object.entries(snap.val()).reverse().forEach(([id, data]) => {
            const div = document.createElement('div');
            div.className = "feed-item";
            div.innerHTML = `<div style="flex:1"><b>${data.handle || data.title || 'Entry'}</b></div><button onclick="deleteEntry('${type}','${id}')">DEL</button>`;
            display.appendChild(div);
        });
    };

    window.deleteEntry = async (t, id) => { if(confirm("Delete?")) { await remove(ref(db, `${t}/${id}`)); loadFeed(t); } };
</script>
</body>
</html>
