<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBX Community Hub</title>
    <style>
        :root { --bg: #000000; --glass: rgba(28, 30, 33, 0.85); --text: #ffffff; --primary: #0084ff; --border: #262626; --danger: #ff4444; --admin: #ffae00; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; }
        
        /* --- NEW LOADING & BETA STYLES --- */
        .loader-overlay { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #beta-panel { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(25px); z-index: 9000; display: flex; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        .beta-card { max-width: 400px; padding: 40px; border: 1px solid var(--border); border-radius: 32px; background: #0a0a0a; }

        #chat-loader { position: absolute; inset: 0; background: var(--bg); z-index: 20; display: none; align-items: center; justify-content: center; }
        /* -------------------------------- */

        .app-container { display: flex; width: 100vw; height: 100vh; transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .showing-chat { transform: translateX(-100%); }

        .sidebar { width: 100%; min-width: 100%; height: 100vh; display: flex; flex-direction: column; background: var(--bg); border-right: 1px solid var(--border); }
        .header { padding: 20px; border-bottom: 1px solid var(--border); }
        .room-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        .room-item { background: var(--glass); backdrop-filter: blur(10px); border-radius: 15px; padding: 12px; display: flex; align-items: center; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .room-item:hover { background: rgba(255,255,255,0.05); }
        .room-icon { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; margin-right: 15px; background: #222; flex-shrink: 0; }

        .chat-view { width: 100%; min-width: 100%; height: 100vh; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .chat-header { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--glass); backdrop-filter: blur(20px); }
        #messages-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }

        .msg { padding: 12px; border-radius: 18px; max-width: 80%; border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(5px); }
        .received { background: rgba(40, 40, 40, 0.5); align-self: flex-start; }
        .sent { background: rgba(0, 132, 255, 0.15); align-self: flex-end; border-color: var(--primary); }
        .admin-msg { border-color: var(--admin) !important; background: rgba(255, 174, 0, 0.08) !important; }
        .admin-tag { background: var(--admin); color: #000; font-size: 9px; padding: 2px 5px; border-radius: 4px; font-weight: 800; margin-left: 5px; vertical-align: middle; }

        .chat-img { max-width: 100%; border-radius: 12px; margin-top: 8px; border: 1px solid var(--border); }
        .visit-btn { display: inline-block; background: var(--primary); color: white; padding: 8px 16px; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: bold; margin-top: 8px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: 0.3s; }
        .modal-overlay.active { visibility: visible; opacity: 1; }
        .modal-card { background: #161719; width: 85%; max-width: 380px; padding: 25px; border-radius: 24px; border: 1px solid var(--border); text-align: center; }
        .modal-card input { width: 100%; box-sizing: border-box; background: #000; border: 1px solid var(--border); color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 12px; outline: none; }

        .btn-main { background: var(--primary); color: #fff; border: none; padding: 14px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 30px; background: var(--primary); color: white; border: none; font-size: 30px; cursor: pointer; z-index: 50; }
        
        .svg-icon { width: 22px; height: 22px; fill: #fff; }
        .pin-active { fill: var(--primary) !important; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="global-loader" class="loader-overlay">
    <div class="spinner"></div>
    <p style="margin-top:15px; font-size:10px; letter-spacing:3px; opacity:0.5;">LOADING ASSETS</p>
</div>

<div id="beta-panel">
    <div class="beta-card">
        <h1 style="font-size:32px; margin-bottom:10px;">BETA VERSION</h1>
        <p style="opacity:0.6; line-height:1.6; margin-bottom:20px;">Testing phase active. Some features may be experimental.</p>
        <p style="color:var(--primary); font-weight:bold; margin-bottom:30px;">Final Version: April 2026</p>
        <button class="btn-main" onclick="closeBeta()">Continue Anyway</button>
    </div>
</div>

<div id="create-modal" class="modal-overlay">
    <div class="modal-card">
        <h2 style="margin-top:0">Create Community</h2>
        <input type="text" id="newRoomName" placeholder="Community Name">
        <div style="text-align:left; font-size:12px; margin-bottom:10px; opacity:0.6;">Community Icon:</div>
        <input type="file" id="newRoomIcon" accept="image/*">
        <button class="btn-main" id="confirmCreateBtn">Create Now</button>
        <button onclick="toggleModal(false)" style="background:none; border:none; color:#fff; margin-top:10px; opacity:0.5; width:100%; cursor:pointer;">Cancel</button>
    </div>
</div>

<div id="main-wrapper" class="app-container">
    <aside class="sidebar">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0">Communities</h2>
                <small id="user-count" style="color:var(--primary)">0 Users</small>
            </div>
            <div style="background:var(--glass); border-radius:12px; padding:10px; display:flex; align-items:center; margin-top:15px; border:1px solid var(--border);">
                <input type="text" id="searchInput" placeholder="Search groups..." oninput="renderRooms()" style="background:none; border:none; color:white; width:100%; outline:none;">
            </div>
        </div>

        <div class="room-list">
            <div class="room-item" onclick="openChat('global', 'Global Group Chat')">
                <div style="background:var(--primary); width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; margin-right:15px;">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                </div>
                <div style="flex:1"><strong>Global Group Chat</strong><br><small style="opacity:0.5">Public Hub</small></div>
            </div>
            <div id="rooms-render" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>
        <button class="fab" onclick="toggleModal(true)">+</button>
    </aside>

    <main class="chat-view">
        <div id="chat-loader"><div class="spinner"></div></div>

        <div class="chat-header">
            <div onclick="closeChat()" style="color:var(--primary); cursor:pointer; font-weight:bold;">‚Äπ Back</div>
            <div style="flex:1; margin-left:15px;">
                <strong id="active-title">Chat</strong><br>
                <small id="active-members" style="color:var(--primary)">0 members</small>
            </div>
            <div id="header-actions" style="display:flex; align-items:center; gap:12px;"></div>
        </div>
        <div id="messages-container"></div>
        <div style="padding:15px; background:var(--glass); border-top:1px solid var(--border); display:flex; gap:10px; align-items:center;">
            <label style="cursor:pointer;">
                <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 4.5H5l3.5-4.5z"/></svg>
                <input type="file" id="chatImgIn" class="hidden" onchange="uploadToChat(this.files[0])">
            </label>
            <input type="text" id="msgInput" style="flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:12px; border-radius:20px; color:#fff; outline:none;" placeholder="Message..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" style="background:none; border:none; color:var(--primary); font-weight:bold;">SEND</button>
        </div>
    </main>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const config = {
        apiKey: "AIzaSyCW8q5yo-l6NscNuWaQm7CnbKqhwdtMRY8",
        authDomain: "rbxcommunity-8bd8d.firebaseapp.com",
        databaseURL: "https://rbxcommunity-8bd8d-default-rtdb.firebaseio.com",
        projectId: "rbxcommunity-8bd8d",
        storageBucket: "rbxcommunity-8bd8d.firebasestorage.app",
        messagingSenderId: "621545488722",
        appId: "1:621545488722:web:e1f7e52737b3cb43ea7a8b",
        measurementId: "G-P50841M2PE"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const IMGUR_ID = "891e5bb4aa94282";

    let user = null, currentId = null, rooms = [], userMeta = {};

    window.closeBeta = () => document.getElementById('beta-panel').style.display = 'none';
    window.addEventListener('load', () => {
        setTimeout(() => {
            const loader = document.getElementById('global-loader');
            if(loader){ loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
        }, 1200);
    });

    onAuthStateChanged(auth, u => {
        if(u) {
            user = u;
            const handle = u.email.split('@')[0];
            set(ref(db, `users/${u.uid}`), { name: u.displayName, pfp: u.photoURL, handle: handle, last: Date.now() });
            onValue(ref(db, `user_settings/${u.uid}`), s => { userMeta = s.val() || {}; renderRooms(); if(currentId) setupHeader(currentId); });
        } else { signInWithPopup(auth, provider); }
    });

    // --- URL & IMAGE PARSER ---
    function parseMessage(text) {
        if (!text) return "";
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            if (url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
                return `<img src="${url}" class="chat-img" style="max-width:100%; border-radius:12px; margin-top:8px; display:block; border:1px solid var(--border);">`;
            }
            return `<br><a href="${url}" target="_blank" class="visit-btn" style="display:inline-block; background:var(--primary); color:white; padding:10px 18px; border-radius:10px; text-decoration:none; font-size:12px; font-weight:bold; margin-top:8px;">Visit Link</a>`;
        });
    }

    onValue(ref(db, 'rooms'), s => { 
        rooms = []; s.forEach(c => { rooms.push({id: c.key, ...c.val()}); }); 
        renderRooms(); 
    });

    window.renderRooms = () => {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const cont = document.getElementById('rooms-render');
        cont.innerHTML = "";
        rooms.filter(r => r.name.toLowerCase().includes(q)).forEach(r => {
            cont.innerHTML += `<div class="room-item" onclick="openChat('${r.id}', '${r.name}')"><img src="${r.icon || 'https://i.imgur.com/6VBx3io.png'}" class="room-icon"><div style="flex:1"><strong>${r.name}</strong></div></div>`;
        });
    };

    window.openChat = (id, name) => {
        const cl = document.getElementById('chat-loader');
        if(cl) cl.style.display = 'flex';
        setTimeout(() => {
            currentId = id;
            document.getElementById('active-title').innerText = name;
            document.getElementById('main-wrapper').classList.add('showing-chat');
            setupHeader(id);
            loadMsgs(id);
            if(cl) cl.style.display = 'none';
        }, 300);
    };

    function loadMsgs(id) {
        const path = id === 'global' ? 'global_msgs' : `msgs/${id}`;
        onValue(ref(db, path), snap => {
            const cont = document.getElementById('messages-container');
            cont.innerHTML = "";
            const roomOwner = rooms.find(r=>r.id===id)?.owner;
            snap.forEach(c => {
                const m = c.val(), isMe = user && m.uid === user.uid, isOwner = m.uid === roomOwner;
                const time = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const msgDiv = document.createElement('div');
                msgDiv.className = `msg ${isMe ? 'sent' : 'received'} ${isOwner ? 'admin-msg' : ''}`;
                
                msgDiv.innerHTML = `
                    <div style="display:flex; align-items:center; gap:6px; margin-bottom:5px; font-size:11px; opacity:0.8;">
                        <img src="${m.pfp}" style="width:18px; height:18px; border-radius:50%">
                        <span style="${isOwner ? 'color:var(--admin)' : ''}">${m.name} ${isOwner ? '<span class="admin-tag">ADMIN</span>' : ''}</span>
                        <span style="font-size:9px; opacity:0.5;">‚Ä¢ ${time}</span>
                    </div>
                    <div style="word-break: break-word;">${parseMessage(m.text)}</div>`;
                cont.appendChild(msgDiv);
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }

    window.setupHeader = (id) => {
        const act = document.getElementById('header-actions'); act.innerHTML = '';
        if(id === 'global') { document.getElementById('active-members').innerText = "Public Hub"; return; }
        
        const room = rooms.find(r=>r.id===id);
        const isOwner = room?.owner === user.uid;
        
        onValue(ref(db, `members/${id}/${user.uid}`), s => {
            const isJoined = s.exists();
            act.innerHTML = `
                <button onclick="${isJoined ? 'exitRoom()' : 'joinRoom()'}" style="background:var(--primary); color:#fff; border:none; padding:8px 15px; border-radius:10px; font-weight:bold; cursor:pointer; font-size:12px;">${isJoined ? 'Exit' : 'Join'}</button>
                ${isOwner ? `<button onclick="delRoom('${id}')" style="background:var(--danger); color:#fff; border:none; padding:8px 10px; border-radius:10px; margin-left:5px; cursor:pointer;">üóëÔ∏è</button>` : ''}
            `;
        });
        onValue(ref(db, `members/${id}`), s => document.getElementById('active-members').innerText = `${s.size || 0} members`);
    };

    window.joinRoom = () => set(ref(db, `members/${currentId}/${user.uid}`), true);
    window.exitRoom = () => remove(ref(db, `members/${currentId}/${user.uid}`));
    window.delRoom = (id) => confirm("Delete community?") && remove(ref(db, `rooms/${id}`)) && closeChat();
    
    window.sendMsg = () => {
        const input = document.getElementById('msgInput');
        const val = input.value.trim();
        if(!val || !user || !currentId) return;
        const path = currentId === 'global' ? 'global_msgs' : `msgs/${currentId}`;
        
        push(ref(db, path), {
            uid: user.uid,
            name: user.displayName,
            pfp: user.photoURL,
            text: val,
            time: Date.now()
        });
        input.value = "";
    };

    window.closeChat = () => document.getElementById('main-wrapper').classList.remove('showing-chat');
</script>

</body>
</html>
