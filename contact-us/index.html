<!DOCTYPE html>
<html lang="en">
<head>
<script>(function(s){s.dataset.zone='9105850',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBX Community</title>
</head>
<body>
<style>
*{box-sizing:border-box;user-select:none;outline:none;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#121212;color:#fff;}
header{height:50px;display:flex;align-items:center;justify-content:space-between;background:#000;border-bottom:1px solid #2a2a2a;padding:0 12px;position:sticky;top:0;z-index:1000;}
.logo{height:36px;}
.header-right{display:flex;align-items:center;gap:12px;}
.profile{width:32px;height:32px;border-radius:50%;background-size:cover;background-position:center;cursor:pointer;border:2px solid #fff;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;opacity:1;}
.hamburger{width:32px;height:24px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;padding:2px;background:#000;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.5);transition: transform 0.2s;}
.hamburger div{height:4px;background:#fff;border-radius:6px;transition:all 0.3s ease;}
.hamburger.active div:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.active div:nth-child(2){opacity:0;}
.hamburger.active div:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}
.menu-overlay{position:fixed;top:50px;left:0;width:100%;height:100vh;background:#000;overflow-y:auto;transform:translateY(-100%);transition:transform 0.3s ease;z-index:900;display:flex;flex-direction:column;align-items:center;padding-top:20px;}
.menu-overlay.active{transform:translateY(0);}
.menu-overlay a{color:#fff;text-decoration:none;font-size:20px;margin:12px 0;font-weight:bold;}
.menu-overlay a:hover{color:#ccc;}
main{padding:20px;min-height:200vh;}

/* Profile Panel */
.profile-panel{position:fixed;top:0;left:0;width:100%;height:100vh;background:#111;transform:translateX(100%);transition:transform 0.3s ease;z-index:1100;display:flex;flex-direction:column;}
.profile-panel.active{transform:translateX(0);}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #222;}
.close-btn{background:#ff3b30;color:#fff;padding:6px 16px;font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:transform 0.2s;}
.close-btn:hover{transform:scale(1.05);}
.panel-top{display:flex;flex-direction:column;align-items:center;margin:20px 0;gap:12px;}
#panelProfilePic{width:100px;height:100px;border-radius:50%;border:3px solid #fff;background-size:cover;background-position:center;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;cursor:pointer;}
#userInfo{color:#fff;font-size:16px;display:flex;flex-direction:column;align-items:center;gap:6px;}
#copyLinkContainer{display:flex;align-items:center;gap:8px;width:90%;max-width:300px;}
#copyLinkContainer input{flex:1;padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;}
#copyLinkContainer button{background:#4caf50;color:#fff;border:none;padding:6px 12px;border-radius:12px;cursor:pointer;font-weight:bold;}
#copyStatus{font-size:12px;margin-top:6px;}
.spinner{border:4px solid #ccc;border-top:4px solid #4caf50;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin-top:6px;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
button.login-btn{background:#4caf50;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;}
.profile-panel .panel-header {
  background-color: #000; /* solid black */
  border-bottom: 1px solid #222; /* optional, keeps subtle separation */
}
#headerProfile, #panelProfilePic {
  background-image: url('https://i.imgur.com/cM3Givj.jpeg'); /* default */
  background-size: cover;
  background-position: center;
}
/* Disable text selection highlight */
* {
  user-select: none;       /* Prevent selecting text */
  -webkit-user-select: none; 
  -moz-user-select: none;
  -ms-user-select: none;
}

/* Remove input, textarea, button blue outline on focus */
input:focus,
textarea:focus,
button:focus,
select:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* Remove blue tap highlight on mobile */
* {
  -webkit-tap-highlight-color: transparent; 
}

/* Optional: remove link tap highlight */
a:focus, a:active {
  outline: none !important;
}
#panelProfilePic {
  position:relative;
}
#uploadSpinner {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  display:none;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#saveHandleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #fff; /* white edges */
  background: rgba(0,0,0,0.5); /* glassy black */
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  backdrop-filter: blur(6px); /* glass effect */
  transition: none; /* no hover/movement */
}

#saveHandleBtn:active {
  transform: none; /* no click movement */
}
</style>
<style>  
{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#121212; color:#fff; padding:20px;}  
h1 { text-align:center; font-size:24px; color:#00bfff; margin-bottom:20px; }  
  
.poll-feed-container {  
  display:flex;  
  overflow-x:auto;  
  gap:16px;  
  padding-bottom:16px;  
}  
.poll-feed-container::-webkit-scrollbar { height:6px; }  
.poll-feed-container::-webkit-scrollbar-thumb { background:#00bfff; border-radius:6px; }  
.poll-feed-container::-webkit-scrollbar-track { background:#1a1a1a; border-radius:6px; }  
  
.poll-card { flex:0 0 300px; background:#1c1c1c; border-radius:18px; padding:16px; border:1px solid rgba(255,255,255,0.1); }  
  
.poll-card h2 { color:#00bfff; font-size:18px; margin-bottom:10px; }  
  
ul { list-style:none; padding-left:0; margin-bottom:10px; }  
li { background:#181818; padding:10px 12px; border-radius:12px; margin-bottom:8px; cursor:pointer; position: relative; overflow: hidden; transition:0.2s; }  
.vote-bar { position:absolute; top:0; left:0; height:100%; background:#00bfff; width:0%; z-index:0; border-radius:12px; opacity:0.3; transition:width 0.3s; }  
.vote-label { position: relative; z-index:1; display:flex; justify-content: space-between; }  
  
.comments { background:#fff; color:#121212; border-radius:12px; padding:8px; max-height:110px; min-height:110px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-top:8px; }  
.comment { background:#f1f1f1; padding:6px 10px; border-radius:12px; display:flex; gap:10px; align-items:center; font-size:14px; }  
.comment img { width:28px; height:28px; border-radius:50%; object-fit:cover; }  
.comment span { display:block; }  
  
.comment-form { display:flex; gap:8px; margin-top:8px; }  
.comment-form input { flex:1; padding:8px 10px; border-radius:12px; border:none; background:#1a1a1a; color:#fff; }  
.comment-form button { padding:8px 12px; border-radius:12px; border:none; background:#00bfff; color:#121212; cursor:pointer; }  
  
.poll-author { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }  
.author-left { display:flex; align-items:center; gap:6px; }  
.author-left img { width:36px; height:36px; border-radius:50%; border:2px solid #00bfff; object-fit:cover; }  
.author-left span { font-weight:500; }  
.verified-badge { width:16px; height:16px; margin-left:4px; vertical-align:middle; }  
  
.follow-btn, .delete-btn { padding:6px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:500; }  
.follow-btn { background:#00bfff; color:#121212; }  
.follow-btn.following { background:#1a1a1a; color:#00bfff; border:1px solid #00bfff; }  
.delete-btn { background:#f44336; color:#fff; }  
  
.spinner { border:4px solid rgba(255,255,255,0.1); border-top:4px solid #00bfff; border-radius:50%; width:32px; height:32px; animation:spin 1s linear infinite; margin:30px auto; }  
  
.status-msg { text-align:center; margin:12px 0; font-size:14px; }  
  
.confirm-popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:999; display:none; }  
.confirm-popup .popup-content { background:#1c1c1c; padding:20px; border-radius:16px; width:90%; max-width:300px; text-align:center; }  
.confirm-popup button { margin:10px; padding:8px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:500; }  
.confirm-popup .confirm { background:#4caf50; color:#fff; }  
.confirm-popup .cancel { background:#f44336; color:#fff; }  
  
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}  
.comments {  
  background:#fff;   
  color:#121212;   
  border-radius:12px;   
  padding:8px;   
  height:110px; /* Fixed height */  
  overflow-y:auto;   
  display:flex;   
  flex-direction:column;   
  gap:6px;   
  margin-top:8px;  
}  
.comments {  
  background: rgba(255, 255, 255, 0.05); /* glassy effect */  
  backdrop-filter: blur(6px);  
  border-radius: 12px;   
  padding: 8px;   
  height: 110px; /* fixed height */  
  display: flex;   
  flex-direction: column;   
  gap: 6px;   
  margin-top: 8px;  
}  
  
.comment-counter {  
  align-self: flex-end;  
  padding: 4px 10px;  
  border-radius: 12px;  
  background: rgba(255, 255, 255, 0.1); /* glassy */  
  color: #fff;  
  font-size: 12px;  
  font-weight: 600;  
  border: 1px solid #fff; /* white edge */  
  flex-shrink: 0;  
}  
  
.comments-list {  
  overflow-y: auto;  
  flex: 1; /* take remaining space */  
}  
  
.comment-form input {  
  flex: 1;  
  padding: 8px 10px;  
  border-radius: 12px;  
  border: 1px solid #fff; /* white edge */  
  background: rgba(255, 255, 255, 0.05); /* glassy */  
  color: #fff;  
  outline: none;  
}  
  
.comment-form button {  
  padding: 8px 12px;  
  border-radius: 12px;  
  border: none;  
  background: rgba(255, 255, 255, 0.15); /* glassy */  
  color: #fff;  
  cursor: pointer;  
}  
.poll-feed-container, 
.poll-feed-container * {
    color: #fff !important;
}

/* Keep backgrounds and borders as you have them */
.poll-card { 
    background: #1c1c1c; 
    border-radius: 18px; 
    padding: 16px; 
    border: 1px solid rgba(255,255,255,0.1); 
}

/* Optional: vote labels */
.vote-label span {
    color: #fff !important;
}

/* Optional: comment text */
.comment span {
    color: #fff !important;
}

/* Author names */
.author-left span {
    color: #fff !important;
}
.comments {
  background: #000; /* black background */
  color: #fff; /* text white */
  border-radius: 12px;
  padding: 8px;
  height: 110px; /* fixed height */
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
  /* optional glassy blur effect */
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.1);
}

.comment {
  background: #181818; /* keep each comment slightly lighter */
  color: #fff;
}
</style>  
<header>
  <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="logo">
  <div class="header-right">
    <div class="profile" id="headerProfile"></div>
    <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <a href="#">Home</a>
  <a href="#">Community</a>
  <a href="#">Games</a>
  <a href="#">Events</a>
  <a href="#">Profile</a>
  <a href="#">Settings</a>
</div>

<div class="profile-panel" id="profilePanel">
  <div class="panel-header">
    <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="profile-logo" style="height:40px; object-fit:contain;">
    <button class="close-btn" id="closeProfile">Close</button>
  </div>
  <div class="panel-top">
    <div id="panelProfilePic"></div>
    <div id="userInfo"></div>
    <div id="copyLinkContainer">
      <input type="text" id="userLink" readonly>
      <button id="copyLinkBtn">Copy</button>
    </div>
    <span id="copyStatus"></span>
    <div class="spinner" id="uploadSpinner"></div>
    <input type="file" id="profileInput" accept="image/*" style="display:none;">
  </div>
<div class="panel-content" style="padding:20px; flex:1; display:flex; flex-direction:column;">
 <!-- Handle / Username Edit -->
<div id="handleContainer" style="display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:12px;">
  <input type="text" id="handleInput" placeholder="Username / Handle" 
         style="padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;width:60%;">
 <button id="saveHandleBtn">Save Handle</button>
  <span id="handleStatus" style="font-size:12px;color:#ccc;"></span>
</div>
  <!-- User Stats -->
  <div class="profile-stats" style="display:flex;justify-content:space-around;width:100%;margin-bottom:20px;">
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statPosts">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Posts</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowers">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Followers</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowing">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Following</p>
    </div>
  </div>


<div style="width:100%;background:#1a1a1a;padding:12px;border-radius:12px;margin-bottom:12px;">
  <h3 style="margin:0 0 8px 0;font-size:16px;">About Me</h3>
  <textarea id="userBioTextarea" maxlength="100" placeholder="Write something about yourself..." 
            style="width:100%;background:#222;color:#ccc;border:none;padding:8px;border-radius:8px;resize:none;font-size:14px;outline:none;"></textarea>
  <div id="bioCharCount" style="text-align:right;font-size:12px;color:#777;margin-top:4px;">0 / 100</div>
  <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <button id="saveProfileBtn" style="padding:8px 16px;border-radius:12px;border:none;background:#2196F3;color:#fff;font-weight:bold;cursor:pointer;flex-shrink:0;">Save Profile</button>
    <div class="spinner" id="saveProfileSpinner" style="width:20px;height:20px;border:3px solid #ccc;border-top:3px solid #4caf50;border-radius:50%;animation:spin 1s linear infinite;display:none;"></div>
    <span id="saveProfileStatus" style="font-size:12px;color:#4caf50;"></span>
  </div>
</div>

  </div>
</div>

<main style="padding:12px; background:#121212;">
  <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:bold; color:white; font-size:14px;">
    FEATURED PROFILES
    <img width="24" height="24" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified-badge"/>
  </div>

  <div id="userContainer" style="display:flex; overflow-x:auto; gap:12px; padding:8px 0; scrollbar-width:none;"></div>
<h1>Polls</h1>  
<div class="status-msg" id="statusMsg"></div>  
<div class="poll-feed-container" id="pollFeed"></div>  
<div class="spinner" id="spinner"></div>  
  
<div class="confirm-popup" id="confirmPopup">  
  <div class="popup-content">  
    <p id="confirmText">Are you sure you want to delete this poll?</p>  
    <button class="confirm" id="confirmYes">Yes</button>  
    <button class="cancel" id="confirmNo">Cancel</button>  
  </div>  
</div>  

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, push, update, runTransaction, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= ELEMENTS ================= */
const hamburger = document.getElementById('hamburger');
const menuOverlay = document.getElementById('menuOverlay');
const headerProfile = document.getElementById('headerProfile');
const profilePanel = document.getElementById('profilePanel');
const closeProfile = document.getElementById('closeProfile');
const panelProfilePic = document.getElementById('panelProfilePic');
const userInfo = document.getElementById('userInfo');
const userLinkInput = document.getElementById('userLink');
const copyBtn = document.getElementById('copyLinkBtn');
const copyStatus = document.getElementById('copyStatus');
const uploadSpinner = document.getElementById('uploadSpinner');
const profileInput = document.getElementById('profileInput');
const userBioTextarea = document.getElementById('userBioTextarea');
const bioCharCount = document.getElementById('bioCharCount');
const statPosts = document.getElementById('statPosts');
const statFollowers = document.getElementById('statFollowers');
const statFollowing = document.getElementById('statFollowing');
const handleInput = document.getElementById('handleInput');
const saveHandleBtn = document.getElementById('saveHandleBtn');
const handleStatus = document.getElementById('handleStatus');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const saveProfileSpinner = document.getElementById('saveProfileSpinner');
const saveProfileStatus = document.getElementById('saveProfileStatus');
const featuredContainer = document.getElementById("userContainer");
const pollFeed = document.getElementById('pollFeed');
const spinner = document.getElementById('spinner');
const statusMsg = document.getElementById('statusMsg');
const confirmPopup = document.getElementById('confirmPopup');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

/* ================= UTILS ================= */
let currentUser = null;

function notify(el,msg,ok=true,t=2000){
  if(!el) return;
  el.textContent=msg;
  el.style.color=ok?'#4caf50':'#f44336';
  setTimeout(()=>el.textContent='',t);
}

function showStatus(msg,type='success'){ notify(statusMsg,msg,type==='success'); }

function randomColor(){ return `hsl(${Math.random()*360},80%,60%)`; }

function count(val){ if(!val) return 0; if(typeof val==='number') return val; if(typeof val==='object') return Object.keys(val).length; return 0; }

function createSpinner(){ const s=document.createElement('div'); s.style.cssText=`width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;`; return s; }

function timeAgo(ts){ const now=Date.now(); const diff=now-ts; const sec=Math.floor(diff/1000), min=Math.floor(sec/60), hr=Math.floor(min/60), day=Math.floor(hr/24); if(day>0) return `${day} day${day>1?'s':''} ago`; if(hr>0) return `${hr} hour${hr>1?'s':''} ago`; if(min>0) return `${min} min${min>1?'s':''} ago`; return 'just now'; }

function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

const style=document.createElement('style'); style.innerHTML=`@keyframes spin{to{transform:rotate(360deg)}}`; document.head.appendChild(style);

/* ================= UI ================= */
hamburger?.addEventListener('click',()=>{
  hamburger.classList.toggle('active');
  menuOverlay.classList.toggle('active');
});

headerProfile?.addEventListener('click',()=>{
  profilePanel.classList.add('active');
  document.body.style.overflow='hidden';
});

closeProfile?.addEventListener('click',()=>{
  profilePanel.classList.remove('active');
  document.body.style.overflow='auto';
});

copyBtn?.addEventListener('click',()=>{
  if(!userLinkInput.value || userLinkInput.value.includes('Login')) return;
  navigator.clipboard.writeText(userLinkInput.value);
  notify(copyStatus,'Copied');
});

panelProfilePic?.addEventListener('click',()=>profileInput.click());
profileInput?.addEventListener('change',async()=>{
  if(!profileInput.files[0] || !currentUser) return;
  uploadSpinner.style.display='block';
  const formData=new FormData();
  formData.append('image',profileInput.files[0]);
  try{
    const res=await fetch('https://api.imgur.com/3/image',{method:'POST',headers:{Authorization:'Client-ID 891e5bb4aa94282'},body:formData});
    const data=await res.json();
    if(data.success){
      await set(ref(db, `users/${currentUser.uid}/profilePic`),data.data.link);
      panelProfilePic.style.backgroundImage=`url(${data.data.link})`;
      headerProfile.style.backgroundImage=`url(${data.data.link})`;
      notify(saveProfileStatus,'Profile picture updated!');
    } else notify(saveProfileStatus,'Upload failed!',false);
  } catch(e){ console.error(e); notify(saveProfileStatus,'Upload error!',false);}
  uploadSpinner.style.display='none';
});

/* ================= AUTH ================= */
onAuthStateChanged(auth, async user=>{
  currentUser=user||null;

  if(!user){
    userInfo.innerHTML='';
    userLinkInput.value='Login to get link';
    statPosts.textContent=0;
    statFollowers.textContent=0;
    statFollowing.textContent=0;
    loadFeaturedUsers();
    loadPolls();
    return;
  }

  const uid = user.uid;
  userLinkInput.value=`${location.origin}/profile?uid=${uid}`;

  const snap = await get(ref(db, `users/${uid}`));
  const data = snap.val() || {};
  
  const followers = count(data.followers);
  const followingSnap = await get(ref(db, `following/${uid}`));
  const following = followingSnap.exists() ? Object.keys(followingSnap.val()).length : 0;

  statFollowers.textContent = followers;
  statFollowing.textContent = following;
  statPosts.textContent = count(data.posts);

  userInfo.innerHTML=`@${data.handle||'user'} (${followers})`;

  if(data.profilePic){
    headerProfile.style.backgroundImage=`url(${data.profilePic})`;
    panelProfilePic.style.backgroundImage=`url(${data.profilePic})`;
  }

  if(userBioTextarea){
    userBioTextarea.value=data.bio||'';
    bioCharCount.textContent=`${userBioTextarea.value.length} / 100`;
  }

  handleInput.value = data.handle || 'user';

  loadFeaturedUsers();
  loadPolls();
});

/* ================= SAVE HANDLE ================= */
saveHandleBtn?.addEventListener('click',async()=>{
  if(!currentUser) return notify(handleStatus,'Login first',false);
  const h = handleInput.value.trim();
  if(h.length<3) return notify(handleStatus,'Too short',false);

  const allSnap = await get(ref(db,'users'));
  const allUsers = allSnap.val() || {};
  const taken = Object.entries(allUsers).some(([uid,u])=>u.handle?.toLowerCase()===h.toLowerCase() && uid!==currentUser.uid);
  if(taken) return notify(handleStatus,'Handle already taken!',false);

  await set(ref(db, `users/${currentUser.uid}/handle`), h);
  notify(handleStatus,'Saved');
});

/* ================= SAVE PROFILE ================= */
saveProfileBtn?.addEventListener('click', async ()=>{
  if(!currentUser) return;
  saveProfileSpinner.style.display='block';
  if(userBioTextarea) await set(ref(db,`users/${currentUser.uid}/bio`), userBioTextarea.value);
  if(handleInput?.value.trim().length>=3) await set(ref(db,`users/${currentUser.uid}/handle`), handleInput.value.trim());
  saveProfileSpinner.style.display='none';
  notify(saveProfileStatus,'Saved');
});

/* ================= FEATURED USERS ================= */
async function loadFeaturedUsers(){
  if(!featuredContainer) return;
  try{
    const snap = await get(ref(db,'users'));
    if(!snap.exists()){ featuredContainer.innerHTML="<p style='color:#888;'>No users found.</p>"; return; }

    let allUsers = Object.entries(snap.val());
    allUsers.sort(()=>0.5-Math.random());
    const featured10 = allUsers.slice(0,10);
    featuredContainer.innerHTML='';

    // Pre-fetch current user's following
    let myFollowing = new Set();
    if(currentUser){
      const fSnap = await get(ref(db, `following/${currentUser.uid}`));
      if(fSnap.exists()) myFollowing = new Set(Object.keys(fSnap.val()));
    }

    featured10.forEach(([uid,user])=>{
      const div=document.createElement('div');
      div.style.cssText="flex:0 0 auto; width:70px; display:flex; flex-direction:column; align-items:center;";

      const imgWrapper=document.createElement('div');
      imgWrapper.style.cssText=`width:60px;height:60px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid #fff;transition:border-color 1s;`;
      const img=document.createElement('img');
      img.src = user.profilePic || 'https://via.placeholder.com/60?text=?';
      img.style.cssText="width:100%;height:100%;object-fit:cover;";
      imgWrapper.appendChild(img);
      div.appendChild(imgWrapper);
      setInterval(()=>{ imgWrapper.style.borderColor=randomColor(); },1000);

      const handleDiv = document.createElement('div');
      handleDiv.textContent = '@'+(user.handle||'user');
      handleDiv.style.cssText="max-width:70px;font-size:10px;color:#fff;margin-top:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
      div.appendChild(handleDiv);

      const followerDiv=document.createElement('div');
      followerDiv.style.cssText="font-size:9px;color:#bbb;text-align:center;margin-top:2px;";
      div.appendChild(followerDiv);

      const button=document.createElement('button');
      button.style.cssText="margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;background:#2e89ff;color:#fff;cursor:pointer;text-align:center;";
      div.appendChild(button);

      const msg=document.createElement('span');
      msg.style.cssText="color:#ff6b6b;font-size:10px;margin-top:2px;display:none;text-align:center;";
      div.appendChild(msg);

      async function updateButton(){
        const fSnap = await get(ref(db, `users/${uid}/followers`));
        followerDiv.textContent = (fSnap.val()||0)+' followers';
        if(!currentUser){
          button.textContent='Follow';
          button.style.background='#2e89ff';
          return;
        }
        const isFollowing = myFollowing.has(uid);
        button.textContent = isFollowing?'Following':'Follow';
        button.style.background = isFollowing?'#4caf50':'#2e89ff';
      }
      updateButton();

      button.addEventListener('click', async ()=>{
        if(!currentUser){
          msg.textContent="Only logged in users can follow"; 
          msg.style.display='block';
          setTimeout(()=> msg.style.display='none',2000);
          return;
        }

        const spinner=createSpinner();
        button.innerHTML=''; button.appendChild(spinner); button.disabled=true;

        const path = ref(db, `following/${currentUser.uid}/${uid}`);
        const snap = await get(path);
        let followState = false;
        if(!snap.exists()){
          await set(path,true);
          await runTransaction(ref(db, `users/${uid}/followers`), c=>(c||0)+1);
          myFollowing.add(uid);
          followState = true;
        } else {
          await set(path,null);
          await runTransaction(ref(db, `users/${uid}/followers`), c=>Math.max((c||0)-1,0));
          myFollowing.delete(uid);
        }

        statFollowing.textContent = myFollowing.size;
        updateButton();
        button.disabled=false;
      });

      featuredContainer.appendChild(div);
    });
  }catch(e){ console.error(e); }
}

/* ================= POLL MODULE ================= */
let deletePollId = null;

async function loadPolls(){
  if(!pollFeed) return;
  spinner.style.display='block';
  try{
    const snap = await get(ref(db, '/poll'));
    if(!snap.exists()){ spinner.style.display='none'; return; }

    let polls = Object.entries(snap.val());
    polls = shuffleArray(polls);

    let following = [];
    if(currentUser){
      const followingSnap = await get(ref(db, `/following/${currentUser.uid}`));
      if(followingSnap.exists()) following = Object.keys(followingSnap.val());
    }

    pollFeed.innerHTML='';
    for(const [id,data] of polls) renderPoll(id,data,following);
  }catch(e){ console.error(e); showStatus('Error loading polls','error'); }
  finally{ spinner.style.display='none'; }
}

async function renderPoll(pollId,data,following=[]){
  const card=document.createElement('div'); card.className='poll-card';
  card.dataset.uid = data.uid;

  // Author section
  const authorSection=document.createElement('div'); authorSection.className='poll-author';
  const authorLeft=document.createElement('div'); authorLeft.className='author-left';
  const profileImg=document.createElement('img'); profileImg.src='default-avatar.png';
  const authorHandle=document.createElement('span'); authorHandle.textContent='@user';
  authorLeft.append(profileImg,authorHandle); authorSection.append(authorLeft);

  const actionBtn=document.createElement('button');
  if(currentUser?.uid===data.uid){
    actionBtn.className='delete-btn'; actionBtn.textContent='Delete';
    actionBtn.addEventListener('click',()=>{ deletePollId=pollId; confirmPopup.style.display='flex'; });
  } else {
    actionBtn.className='follow-btn';
    const isFollowing=following.includes(data.uid);
    actionBtn.textContent=isFollowing?'Following':'Follow';
    if(isFollowing) actionBtn.classList.add('following');

    actionBtn.addEventListener('click',async ()=>{
      if(!currentUser){ showStatus('Login required','error'); return; }
      const followRef=ref(db, `/users/${data.uid}/followers/${currentUser.uid}`);
      const followingRef=ref(db, `/following/${currentUser.uid}/${data.uid}`);
      const snap=await get(followRef);
      let followState=false;
      if(snap.exists()){ await remove(followRef); await remove(followingRef); followState=false; }
      else{ await update(followRef,{timestamp:Date.now()}); await update(followingRef,{timestamp:Date.now()}); followState=true; }

      document.querySelectorAll(`.poll-card[data-uid="${data.uid}"] .follow-btn`).forEach(btn=>{
        btn.textContent = followState ? 'Following' : 'Follow';
        btn.classList.toggle('following', followState);
      });
    });
  }
  authorSection.append(actionBtn); card.appendChild(authorSection);

  // Fetch author data
  get(ref(db, `/users/${data.uid}`)).then(uSnap=>{
    const u=uSnap.val()||{};
    profileImg.src=u.profilePic||'default-avatar.png';
    authorHandle.textContent='@'+(u.handle||'user');
    if(u.followers && Object.keys(u.followers).length>=1000){
      const img=document.createElement('img'); img.src='https://img.icons8.com/stickers/100/verified-badge.png';
      img.className='verified-badge'; img.style.width='16px'; img.style.height='16px'; img.style.marginLeft='4px';
      authorHandle.appendChild(img);
    }
  });

  // Poll question
  const title=document.createElement('h2'); title.textContent=data.question; card.appendChild(title);

  // Footer (time & views)
  const footer=document.createElement('div'); footer.style.display='flex'; footer.style.justifyContent='space-between'; footer.style.fontSize='12px'; footer.style.opacity='0.7';
  const timeSpan=document.createElement('span'); timeSpan.textContent=timeAgo(data.timestamp||Date.now());
  const viewsSpan=document.createElement('span'); viewsSpan.textContent='Views: 0';
  footer.append(timeSpan,viewsSpan); card.appendChild(footer);

  const viewRef=ref(db, `/pollViews/${pollId}`);
  runTransaction(viewRef,v=>(v||0)+1).then(txSnap => { viewsSpan.textContent = `Views: ${txSnap.snapshot.val()}`; });

// Options & voting
const ul = document.createElement('ul'); card.appendChild(ul);
data.options.forEach((opt, idx) => {
  const li = document.createElement('li');
  li.innerHTML = `<div class="vote-bar"></div><div class="vote-label"><span>${opt}</span><span>0 votes</span></div>`;
  ul.appendChild(li);

  li.addEventListener('click', async () => {
    if (!currentUser) { showStatus('Login required','error'); return; }
    const voteRef = ref(db, `/poll/${pollId}/votes/${idx}`);
    const userVoteRef = ref(db, `/pollVotes/${pollId}/${currentUser.uid}`);
    const votedSnap = await get(userVoteRef);
    if (votedSnap.exists()) { showStatus('You already voted','error'); return; }
    await runTransaction(voteRef, v => (v || 0) + 1);
    await update(userVoteRef, { option: idx });
    showStatus('Vote submitted','success');
  });
});

// Real-time votes update
onValue(ref(db, `/poll/${pollId}/votes`), snap => {
  const votes = snap.val() || {};
  const totalVotes = Object.values(votes).reduce((a,b)=>a+b,0) || 1;
  card.querySelectorAll('li').forEach((li,i)=>{
    const count = votes[i] || 0;
    const perc = Math.round((count/totalVotes)*100);
    li.querySelector('.vote-bar').style.width = perc+'%';
    li.querySelector('.vote-label span:last-child').textContent = `${count} votes (${perc}%)`;
  });
});

// Comments
const commentsDiv = document.createElement('div'); commentsDiv.className='comments';
commentsDiv.style.display='flex'; commentsDiv.style.flexDirection='column'; commentsDiv.style.height='110px';
const commentCounter = document.createElement('div'); commentCounter.className='comment-counter'; commentCounter.textContent='Comments: 0';
commentsDiv.appendChild(commentCounter);
const commentsList = document.createElement('div'); commentsList.className='comments-list'; commentsList.style.flex='1'; commentsList.style.overflowY='auto';
commentsDiv.appendChild(commentsList);
card.appendChild(commentsDiv);

const commentForm = document.createElement('form'); commentForm.className='comment-form';
commentForm.innerHTML=`<input type="text" placeholder="Add comment" required><button type="submit">Post</button>`;
const commentInput = commentForm.querySelector('input');
card.appendChild(commentForm);

// Real-time comments
onValue(ref(db, `/pollComments/${pollId}`), async snap=>{
  const comments = snap.val() || {};
  commentsList.innerHTML='';
  const allComments = Object.entries(comments).sort((a,b)=>a[1].timestamp-b[1].timestamp);
  commentCounter.textContent=`Comments: ${allComments.length}`;
  for(const [key,c] of allComments){
    let handle='user', profile='default-avatar.png';
    try{
      const userSnap = await get(ref(db, `/users/${c.uid}`));
      const u = userSnap.val()||{};
      handle = u.handle||'user';
      profile = u.profilePic||'default-avatar.png';
    } catch(e){ console.error(e); }
    const div = document.createElement('div'); div.className='comment';
    const timeText = c.timestamp ? ` (${timeAgo(c.timestamp)})` : '';
    div.innerHTML = `<img src="${profile}" alt="avatar"><span><strong>@${handle}</strong>${timeText}: ${c.text}</span>`;
    commentsList.appendChild(div);
  }
});

// Comment submission
commentForm.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!currentUser){ showStatus('Login required','error'); return; }
  const text = commentInput.value.trim();
  if(!text) return;
  try{
    await push(ref(db, `/pollComments/${pollId}`), {text, uid: currentUser.uid, timestamp: Date.now()});
    commentInput.value='';
    showStatus('Comment added','success');
  }catch(e){ showStatus('Failed to add comment','error'); }
});

pollFeed.appendChild(card);
}

/* ================= DELETE POLL CONFIRM ================= */
confirmNo.addEventListener('click',()=>{ confirmPopup.style.display='none'; deletePollId=null; });
confirmYes.addEventListener('click', async ()=>{
  if(!deletePollId) return;
  try{
    await remove(ref(db, `/poll/${deletePollId}`));
    await remove(ref(db, `/pollVotes/${deletePollId}`));
    await remove(ref(db, `/pollComments/${deletePollId}`));
    pollFeed.innerHTML='';
    loadPolls();
    showStatus('Poll deleted','success');
  }catch(e){ showStatus('Failed to delete poll','error'); }
  finally{ confirmPopup.style.display='none'; deletePollId=null; }
});

/* ================= INITIAL LOAD ================= */
loadFeaturedUsers();
loadPolls();
</script>
</main>
</body>
</html>