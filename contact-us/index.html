<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBX Community Feed</title>
<style>
body {
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background: #121212;
  color: #fff;
  margin: 0;
  padding: 0;
}
header {
  padding: 10px 15px;
  background: #1f1f1f;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
header h1 { margin:0; font-size: 1.2em; }
header span { font-size: 0.9em; color: #aaa; }
section.selector button {
  margin: 5px;
  padding: 8px 15px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  background: #2c2c2c;
  color: #fff;
}
section.selector button.active { background: #00bfff; color:#000; }
.type-fields { display:none; margin:10px 0; }
input, select, textarea { width: 90%; padding:8px; margin:5px 0; border-radius:12px; border:none; background:#2c2c2c; color:#fff; }
button#createBtn { background:#00bfff; color:#000; padding:10px 20px; border:none; border-radius:12px; cursor:pointer; margin-top:10px; }
#feedContainer { padding:10px; }
.post-card { background:#1f1f1f; padding:10px; margin-bottom:10px; border-radius:12px; }
.post-user { display:flex; align-items:center; gap:10px; margin-bottom:5px; }
.post-profile-pic { width:35px; height:35px; border-radius:50%; object-fit:cover; }
.post-content img { max-width:100%; border-radius:12px; margin-top:5px; }
.pollOption { width: 80%; margin:5px 0; }
.option-row { display:flex; justify-content:center; }
</style>
</head>
<body>

<header>
  <h1>RBX Community</h1>
  <span id="userInfo">@user (0)</span>
</header>

<section class="selector">
  <button data-type="post" class="active">Post</button>
  <button data-type="story">Story</button>
  <button data-type="poll">Poll</button>
</section>

<div class="type-fields" data-type="post">
  <input type="text" id="postTitle" placeholder="Title (required)">
  <textarea id="postDescription" placeholder="Description (required)"></textarea>
  <select id="postCategory">
    <option value="">Select category</option>
    <option value="1">Category 1</option>
    <option value="2">Category 2</option>
    <option value="3">Category 3</option>
    <option value="4">Category 4</option>
    <option value="5">Category 5</option>
  </select>
  <select id="postPrivacy">
    <option value="public">Public</option>
    <option value="private">Private</option>
  </select>
  <input type="text" id="postLink" placeholder="Optional link">
  <input type="file" id="postImageInput">
  <div id="postImagePreview">No Image</div>
  <label><input type="checkbox" id="postSponsored"> Sponsored</label>
</div>

<div class="type-fields" data-type="story">
  <input type="text" id="storyTitle" placeholder="Optional title">
  <input type="file" id="storyImageInput">
  <div id="storyImagePreview">No Image</div>
  <select id="storyPrivacy">
    <option value="public">Public</option>
    <option value="private">Private</option>
  </select>
  <input type="text" id="storyLink" placeholder="Link (required)">
  <select id="storyLinkType">
    <option value="">Link type</option>
    <option value="roblox">Roblox</option>
    <option value="website">Website</option>
  </select>
</div>

<div class="type-fields" data-type="poll">
  <input type="text" id="pollQuestion" placeholder="Question">
  <div id="pollOptionsContainer">
    <div class="option-row"><input type="text" class="pollOption" placeholder="Option 1"></div>
    <div class="option-row"><input type="text" class="pollOption" placeholder="Option 2"></div>
  </div>
  <button id="addPollOption">Add Option</button>
</div>

<button id="createBtn">Create</button>
<div id="createSpinner" style="display:none;">Loading...</div>
<div id="statusMsg"></div>

<div id="feedContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, push, get, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9cd31082a5"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* Elements */
const typeButtons = document.querySelectorAll('section.selector button');
const typeFields = document.querySelectorAll('.type-fields');
let selectedType = 'post';
const createBtn = document.getElementById('createBtn');
const spinner = document.getElementById('createSpinner');
const statusMsg = document.getElementById('statusMsg');
const pollContainer = document.getElementById('pollOptionsContainer');
const feedContainer = document.getElementById('feedContainer');
const userInfo = document.getElementById('userInfo');

let currentUser = null;

/* Type selector */
typeButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    typeButtons.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedType = btn.dataset.type;
    typeFields.forEach(f => f.style.display = f.dataset.type === selectedType ? 'block' : 'none');
  });
});

/* Image previews */
function setupImagePreview(inputId, previewId) {
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  input.addEventListener('change', () => {
    const file = input.files[0];
    if (!file) { preview.innerHTML = 'No Image'; return; }
    const url = URL.createObjectURL(file);
    preview.innerHTML = `<img src="${url}">`;
  });
}
setupImagePreview('postImageInput','postImagePreview');
setupImagePreview('storyImageInput','storyImagePreview');

/* Poll options */
document.getElementById('addPollOption').addEventListener('click', () => {
  const count = pollContainer.querySelectorAll('.pollOption').length;
  if(count>=3) return;
  const row = document.createElement('div');
  row.className = 'option-row';
  row.innerHTML = `<input type="text" class="pollOption" placeholder="Option ${count+1}">`;
  pollContainer.appendChild(row);
});

/* Auth state */
onAuthStateChanged(auth,user=>{
  if(!user){currentUser=null; return;}
  currentUser=user;
  renderFeed();
});

/* Upload image to Imgur */
async function uploadImage(file){
  if(!file) return '';
  const fd = new FormData();
  fd.append('image',file);
  try{
    const res = await fetch('https://api.imgur.com/3/image',{
      method:'POST',
      headers:{Authorization:'Client-ID 891e5bb4aa94282'},
      body:fd
    });
    const data = await res.json();
    return data.success && data.data?.link?data.data.link:'';
  }catch(e){ console.error(e); return ''; }
}

/* Create post/story/poll */
createBtn.addEventListener('click',async()=>{
  if(!currentUser){statusMsg.style.color='#f44336';statusMsg.textContent='Login required'; return;}
  spinner.style.display='block';
  statusMsg.textContent='';
  let postData={uid:currentUser.uid, timestamp:Date.now()};
  try{
    if(selectedType==='post'){
      const title=document.getElementById('postTitle').value.trim().slice(0,16);
      const desc=document.getElementById('postDescription').value.trim().slice(0,250);
      const cat=document.getElementById('postCategory').value;
      const priv=document.getElementById('postPrivacy').value;
      const sponsored=document.getElementById('postSponsored').checked;
      const link=document.getElementById('postLink').value.trim();
      const imageFile=document.getElementById('postImageInput').files[0];
      if(!title||!desc||!cat||!priv||!imageFile) throw 'All required fields must be filled';
      const imageUrl = await uploadImage(imageFile);
      if(!imageUrl) throw 'Image upload failed';
      postData={...postData,type:'post',title,description:desc,category:cat,privacy:priv,image:imageUrl,link:sponsored?link:'',sponsored};
    }else if(selectedType==='story'){
      const imageFile=document.getElementById('storyImageInput').files[0];
      const priv=document.getElementById('storyPrivacy').value;
      const link=document.getElementById('storyLink').value.trim();
      const linkType=document.getElementById('storyLinkType').value;
      const title=document.getElementById('storyTitle')?.value.trim().slice(0,10)||'';
      if(!imageFile||!priv||!link||!linkType) throw 'All required fields must be filled';
      const imageUrl = await uploadImage(imageFile);
      if(!imageUrl) throw 'Image upload failed';
      postData={...postData,type:'story',image:imageUrl,privacy:priv,link,linkType,title};
    }else if(selectedType==='poll'){
      const q=document.getElementById('pollQuestion').value.trim().slice(0,24);
      const options=[...document.querySelectorAll('.pollOption')].map(o=>o.value.trim()).filter(o=>o);
      if(!q||options.length<2) throw 'Question and at least 2 options required';
      postData={...postData,type:'poll',question:q,options};
    }
    await push(ref(db,`/${selectedType}`),postData);
    const userPostsRef = ref(db,`users/${currentUser.uid}/posts`);
    await runTransaction(userPostsRef,current=>(current||0)+1);
    statusMsg.style.color='#4caf50';
    statusMsg.textContent=`${selectedType.charAt(0).toUpperCase()+selectedType.slice(1)} created!`;
    clearFields();
    renderFeed();
  }catch(e){console.error(e);statusMsg.style.color='#f44336';statusMsg.textContent=e.toString();}
  finally{spinner.style.display='none';}
});

/* Clear fields */
function clearFields(){
  if(selectedType==='post'){
    document.getElementById('postTitle').value='';
    document.getElementById('postDescription').value='';
    document.getElementById('postCategory').value='';
    document.getElementById('postPrivacy').value='public';
    document.getElementById('postSponsored').checked=false;
    document.getElementById('postLink').value='';
    document.getElementById('postImagePreview').innerHTML='No Image';
    document.getElementById('postImageInput').value='';
  }
  if(selectedType==='story'){
    document.getElementById('storyPrivacy').value='public';
    document.getElementById('storyLink').value='';
    document.getElementById('storyLinkType').value='';
    document.getElementById('storyImagePreview').innerHTML='No Image';
    document.getElementById('storyImageInput').value='';
    if(document.getElementById('storyTitle')) document.getElementById('storyTitle').value='';
  }
  if(selectedType==='poll'){
    pollContainer.innerHTML=`<div class="option-row"><input type="text" class="pollOption" placeholder="Option 1"></div>
    <div class="option-row"><input type="text" class="pollOption" placeholder="Option 2"></div>`;
    document.getElementById('pollQuestion').value='';
  }
}

/* Feed loader - uses UID subscription for live handle/profile */
async function renderFeed(){
  feedContainer.innerHTML='';
  try{
    const snap = await get(ref(db,'/post'));
    if(!snap.exists()){ feedContainer.innerHTML='<p>No posts yet.</p>'; return; }
    const posts = Object.entries(snap.val()).sort((a,b)=>b[1].timestamp-a[1].timestamp);
    for(const [id,post] of posts){
      const card=document.createElement('div'); card.className='post-card';
      const userSec=document.createElement('div'); userSec.className='post-user';
      const profileImg=document.createElement('img'); profileImg.className='post-profile-pic';
      const handleEl=document.createElement('strong');
      // live subscription to user's UID
      onValue(ref(db,`users/${post.uid}`),snap=>{
        const u=snap.val()||{};
        profileImg.src=u.profilePic||'default-avatar.png';
        handleEl.textContent=`@${u.handle||'user'}`;
      });
      userSec.appendChild(profileImg); userSec.appendChild(handleEl);
      card.appendChild(userSec);

      const contentSec=document.createElement('div'); contentSec.className='post-content';
      if(post.type==='post'){
        contentSec.innerHTML=`<h3>${post.title}</h3><p>${post.description}</p>${post.image?`<img src="${post.image}">`:''}`;
      }else if(post.type==='story'){
        contentSec.innerHTML=`<p>${post.title||''}</p>${post.image?`<img src="${post.image}">`:''}`;
      }else if(post.type==='poll'){
        contentSec.innerHTML=`<p>${post.question}</p><ul>${post.options.map(o=>`<li>${o}</li>`).join('')}</ul>`;
      }
      card.appendChild(contentSec);
      feedContainer.appendChild(card);
    }
  }catch(e){console.error(e); feedContainer.innerHTML='<p>Error loading feed.</p>';}
}
</script>

</body>
</html>