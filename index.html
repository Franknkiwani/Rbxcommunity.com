<!DOCTYPE html>
<html lang="en">
<head>
<script>(function(s){s.dataset.zone='9105850',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBX Community</title>
</head>
<body>
<style>
*{box-sizing:border-box;user-select:none;outline:none;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#121212;color:#fff;}
header{height:50px;display:flex;align-items:center;justify-content:space-between;background:#000;border-bottom:1px solid #2a2a2a;padding:0 12px;position:sticky;top:0;z-index:1000;}
.logo{height:36px;}
.header-right{display:flex;align-items:center;gap:12px;}
.profile{width:32px;height:32px;border-radius:50%;background-size:cover;background-position:center;cursor:pointer;border:2px solid #fff;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;opacity:1;}
.hamburger{width:32px;height:24px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;padding:2px;background:#000;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.5);transition: transform 0.2s;}
.hamburger div{height:4px;background:#fff;border-radius:6px;transition:all 0.3s ease;}
.hamburger.active div:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.active div:nth-child(2){opacity:0;}
.hamburger.active div:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}
.menu-overlay{position:fixed;top:50px;left:0;width:100%;height:100vh;background:#000;overflow-y:auto;transform:translateY(-100%);transition:transform 0.3s ease;z-index:900;display:flex;flex-direction:column;align-items:center;padding-top:20px;}
.menu-overlay.active{transform:translateY(0);}
.menu-overlay a{color:#fff;text-decoration:none;font-size:20px;margin:12px 0;font-weight:bold;}
.menu-overlay a:hover{color:#ccc;}
main{padding:20px;min-height:200vh;}

/* Profile Panel */
.profile-panel{position:fixed;top:0;left:0;width:100%;height:100vh;background:#111;transform:translateX(100%);transition:transform 0.3s ease;z-index:1100;display:flex;flex-direction:column;}
.profile-panel.active{transform:translateX(0);}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #222;}
.close-btn{background:#ff3b30;color:#fff;padding:6px 16px;font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:transform 0.2s;}
.close-btn:hover{transform:scale(1.05);}
.panel-top{display:flex;flex-direction:column;align-items:center;margin:20px 0;gap:12px;}
#panelProfilePic{width:100px;height:100px;border-radius:50%;border:3px solid #fff;background-size:cover;background-position:center;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;cursor:pointer;}
#userInfo{color:#fff;font-size:16px;display:flex;flex-direction:column;align-items:center;gap:6px;}
#copyLinkContainer{display:flex;align-items:center;gap:8px;width:90%;max-width:300px;}
#copyLinkContainer input{flex:1;padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;}
#copyLinkContainer button{background:#4caf50;color:#fff;border:none;padding:6px 12px;border-radius:12px;cursor:pointer;font-weight:bold;}
#copyStatus{font-size:12px;margin-top:6px;}
.spinner{border:4px solid #ccc;border-top:4px solid #4caf50;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin-top:6px;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
button.login-btn{background:#4caf50;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;}
.profile-panel .panel-header {
  background-color: #000; /* solid black */
  border-bottom: 1px solid #222; /* optional, keeps subtle separation */
}
#headerProfile, #panelProfilePic {
  background-image: url('https://i.imgur.com/cM3Givj.jpeg'); /* default */
  background-size: cover;
  background-position: center;
}
/* Disable text selection highlight */
* {
  user-select: none;       /* Prevent selecting text */
  -webkit-user-select: none; 
  -moz-user-select: none;
  -ms-user-select: none;
}

/* Remove input, textarea, button blue outline on focus */
input:focus,
textarea:focus,
button:focus,
select:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* Remove blue tap highlight on mobile */
* {
  -webkit-tap-highlight-color: transparent; 
}

/* Optional: remove link tap highlight */
a:focus, a:active {
  outline: none !important;
}
#panelProfilePic {
  position:relative;
}
#uploadSpinner {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  display:none;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#saveHandleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #fff; /* white edges */
  background: rgba(0,0,0,0.5); /* glassy black */
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  backdrop-filter: blur(6px); /* glass effect */
  transition: none; /* no hover/movement */
}

#saveHandleBtn:active {
  transform: none; /* no click movement */
}
</style>
<style>  
{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#121212; color:#fff; padding:20px;}  
h1 { text-align:center; font-size:24px; color:#00bfff; margin-bottom:20px; }  
  
.poll-feed-container {  
  display:flex;  
  overflow-x:auto;  
  gap:16px;  
  padding-bottom:16px;  
}  
.poll-feed-container::-webkit-scrollbar { height:6px; }  
.poll-feed-container::-webkit-scrollbar-thumb { background:#00bfff; border-radius:6px; }  
.poll-feed-container::-webkit-scrollbar-track { background:#1a1a1a; border-radius:6px; }  
  
.poll-card { flex:0 0 300px; background:#1c1c1c; border-radius:18px; padding:16px; border:1px solid rgba(255,255,255,0.1); }  
  
.poll-card h2 { color:#00bfff; font-size:18px; margin-bottom:10px; }  
  
ul { list-style:none; padding-left:0; margin-bottom:10px; }  
li { background:#181818; padding:10px 12px; border-radius:12px; margin-bottom:8px; cursor:pointer; position: relative; overflow: hidden; transition:0.2s; }  
.vote-bar { position:absolute; top:0; left:0; height:100%; background:#00bfff; width:0%; z-index:0; border-radius:12px; opacity:0.3; transition:width 0.3s; }  
.vote-label { position: relative; z-index:1; display:flex; justify-content: space-between; }  
  
.comments { background:#fff; color:#121212; border-radius:12px; padding:8px; max-height:110px; min-height:110px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-top:8px; }  
.comment { background:#f1f1f1; padding:6px 10px; border-radius:12px; display:flex; gap:10px; align-items:center; font-size:14px; }  
.comment img { width:28px; height:28px; border-radius:50%; object-fit:cover; }  
.comment span { display:block; }  
  
.comment-form { display:flex; gap:8px; margin-top:8px; }  
.comment-form input { flex:1; padding:8px 10px; border-radius:12px; border:none; background:#1a1a1a; color:#fff; }  
.comment-form button { padding:8px 12px; border-radius:12px; border:none; background:#00bfff; color:#121212; cursor:pointer; }  
  
.poll-author { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }  
.author-left { display:flex; align-items:center; gap:6px; }  
.author-left img { width:36px; height:36px; border-radius:50%; border:2px solid #00bfff; object-fit:cover; }  
.author-left span { font-weight:500; }  
.verified-badge { width:16px; height:16px; margin-left:4px; vertical-align:middle; }  
  
.follow-btn, .delete-btn { padding:6px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:500; }  
.follow-btn { background:#00bfff; color:#121212; }  
.follow-btn.following { background:#1a1a1a; color:#00bfff; border:1px solid #00bfff; }  
.delete-btn { background:#f44336; color:#fff; }  
  
.spinner { border:4px solid rgba(255,255,255,0.1); border-top:4px solid #00bfff; border-radius:50%; width:32px; height:32px; animation:spin 1s linear infinite; margin:30px auto; }  
  
.status-msg { text-align:center; margin:12px 0; font-size:14px; }  
  
.confirm-popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:999; display:none; }  
.confirm-popup .popup-content { background:#1c1c1c; padding:20px; border-radius:16px; width:90%; max-width:300px; text-align:center; }  
.confirm-popup button { margin:10px; padding:8px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:500; }  
.confirm-popup .confirm { background:#4caf50; color:#fff; }  
.confirm-popup .cancel { background:#f44336; color:#fff; }  
  
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}  
.comments {  
  background:#fff;   
  color:#121212;   
  border-radius:12px;   
  padding:8px;   
  height:110px; /* Fixed height */  
  overflow-y:auto;   
  display:flex;   
  flex-direction:column;   
  gap:6px;   
  margin-top:8px;  
}  
.comments {  
  background: rgba(255, 255, 255, 0.05); /* glassy effect */  
  backdrop-filter: blur(6px);  
  border-radius: 12px;   
  padding: 8px;   
  height: 110px; /* fixed height */  
  display: flex;   
  flex-direction: column;   
  gap: 6px;   
  margin-top: 8px;  
}  
  
.comment-counter {  
  align-self: flex-end;  
  padding: 4px 10px;  
  border-radius: 12px;  
  background: rgba(255, 255, 255, 0.1); /* glassy */  
  color: #fff;  
  font-size: 12px;  
  font-weight: 600;  
  border: 1px solid #fff; /* white edge */  
  flex-shrink: 0;  
}  
  
.comments-list {  
  overflow-y: auto;  
  flex: 1; /* take remaining space */  
}  
  
.comment-form input {  
  flex: 1;  
  padding: 8px 10px;  
  border-radius: 12px;  
  border: 1px solid #fff; /* white edge */  
  background: rgba(255, 255, 255, 0.05); /* glassy */  
  color: #fff;  
  outline: none;  
}  
  
.comment-form button {  
  padding: 8px 12px;  
  border-radius: 12px;  
  border: none;  
  background: rgba(255, 255, 255, 0.15); /* glassy */  
  color: #fff;  
  cursor: pointer;  
}  
.poll-feed-container, 
.poll-feed-container * {
    color: #fff !important;
}

/* Keep backgrounds and borders as you have them */
.poll-card { 
    background: #1c1c1c; 
    border-radius: 18px; 
    padding: 16px; 
    border: 1px solid rgba(255,255,255,0.1); 
}

/* Optional: vote labels */
.vote-label span {
    color: #fff !important;
}

/* Optional: comment text */
.comment span {
    color: #fff !important;
}

/* Author names */
.author-left span {
    color: #fff !important;
}
.comments {
  background: #000; /* black background */
  color: #fff; /* text white */
  border-radius: 12px;
  padding: 8px;
  height: 110px; /* fixed height */
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
  /* optional glassy blur effect */
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.1);
}

.comment {
  background: #181818; /* keep each comment slightly lighter */
  color: #fff;
}
/* Update these specific classes in your <style> block */

.profile-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: #111;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 1100;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent the whole panel from bouncing */
}

.panel-content {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* This allows scrolling inside the panel */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
}
/* Container for the title */
.title-scroll-container {
    overflow: hidden;
    white-space: nowrap;
    width: 100%;
}

/* The actual scrolling text */
.scrolling-title {
    display: inline-block;
    padding-left: 100%; /* Start off-screen to the right */
    animation: marquee 10s linear infinite;
}

@keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

/* Only animate if the title is long (optional) */
.glass-title-row h3 {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
}
/* Share Container Styles */
.share-container {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border);
    border-radius: 18px;
}

.share-label {
    font-size: 10px;
    font-weight: 900;
    color: var(--accent);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.share-link-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.share-input {
    flex-grow: 1;
    background: #000;
    border: 1px solid #333;
    padding: 10px;
    border-radius: 10px;
    color: #fff;
    font-size: 11px;
    outline: none;
    text-overflow: ellipsis;
}

.btn-copy {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 10px;
    font-weight: 900;
    font-size: 10px;
    cursor: pointer;
    border-bottom: 3px solid #0072B3;
}
#panelProfilePic {
  width: 90px; 
  height: 90px; 
  border-radius: 50%; 
  border: 3px solid #fff; /* White border to match header */
  background-image: url('https://i.imgur.com/cM3Givj.jpeg'); /* Default pic */
  background-size: cover;
  background-position: center;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s ease;
}
#feed {
    width: 100%;
    max-width: 1200px; /* Allow it to grow wider */
    margin: 0 auto;    /* Center the feed */
    display: grid;
    /* This creates as many 300px columns as will fit, then fills the space */
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    padding: 20px;
}

/* Ensure cards don't look weird when stretched */
.card {
    height: fit-content;
    width: 100%;
}

/* Tablet/Mobile adjustment: If screen is small, go back to 1 column */
@media (max-width: 600px) {
    #feed {
        grid-template-columns: 1fr;
        padding: 10px;
    }
}

/* Update the Profile Panel */
.profile-panel {
    position: fixed;
    top: 0;
    right: 0; /* Changed from left:0 to right:0 */
    width: 100%;
    max-width: 400px; /* Limits width on desktop */
    height: 100vh;
    background: #000;
    transform: translateX(100%); /* Keeps it off-screen to the right */
    transition: transform 0.3s ease-in-out;
    z-index: 2000; /* Ensure it's above everything */
    visibility: hidden; /* Extra safety: hides it from clicks when closed */
}

.profile-panel.active {
    transform: translateX(0);
    visibility: visible;
}

</style>  
    <style>
        :root {
            --bg: #050505; --card: #121214; --glass: rgba(255, 255, 255, 0.08);
            --accent: #00A2FF; --green: #00E052; --red: #FF4B4B; --text: #FFFFFF;
            --text-dim: #8E8E93; --border: #242426;
        }
        #feed { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px;}

        /* Toasts */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { padding: 12px; border-radius: 12px; font-weight: 800; font-size: 14px; margin-bottom: 8px; animation: slideDown 0.4s ease forwards; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .toast.success { background: var(--green); color: #000; }
        .toast.error { background: var(--red); color: #fff; }

        /* Card Elements */
        .card { background: var(--card); border-radius: 30px; border: 2px solid var(--border); overflow: hidden; position: relative; }
        .header { padding: 15px; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 15px; border: 2px solid var(--border); object-fit: cover; cursor: pointer; }
        .post-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: zoom-in; background: #222; }
        
        .glass-title-row { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            margin: -25px 15px 10px 15px; padding: 15px; border-radius: 20px; border: 1px solid var(--glass);
            position: relative; z-index: 10; pointer-events: none;
        }

        .btn-action { 
            background: var(--accent); color: white; border: none; height: 35px; min-width: 95px; 
            border-radius: 12px; font-weight: 900; cursor: pointer; border-bottom: 4px solid #0072B3; 
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .btn-action.following { background: var(--green); border-bottom-color: #009e3a; color: #000; }
        
        /* Modals */
        .modal { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%; background: #111; border-radius: 30px 30px 0 0; z-index: 1000; transition: 0.4s cubic-bezier(0,1,0,1); padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; border-top: 2px solid var(--border); }
        .modal.active { bottom: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 999; backdrop-filter: blur(5px); }
        
        #fullImageModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10001; display: none; align-items: center; justify-content: center; }
        #fullImgSrc { max-width: 100%; max-height: 85%; object-fit: contain; }

        #end-msg { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--red); color: white; text-align: center; padding: 10px; font-weight: 900; z-index: 998; display: none; font-size: 12px; }
        
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .header-right {
  display: flex;
  align-items: center;
  gap: 12px; /* Neatly spaces the button from the profile */
}

.rbx-small-btn {
  /* Layout & Size */
  padding: 4px 12px;
  font-size: 13px;
  height: 28px; /* Compact height */
  display: flex;
  align-items: center;
  justify-content: center;

  /* Black Glassy Design */
  background: rgba(15, 15, 15, 0.6); /* Translucent black */
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  
  /* White Curved Edges */
  border: 1.5px solid #FFFFFF;
  border-radius: 6px;
  
  /* Text Styling */
  color: #FFFFFF;
  font-family: "Gotham SSm", "Arial", sans-serif;
  font-weight: 600;
  text-transform: none;
  cursor: pointer;
  
  transition: all 0.2s ease;
}

/* Hover & Active States */
.rbx-small-btn:hover {
  background: rgba(15, 15, 15, 0.85);
  border-color: #f0f0f0;
  transform: translateY(-1px);
}

.rbx-small-btn:active {
  transform: scale(0.95);
  background: #000000;
}
.profile-edge-only {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #121212; /* Profile stays dark */
  cursor: pointer;
  z-index: 1;
}

.profile-edge-only::before {
  content: "";
  position: absolute;
  top: -2px; left: -2px; right: -2px; bottom: -2px;
  border-radius: 50%;
  padding: 2px; 
  
  background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8);
  background-size: 400%;
  
  /* Masking logic to keep the center clear */
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: destination-out;
  mask-composite: exclude;
  
  /* CHANGED: Slowed down to 7 seconds */
  animation: hueRotate 7s linear infinite; 
  z-index: -1;
}

@keyframes hueRotate {
  0% { filter: hue-rotate(0deg); }
  100% { filter: hue-rotate(360deg); }
}

.profile-edge-only:hover {
  transform: scale(1.1);
  transition: transform 0.2s ease;
}
.rbx-small-btn {
    cursor: pointer;
    /* ... your other styles ... */
}

    </style>
<div id="ios-loader" style="position:fixed; inset:0; background:#000; z-index:100000; display:flex; flex-direction:column; align-items:center; justify-content:center; transition: opacity 0.8s ease; font-family: -apple-system, sans-serif;">
    
    <style>
        /* Lock background scroll while loader exists */
        body { overflow: hidden !important; }
        
        .ios-tick-spinner { position: relative; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; }
        .ios-tick-spinner .bar {
            width: 3px; height: 10px; background: #636366; position: absolute;
            left: 50%; top: 50%; transform-origin: 50% 100%; border-radius: 2px;
            animation: ios-fade 1s linear infinite;
        }
        /* Radial positioning for 12 bars */
        .bar:nth-child(1) { transform: translate(-50%, -150%) rotate(0deg); animation-delay: 0s; }
        .bar:nth-child(2) { transform: translate(-50%, -150%) rotate(30deg); animation-delay: -0.916s; }
        .bar:nth-child(3) { transform: translate(-50%, -150%) rotate(60deg); animation-delay: -0.833s; }
        .bar:nth-child(4) { transform: translate(-50%, -150%) rotate(90deg); animation-delay: -0.75s; }
        .bar:nth-child(5) { transform: translate(-50%, -150%) rotate(120deg); animation-delay: -0.666s; }
        .bar:nth-child(6) { transform: translate(-50%, -150%) rotate(150deg); animation-delay: -0.583s; }
        .bar:nth-child(7) { transform: translate(-50%, -150%) rotate(180deg); animation-delay: -0.5s; }
        .bar:nth-child(8) { transform: translate(-50%, -150%) rotate(210deg); animation-delay: -0.416s; }
        .bar:nth-child(9) { transform: translate(-50%, -150%) rotate(240deg); animation-delay: -0.333s; }
        .bar:nth-child(10) { transform: translate(-50%, -150%) rotate(270deg); animation-delay: -0.25s; }
        .bar:nth-child(11) { transform: translate(-50%, -150%) rotate(300deg); animation-delay: -0.166s; }
        .bar:nth-child(12) { transform: translate(-50%, -150%) rotate(330deg); animation-delay: -0.083s; }

        @keyframes ios-fade { from { background: #fff; } to { background: #2c2c2e; } }
    </style>

    <div style="margin-bottom:30px;">
        <img src="https://i.imgur.com/cM3Givj.jpeg" style="max-width: 130px; height: auto; border-radius: 25px;">
    </div>

    <div class="ios-tick-spinner">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
        
        <span id="load-pct" style="color: #fff; font-size: 10px; font-weight: 700; position: absolute; top: 50%; transform: translateY(-50%);">0%</span>
    </div>
</div>

<header>
  <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="logo">
  <div class="header-right">
    <button class="rbx-small-btn" id="uploadBtn">Upload</button>
    
    <div class="profile profile-edge-only" id="headerProfile"></div>
    
    <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <a href="/" class="menu-link">
    HOME
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
  </a>

  <a href="/community" class="menu-link">
    COMMUNITY
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
  </a>

  <a href="/games" class="menu-link">
    GAMES
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><rect x="2" y="6" width="20" height="12" rx="2"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/></svg>
  </a>

  <a href="/events" class="menu-link">
    EVENTS
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
  </a>

  <a href="/profile" class="menu-link">
    PROFILE
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
  </a>

  <a href="/settings" class="menu-link">
    SETTINGS
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1Z"/></svg>
  </a>
</div>
<div class="profile-panel" id="profilePanel" style="position:fixed; right:0; top:0; height:100%; width:100%; max-width:420px; background:#000; color:#fff; z-index:10000; display:flex; flex-direction:column; border-left:1px solid #333;">
  
  <div class="panel-header" style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #222; flex-shrink:0;">
    <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="profile-logo" style="height:40px; object-fit:contain;">
    <button class="close-btn" id="closeProfile" style="background:none; border:none; color:#fff; cursor:pointer; font-weight:bold;">Close</button>
  </div>

  <div class="panel-main-scroll" style="flex:1; overflow-y:auto; padding:20px;">
    
    <div class="panel-top" style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-bottom:20px;">
      <div id="panelProfilePic" style="width:80px; height:80px; border-radius:50%; background:#222; overflow:hidden; border:2px solid #333; background-size:cover; background-position:center; background-repeat:no-repeat;"></div>
      <div id="authBtnContainer" style="margin-top: 10px; width: 30%;">
  <button id="authActionBtn" style="width: 100%; padding: 10px; border-radius: 12px; font-weight: 900; border: none; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;">
    Loading...
  </button>
</div>
      <div id="userInfo" style="text-align:center; font-weight:bold;"></div>
      
      <div class="spinner" id="uploadSpinner" style="display:none;"></div>
      <input type="file" id="profileInput" accept="image/*" style="display:none;">

      <div id="handleContainer" style="display:flex; flex-direction:column; align-items:center; gap:8px; width:100%;">
        <input type="text" id="handleInput" placeholder="Username / Handle" 
               style="padding:8px 12px; border-radius:12px; border:1px solid #333; background:#222; color:#fff; text-align:center; font-size:14px; width:80%;">
        <button id="saveHandleBtn" style="background:#fff; color:#000; border:none; padding:6px 12px; border-radius:8px; font-weight:bold; cursor:pointer;">Save Handle</button>
        <span id="handleStatus" style="font-size:12px; color:#ccc;"></span>
      </div>

      <div id="copyLinkContainer" style="display:flex; gap:5px; width:100%; margin-top:10px;">
        <input type="text" id="userLink" readonly style="flex:1; background:#111; border:1px solid #333; color:#aaa; padding:8px; border-radius:8px; font-size:12px;">
        <button id="copyLinkBtn" style="background:#333; color:#fff; border:none; padding:8px; border-radius:8px; cursor:pointer;">Copy</button>
      </div>
      <span id="copyStatus" style="font-size:11px;"></span>
    </div>

    <div class="profile-stats" style="display:flex; justify-content:space-around; width:100%; margin-bottom:25px; background:#111; padding:15px 0; border-radius:15px;">
      <div style="text-align:center;">
        <span style="font-weight:bold; font-size:18px; display:block;" id="statPosts">0</span>
        <p style="font-size:12px; color:#aaa; margin:0;">Posts</p>
      </div>
      <div style="text-align:center;">
        <span style="font-weight:bold; font-size:18px; display:block;" id="statFollowers">0</span>
        <p style="font-size:12px; color:#aaa; margin:0;">Followers</p>
      </div>
      <div style="text-align:center;">
        <span style="font-weight:bold; font-size:18px; display:block;" id="statFollowing">0</span>
        <p style="font-size:12px; color:#aaa; margin:0;">Following</p>
      </div>
    </div>

    <div style="width:100%; background:#1a1a1a; padding:15px; border-radius:15px; margin-bottom:20px;">
      <h3 style="margin:0 0 8px 0; font-size:14px; color:#fff; text-transform:uppercase; letter-spacing:1px;">About Me</h3>
      <textarea id="userBioTextarea" maxlength="100" placeholder="Write something about yourself..." 
                style="width:100%; height:80px; background:#222; color:#ccc; border:none; padding:10px; border-radius:10px; resize:none; font-size:14px; outline:none;"></textarea>
      <div id="bioCharCount" style="text-align:right; font-size:12px; color:#777; margin-top:4px;">0 / 100</div>
      
      <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
        <button id="saveProfileBtn" style="padding:10px 15px; border-radius:10px; border:none; background:#2196F3; color:#fff; font-weight:bold; cursor:pointer;">Save Profile</button>
        <div class="spinner" id="saveProfileSpinner" style="width:18px; height:18px; border:2px solid #333; border-top:2px solid #fff; border-radius:50%; animation:spin 1s linear infinite; display:none;"></div>
        <span id="saveProfileStatus" style="font-size:12px; color:#4caf50;"></span>
      </div>
    </div>

    <div style="border-top: 1px solid #222; padding-top: 20px;">
      <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
        <button onclick="showSocialTab('followers')" id="tabFollowers" style="background:none; border:none; color:#2196F3; font-weight:900; cursor:pointer; font-size:12px; border-bottom: 2px solid #2196F3; padding-bottom:5px;">FOLLOWERS</button>
        <button onclick="showSocialTab('following')" id="tabFollowing" style="background:none; border:none; color:#555; font-weight:900; cursor:pointer; font-size:12px; padding-bottom:5px;">FOLLOWING</button>
      </div>
      <div id="socialList" style="display:flex; flex-direction:column; gap:12px;"></div>
    </div>
  </div>
</div>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  .panel-main-scroll::-webkit-scrollbar { width: 4px; }
  .panel-main-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
  
  /* This ensures that any image set via JS as a background fits perfectly */
  #panelProfilePic {
    background-size: cover !important;
    background-position: center !important;
  }
</style>

<main style="padding:12px; background:#121212; font-family: sans-serif;">

  <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; font-weight:bold; color:white; font-size:14px; letter-spacing:0.5px;">
    <img width="20" height="20" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified"/>
    FEATURED PROFILES
    <img width="20" height="20" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified"/>
  </div>

  <div id="userContainer" style="display:flex; overflow-x:auto; gap:12px; padding:8px 0; scrollbar-width:none; margin-bottom:20px;"></div>

  <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; font-weight:bold; color:white; font-size:14px; letter-spacing:0.5px;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
    POLLS
  </div>
  
  <div class="status-msg" id="statusMsg"></div>  
  <div class="poll-feed-container" id="pollFeed"></div>  
  <div class="spinner" id="spinner"></div>  
  
  <div class="confirm-popup" id="confirmPopup">  
    <div class="popup-content">  
      <p id="confirmText">Are you sure you want to delete this poll?</p>  
      <button class="confirm" id="confirmYes">Yes</button>  
      <button class="cancel" id="confirmNo">Cancel</button>  
    </div>  
  </div>

  <hr style="border: 0; height: 1px; background: #333; margin: 20px 0;">

  <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:12px; font-weight:bold; color:white; font-size:14px; letter-spacing:0.5px;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
    FEED
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
  </div>


<div id="toast-container"></div>
<div id="feed"></div>
<div id="end-msg">üõë YOU'VE REACHED THE END OF THE UNIVERSE</div>
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="fullImageModal" onclick="this.style.display='none'">
    <button style="position:absolute; top:40px; left:20px; background:var(--accent); color:white; border:none; padding:12px; border-radius:12px; font-weight:900;">‚Üê BACK</button>
    <img id="fullImgSrc" src="">
</div>

<div class="modal" id="detailsModal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="detTitle" style="margin:0; font-weight: 900; color:var(--accent);"></h2>
        <button id="repBtnMain" class="btn-action" style="min-width:70px; height:30px; background:var(--red); border-bottom-color:#b30000;">REPORT</button>
    </div>
    <div id="detCategory" style="color: var(--text-dim); font-size: 11px; font-weight: 900; margin-bottom: 10px;"></div>
    <div id="detStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    <div id="detDesc" style="background: #1c1c1e; padding: 20px; border-radius: 20px; margin-top: 20px; line-height: 1.6; color: #ddd; flex-grow: 1; overflow-y: auto; border: 1px solid var(--border);"></div>
</div>

<div class="modal" id="commentModal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">Comments</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; color:var(--text-dim); font-weight:900;">CLOSE</button>
    </div>
    <div id="commentList" style="flex-grow:1; overflow-y:auto;"></div>
    <div style="display:flex; gap:10px; padding-top:15px; border-top:1px solid var(--border);">
        <input type="text" id="cInput" placeholder="Write message..." style="flex-grow:1; background:#222; border:none; padding:15px; border-radius:15px; color:white;">
        <button onclick="sendComment()" class="btn-action" style="min-width:80px;">SEND</button>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, push, update, runTransaction, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* ================= CONFIG & INITIALIZATION ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
/* ================= GLOBAL MASTER FOLLOW ================= */
window.doFollow = async (uid) => {
    // Basic Guards
    if (!auth || !auth.currentUser) return notify("Login required", "error");
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted", "error");
    if (auth.currentUser.uid === uid) return;

    // Find all instances of this button (Feed, Comments, and Profile)
    const btns = document.querySelectorAll(`.follow-btn-${uid}`);
    
    // Set all to loading
    btns.forEach(b => { 
        b.disabled = true; 
        b.innerText = '...'; 
    });

    const followerRef = ref(db, `users/${uid}/followers/${auth.currentUser.uid}`);
    const followingRef = ref(db, `following/${auth.currentUser.uid}/${uid}`);
    
    try {
        const snap = await get(followerRef);
        const alreadyFollowing = snap.exists();

        if (!alreadyFollowing) {
            await set(followerRef, true);
            await set(followingRef, true);
        } else {
            await remove(followerRef);
            await remove(followingRef);
        }
        
        // Final UI Sync
        const newState = !alreadyFollowing;
        btns.forEach(btn => {
            btn.disabled = false;
            btn.classList.toggle('following', newState);
            btn.innerText = newState ? 'FOLLOWING' : 'FOLLOW';
            // Force color styles for dynamic modal buttons
            btn.style.background = newState ? "#4caf50" : "var(--accent)";
            btn.style.color = newState ? "#000" : "#fff";
        });

        // Update the stats numbers in the profile panel if it's open
        if (typeof refreshStats === "function") refreshStats();
        
    } catch(e) { 
        console.error("Follow error:", e);
        btns.forEach(b => { b.disabled = false; b.innerText = 'RETRY'; });
    }
};

/* ================= STATE & FEED VARIABLES ================= */
let currentUser = null;
let allPostIds = [];
let displayedCount = 0;
const batchSize = 5;
let currentActiveId = null;
let deletePollId = null;

/* ================= ELEMENTS ================= */
const hamburger = document.getElementById('hamburger');
const menuOverlay = document.getElementById('menuOverlay');
const headerProfile = document.getElementById('headerProfile');
const profilePanel = document.getElementById('profilePanel');
const closeProfile = document.getElementById('closeProfile');
const panelProfilePic = document.getElementById('panelProfilePic');
const userInfo = document.getElementById('userInfo');
const userLinkInput = document.getElementById('userLink');
const copyBtn = document.getElementById('copyLinkBtn');
const copyStatus = document.getElementById('copyStatus');
const uploadSpinner = document.getElementById('uploadSpinner');
const profileInput = document.getElementById('profileInput');
const userBioTextarea = document.getElementById('userBioTextarea');
const bioCharCount = document.getElementById('bioCharCount');
const statPosts = document.getElementById('statPosts');
const statFollowers = document.getElementById('statFollowers');
const statFollowing = document.getElementById('statFollowing');
const handleInput = document.getElementById('handleInput');
const saveHandleBtn = document.getElementById('saveHandleBtn');
const handleStatus = document.getElementById('handleStatus');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const saveProfileSpinner = document.getElementById('saveProfileSpinner');
const saveProfileStatus = document.getElementById('saveProfileStatus');
const featuredContainer = document.getElementById("userContainer");
const pollFeed = document.getElementById('pollFeed');
const spinner = document.getElementById('spinner');
const statusMsg = document.getElementById('statusMsg');
const confirmPopup = document.getElementById('confirmPopup');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

/* ================= UTILS ================= */
function notify(elOrMsg, msgOrType = 'success', ok = true, t = 3000) {
    if (typeof elOrMsg === 'string') {
        const container = document.getElementById('toast-container');
        if (container) {
            const toast = document.createElement('div');
            toast.className = `toast ${msgOrType}`;
            toast.innerText = elOrMsg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), t);
            return;
        }
    }
    const el = elOrMsg;
    const msg = msgOrType;
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? '#4caf50' : '#f44336';
    setTimeout(() => el.textContent = '', t);
}

function showStatus(msg, type = 'success') { notify(statusMsg, msg, type === 'success'); }
function randomColor() { return `hsl(${Math.random() * 360},80%,60%)`; }
function count(val) { if (!val) return 0; if (typeof val === 'number') return val; if (typeof val === 'object') return Object.keys(val).length; return 0; }
function createSpinner() { const s = document.createElement('div'); s.style.cssText = `width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;`; return s; }
function timeAgo(ts) { const now = Date.now(); const diff = now - ts; const sec = Math.floor(diff / 1000), min = Math.floor(sec / 60), hr = Math.floor(min / 60), day = Math.floor(hr / 24); if (day > 0) return `${day} day${day > 1 ? 's' : ''} ago`; if (hr > 0) return `${hr} hour${hr > 1 ? 's' : ''} ago`; if (min > 0) return `${min} min${min > 1 ? 's' : ''} ago`; return 'just now'; }
function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

/* ================= RATE LIMIT & STAT HELPERS ================= */
async function checkWeeklyLimit(type) {
    if (!currentUser) return null;
    const historyRef = ref(db, `users/${currentUser.uid}/updateHistory/${type}`);
    const snap = await get(historyRef);
    const now = Date.now();
    const oneWeek = 7 * 24 * 60 * 60 * 1000;
    
    // Filter history to last 7 days
    const recentChanges = (snap.val() || []).filter(ts => (now - ts) < oneWeek);
    
    if (recentChanges.length >= 2) return null; 
    return [...recentChanges, now]; 
}

async function refreshStats() {
    if (!currentUser) return;
    const snap = await get(ref(db, `users/${currentUser.uid}`));
    const data = snap.val() || {};
    if (statPosts) statPosts.textContent = count(data.posts);
    if (statFollowers) statFollowers.textContent = count(data.followers);
    
    // For "Following", we check the dedicated path
    const followSnap = await get(ref(db, `following/${currentUser.uid}`));
    if (statFollowing) statFollowing.textContent = count(followSnap.val());
}

/* ================= PROFILE ACTIONS ================= */
hamburger?.addEventListener('click', () => { hamburger.classList.toggle('active'); menuOverlay.classList.toggle('active'); });
headerProfile?.addEventListener('click', () => { profilePanel.classList.add('active'); document.body.style.overflow = 'hidden'; });
closeProfile?.addEventListener('click', () => { profilePanel.classList.remove('active'); document.body.style.overflow = 'auto'; });
copyBtn?.addEventListener('click', () => { if (!userLinkInput.value || userLinkInput.value.includes('Login')) return; navigator.clipboard.writeText(userLinkInput.value); notify(copyStatus, 'Copied'); });

// Handle Input: Enforce 12-character limit
handleInput?.addEventListener('input', () => {
    if (handleInput.value.length > 12) {
        handleInput.value = handleInput.value.substring(0, 12);
        notify(handleStatus, 'Max 12 characters', false);
    }
});

// Profile Picture Upload
panelProfilePic?.addEventListener('click', () => profileInput.click());
profileInput?.addEventListener('change', async () => {
    if (!profileInput.files[0] || !currentUser) return;

    const newHistory = await checkWeeklyLimit('profilePic');
    if (!newHistory) return notify(saveProfileStatus, 'Limit: 2 changes per week', false);

    uploadSpinner.style.display = 'block';
    const formData = new FormData();
    formData.append('image', profileInput.files[0]);

    try {
        const res = await fetch('https://api.imgur.com/3/image', { 
            method: 'POST', 
            headers: { Authorization: 'Client-ID 891e5bb4aa94282' }, 
            body: formData 
        });
        const data = await res.json();
        
        if (data.success) {
            const updates = {};
            updates[`users/${currentUser.uid}/profilePic`] = data.data.link;
            updates[`users/${currentUser.uid}/updateHistory/profilePic`] = newHistory;
            
            await update(ref(db), updates);
            panelProfilePic.style.backgroundImage = `url(${data.data.link})`;
            headerProfile.style.backgroundImage = `url(${data.data.link})`;
            notify(saveProfileStatus, 'Profile picture updated!');
        } else {
            notify(saveProfileStatus, 'Upload failed!', false);
        }
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Upload error!', false);
    }
    uploadSpinner.style.display = 'none';
});

// Consolidated Profile Save
saveProfileBtn?.addEventListener('click', async () => {
    if (!currentUser) return;

    const h = handleInput.value.trim();
    const b = userBioTextarea.value;

    if (h.length < 3) return notify(saveProfileStatus, 'Handle too short', false);
    if (h.length > 12) return notify(saveProfileStatus, 'Handle max 12 chars', false);

    saveProfileSpinner.style.display = 'block';

    try {
        const newHistory = await checkWeeklyLimit('profileInfo');
        if (!newHistory) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Limit: 2 changes per week', false);
        }

        const allSnap = await get(ref(db, 'users'));
        const allUsers = allSnap.val() || {};
        const taken = Object.entries(allUsers).some(([uid, u]) => 
            u.handle?.toLowerCase() === h.toLowerCase() && uid !== currentUser.uid
        );

        if (taken) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Handle already taken!', false);
        }

        const updates = {};
        updates[`users/${currentUser.uid}/handle`] = h;
        updates[`users/${currentUser.uid}/bio`] = b;
        updates[`users/${currentUser.uid}/updateHistory/profileInfo`] = newHistory;

        await update(ref(db), updates);
        await refreshStats();
        notify(saveProfileStatus, 'Profile saved!');
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Save error!', false);
    }
    saveProfileSpinner.style.display = 'none';
});

saveHandleBtn?.addEventListener('click', () => saveProfileBtn.click());

/* ================= FEATURED USERS & POLLS ================= */
async function loadFeaturedUsers() {
    if (!featuredContainer) return;
    try {
        const snap = await get(ref(db, 'users'));
        if (!snap.exists()) { featuredContainer.innerHTML = "<p style='color:#888;'>No users found.</p>"; return; }
        let allUsers = Object.entries(snap.val());
        allUsers.sort(() => 0.5 - Math.random());
        const featured10 = allUsers.slice(0, 10);
        featuredContainer.innerHTML = '';
        let myFollowing = new Set();
        if (currentUser) {
            const fSnap = await get(ref(db, `following/${currentUser.uid}`));
            if (fSnap.exists()) myFollowing = new Set(Object.keys(fSnap.val()));
        }
        featured10.forEach(([uid, user]) => {
            const div = document.createElement('div');
            div.style.cssText = "flex:0 0 auto; width:70px; display:flex; flex-direction:column; align-items:center;";
            const imgWrapper = document.createElement('div');
            imgWrapper.style.cssText = `width:60px;height:60px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid #fff;transition:border-color 1s;`;
            const img = document.createElement('img');
            img.src = user.profilePic || 'https://via.placeholder.com/60?text=?';
            img.style.cssText = "width:100%;height:100%;object-fit:cover;";
            imgWrapper.appendChild(img); div.appendChild(imgWrapper);
            setInterval(() => { imgWrapper.style.borderColor = randomColor(); }, 1000);
            const handleDiv = document.createElement('div');
            handleDiv.textContent = '@' + (user.handle || 'user');
            handleDiv.style.cssText = "max-width:70px;font-size:10px;color:#fff;margin-top:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
            div.appendChild(handleDiv);
            const followerDiv = document.createElement('div');
            followerDiv.style.cssText = "font-size:9px;color:#bbb;text-align:center;margin-top:2px;";
            div.appendChild(followerDiv);
            const button = document.createElement('button');
            button.style.cssText = "margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;background:#2e89ff;color:#fff;cursor:pointer;text-align:center;";
            div.appendChild(button);
            const msg = document.createElement('span');
            msg.style.cssText = "color:#ff6b6b;font-size:10px;margin-top:2px;display:none;text-align:center;";
            div.appendChild(msg);

            async function updateButton() {
                const fSnap = await get(ref(db, `users/${uid}/followers`));
                followerDiv.textContent = count(fSnap.val()) + ' followers';
                if (!currentUser) { button.textContent = 'Follow'; button.style.background = '#2e89ff'; return; }
                const isFollowing = myFollowing.has(uid);
                button.textContent = isFollowing ? 'Following' : 'Follow';
                button.style.background = isFollowing ? '#4caf50' : '#2e89ff';
            }
            updateButton();

            button.addEventListener('click', async () => {
                if (!currentUser) { msg.textContent = "Only logged in users can follow"; msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); return; }
                const spinnerIcon = createSpinner(); button.innerHTML = ''; button.appendChild(spinnerIcon); button.disabled = true;
                const path = ref(db, `following/${currentUser.uid}/${uid}`);
                const snapF = await get(path);
                if (!snapF.exists()) {
                    await set(path, true);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => (c || 0) + 1);
                    myFollowing.add(uid);
                } else {
                    await set(path, null);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => Math.max((c || 0) - 1, 0));
                    myFollowing.delete(uid);
                }
                if (statFollowing) statFollowing.textContent = myFollowing.size;
                updateButton(); button.disabled = false;
            });
            featuredContainer.appendChild(div);
        });
    } catch (e) { console.error(e); }
}
/* ================= POLL STATE FOR LAZY LOADING ================= */
let allPollData = [];
let pollsDisplayed = 0;
const pollBatchSize = 3;
let isLoadingPolls = false;

async function loadPolls() {
    if (!pollFeed || isLoadingPolls) return;
    isLoadingPolls = true;
    if (spinner) spinner.style.display = 'block';
    
    try {
        const snap = await get(ref(db, '/poll'));
        if (!snap.exists()) {
            pollFeed.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.5;">No polls found.</div>';
            return;
        }
        
        allPollData = shuffleArray(Object.entries(snap.val()));
        pollFeed.innerHTML = '';
        pollsDisplayed = 0;

        await renderPollBatch();

        window.onscroll = () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                renderPollBatch();
            }
        };
    } catch (e) { 
        console.error(e); 
        showStatus('Error loading polls', 'error'); 
    } finally { 
        if (spinner) spinner.style.display = 'none'; 
        isLoadingPolls = false;
    }
}

async function renderPollBatch() {
    if (pollsDisplayed >= allPollData.length) return;
    const batch = allPollData.slice(pollsDisplayed, pollsDisplayed + pollBatchSize);
    
    let following = [];
    if (currentUser) {
        const followingSnap = await get(ref(db, `/following/${currentUser.uid}`));
        if (followingSnap.exists()) following = Object.keys(followingSnap.val());
    }

    batch.forEach(([id, data]) => renderPoll(id, data, following));
    pollsDisplayed += pollBatchSize;
}

async function renderPoll(pollId, data, following = []) {
    const card = document.createElement('div'); card.className = 'poll-card'; card.dataset.uid = data.uid;
    
    // --- Author Section ---
    const authorSection = document.createElement('div'); authorSection.className = 'poll-author';
    const authorLeft = document.createElement('div'); authorLeft.className = 'author-left';
    const profileImg = document.createElement('img'); profileImg.src = 'default-avatar.png';
    const authorHandle = document.createElement('span'); authorHandle.textContent = '@user';
    authorLeft.append(profileImg, authorHandle); authorSection.append(authorLeft);

    const actionBtn = document.createElement('button');
    if (currentUser?.uid === data.uid) {
        actionBtn.className = 'delete-btn'; actionBtn.textContent = 'Delete';
        actionBtn.onclick = () => { window.deletePollId = pollId; confirmPopup.style.display = 'flex'; };
    } else {
        actionBtn.className = 'follow-btn';
        const isFollowing = following.includes(data.uid);
        actionBtn.textContent = isFollowing ? 'Following' : 'Follow';
        if (isFollowing) actionBtn.classList.add('following');
        
        actionBtn.onclick = async () => {
            if (!currentUser) return showStatus('Login required', 'error');
            actionBtn.disabled = true;
            const followRef = ref(db, `/users/${data.uid}/followers/${currentUser.uid}`);
            const followingRef = ref(db, `/following/${currentUser.uid}/${data.uid}`);
            const snap = await get(followRef);
            let state = !snap.exists();

            try {
                if (state) { 
                    await update(followRef, { timestamp: Date.now() }); 
                    await update(followingRef, { timestamp: Date.now() }); 
                } else { 
                    await remove(followRef); 
                    await remove(followingRef); 
                }
                document.querySelectorAll(`.poll-card[data-uid="${data.uid}"] .follow-btn`).forEach(btn => {
                    btn.textContent = state ? 'Following' : 'Follow';
                    btn.classList.toggle('following', state);
                    btn.disabled = false;
                });
            } catch (err) { actionBtn.disabled = false; }
        };
    }
    authorSection.append(actionBtn); card.appendChild(authorSection);

    get(ref(db, `/users/${data.uid}`)).then(uSnap => {
        const u = uSnap.val() || {}; 
        profileImg.src = u.profilePic || 'default-avatar.png'; 
        authorHandle.textContent = '@' + (u.handle || 'user');
        if (u.followers && Object.keys(u.followers).length >= 1000) {
            const badge = document.createElement('img'); 
            badge.src = 'https://img.icons8.com/stickers/100/verified-badge.png';
            badge.className = 'verified-badge'; badge.style.cssText = 'width:14px;height:14px;margin-left:4px;'; 
            authorHandle.appendChild(badge);
        }
    });

    const title = document.createElement('h2'); title.textContent = data.question; card.appendChild(title);

    // --- Header Stats ---
    const statsHeader = document.createElement('div');
    statsHeader.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;';
    const counter = document.createElement('div');
    counter.className = 'comment-counter'; counter.style.fontSize = '12px'; counter.textContent = 'Comments: 0';
    const viewCommentsBtn = document.createElement('button');
    viewCommentsBtn.textContent = 'VIEW COMMENTS';
    viewCommentsBtn.style.cssText = 'background:var(--accent); color:black; border:none; padding:4px 10px; border-radius:6px; font-weight:900; font-size:10px; cursor:pointer;';
    viewCommentsBtn.onclick = () => window.openComments(pollId, 'poll'); 
    statsHeader.append(counter, viewCommentsBtn);
    card.appendChild(statsHeader);

    // --- Votes Section ---
    const ul = document.createElement('ul'); card.appendChild(ul);
    data.options.forEach((opt, idx) => {
        const li = document.createElement('li'); 
        li.innerHTML = `<div class="vote-bar"></div><div class="vote-label"><span>${opt}</span><span>0 votes</span></div>`;
        ul.appendChild(li);
        li.onclick = async () => {
            if (!currentUser) return showStatus('Login required', 'error');
            const userVoteRef = ref(db, `/pollVotes/${pollId}/${currentUser.uid}`);
            const votedSnap = await get(userVoteRef);
            if (votedSnap.exists()) return showStatus('Already voted', 'error');
            await runTransaction(ref(db, `/poll/${pollId}/votes/${idx}`), v => (v || 0) + 1);
            await update(userVoteRef, { option: idx });
        };
    });

    onValue(ref(db, `/poll/${pollId}/votes`), snap => {
        const votes = snap.val() || {}; const total = Object.values(votes).reduce((a, b) => a + b, 0) || 1;
        card.querySelectorAll('li').forEach((li, i) => {
            const c = votes[i] || 0; const p = Math.round((c / total) * 100);
            li.querySelector('.vote-bar').style.width = p + '%';
            li.querySelector('.vote-label span:last-child').textContent = `${c} votes (${p}%)`;
        });
    });

    // --- CORRECTED Inline Comment List (With Profile/Handle) ---
    const list = document.createElement('div'); 
    list.className = 'comments-list'; 
    list.style.cssText = 'height:100px; overflow-y:auto; border-top:1px solid #222; margin-top:5px; padding:5px 0;';
    card.appendChild(list);

    onValue(ref(db, `/pollComments/${pollId}`), async snap => {
        const comments = snap.val() || {}; list.innerHTML = '';
        const sorted = Object.entries(comments).sort((a, b) => a[1].timestamp - b[1].timestamp);
        counter.textContent = `Comments: ${sorted.length}`;
        
        for (const [key, c] of sorted) {
            // Fetch commenter details in real-time
            const userSnap = await get(ref(db, `/users/${c.uid}`));
            const u = userSnap.val() || {};
            const div = document.createElement('div');
            div.style.cssText = 'font-size:11px; margin-bottom:4px; display:flex; align-items:center; gap:5px;';
            div.innerHTML = `<img src="${u.profilePic || 'default-avatar.png'}" style="width:18px;height:18px;border-radius:50%; object-fit:cover;"> 
                            <span><strong>@${u.handle || 'user'}</strong>: ${c.text}</span>`;
            list.appendChild(div);
        }
        list.scrollTop = list.scrollHeight;
    });

    // --- Action Footer (Corrected Report/Share) ---
    const actions = document.createElement('div');
    actions.style.cssText = 'display:flex; gap:10px; margin-top:10px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1);';
    const btnStyle = 'flex:1; background:rgba(255,255,255,0.05); color:#fff; border:1px solid #333; padding:8px; border-radius:10px; font-size:11px; font-weight:900; cursor:pointer;';
    
const shareBtn = document.createElement('button');
shareBtn.innerHTML = 'üîó SHARE'; 
shareBtn.style.cssText = btnStyle;

shareBtn.onclick = async () => {
    // UPDATED: Now forces the redirect to the /poll/ directory
    const url = `${window.location.origin}/poll/?id=${pollId}`;
    
    try {
        if (navigator.share) {
            await navigator.share({ 
                title: 'Check out this Poll!', 
                text: data.question, 
                url: url 
            });
        } else {
            throw new Error('Share API not supported'); 
        }
    } catch (err) {
        navigator.clipboard.writeText(url).then(() => {
            if (typeof showStatus === 'function') {
                showStatus('Link Copied to Clipboard!', 'success');
            } else {
                alert('Link Copied!');
            }
        });
    }
};


    const reportBtn = document.createElement('button');
    reportBtn.innerHTML = 'üö© REPORT'; 
    reportBtn.style.cssText = btnStyle + 'background:rgba(255,75,75,0.1); color:#FF4B4B; border-color:rgba(255,75,75,0.2);';
    reportBtn.onclick = () => {
        // Updated to use the variable your app uses for identifying the item to report
        if (typeof window.submitReport === 'function') {
            window.submitReport(pollId, 'poll');
        } else {
            // Fallback if the function is named differently
            console.error("Report function not found.");
        }
    };

    actions.append(shareBtn, reportBtn);
    card.appendChild(actions);

    // --- Footer Metadata ---
    const footer = document.createElement('div'); footer.style.cssText = 'display:flex;justify-content:space-between;font-size:10px;opacity:0.5;margin-top:10px;';
    const timeSpan = document.createElement('span'); timeSpan.textContent = timeAgo(data.timestamp || Date.now());
    const viewsSpan = document.createElement('span'); viewsSpan.textContent = 'Views: 0';
    footer.append(timeSpan, viewsSpan); card.appendChild(footer);
    
    runTransaction(ref(db, `/pollViews/${pollId}`), v => (v || 0) + 1).then(tx => { 
        viewsSpan.textContent = `Views: ${tx.snapshot.val()}`; 
    });

    pollFeed.appendChild(card);
}



/* ================= FEED (POSTS) LOGIC ================= */
/* ================= FEED (POSTS) LOGIC ================= */
async function startUniverse() {
    const snap = await get(ref(db, 'post'));
    if (!snap.exists()) return;
    // Shuffle posts and reset feed
    allPostIds = Object.entries(snap.val()).sort(() => Math.random() - 0.5);
    const feed = document.getElementById('feed'); 
    if (feed) feed.innerHTML = '';
    displayedCount = 0; 
    renderBatch();
}

function renderBatch() {
    const feed = document.getElementById('feed'); 
    if (!feed) return;
    
    if (displayedCount >= allPostIds.length) { 
        document.getElementById('end-msg').style.display = 'block'; 
        return; 
    }
    
    const batch = allPostIds.slice(displayedCount, displayedCount + batchSize);
    
    batch.forEach(([id, post]) => {
        const card = document.createElement('div'); 
        card.className = 'card'; 
        feed.appendChild(card);

        runTransaction(ref(db, `post/${id}/views`), v => (v || 0) + 1);

        onValue(ref(db, `post/${id}`), (pSnap) => {
            const p = pSnap.val(); 
            if (!p) return;
            
            onValue(ref(db, `users/${p.uid}`), (uSnap) => {
                const u = uSnap.val() || {}; 
                const fc = count(u.followers); 
                const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];

                // --- SLIDESHOW TITLE LOGIC ---
                // If title > 20 chars, make it scroll. Otherwise, keep it static.
                const titleHTML = p.title.length > 20 
                    ? `<div class="title-scroll-wrap"><div class="scrolling-text">${p.title} &nbsp;&nbsp;&nbsp; ${p.title} &nbsp;&nbsp;&nbsp;</div></div>`
                    : p.title;

                // --- UPDATED MONETIZATION UI ---
                const sponsoredSection = p.sponsored ? `
                  <div style="margin-top: 15px; text-align: center;">
                    <button onclick="window.open('${p.link}', '_blank')" 
                            style="width:100%; padding:14px; border:none; border-radius:12px; 
                            background:#fff; color:#000; font-weight:900; font-size:14px; 
                            cursor:pointer; text-transform:uppercase; letter-spacing:0.5px;
                            display:flex; align-items:center; justify-content:center; gap:8px;">
                      <svg viewBox="0 0 24 24" width="18" height="18" fill="black"><path d="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z"/></svg>
                      VISIT SPONSORED
                    </button>
                    <div style="color:#00E052; font-size:10px; font-weight:800; margin-top:8px; text-transform:uppercase; letter-spacing:0.3px; line-height:1.4;">
                      By clicking, you are supporting this creator.<br>
                      <span style="color:#ff453a;">The creator monetized this post.</span>
                    </div>
                  </div>
                ` : '';

                card.innerHTML = `
                <div class="header">
                  <img src="${u.profilePic || ''}" class="avatar" onclick="window.location.href='/profile?user=${p.uid}'">
                  <div style="flex-grow:1; cursor:pointer;" onclick="window.location.href='/profile?user=${p.uid}'">
                    <div style="font-weight:900; display:flex; align-items:center; gap:4px;">@${u.handle || 'user'} ${fc >= 1000 ? '‚úÖ' : ''}</div>
                    <div style="font-size:10px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                  </div>
                  <button class="btn-action follow-btn-${p.uid} ${isF ? 'following' : ''}" onclick="doFollow('${p.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                </div>
                <div style="position:relative;">
                   <img src="${p.image}" class="post-img" onclick="viewFull('${p.image}')" ondblclick="doLike('${id}')">
                   ${p.sponsored ? '<span style="position:absolute; top:10px; right:10px; background:rgba(0,191,255,0.9); padding:4px 8px; border-radius:6px; font-size:9px; font-weight:900; color:#000; text-transform:uppercase;">Monetized</span>' : ''}
                </div>
                <div class="glass-title-row">
                    <h3 style="margin:0; font-size:17px; font-weight:900; color:white;">${titleHTML}</h3>
                </div>
                <div style="padding:0 16px 15px 16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="display:flex; gap:20px;">
                      <div onclick="doLike('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="${(p.likes && auth.currentUser && p.likes[auth.currentUser.uid]) ? 'var(--red)' : 'white'}"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        ${p.likeCount || 0}
                      </div>
                      <div onclick="openComments('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        ${p.comments ? Object.keys(p.comments).length : 0}
                      </div>
                    </div>
                    <span style="font-size:10px; color:var(--text-dim); font-weight:900;">${timeAgo(p.timestamp)}</span>
                  </div>
                  <div style="font-size:10px; color:var(--accent); font-weight:900; margin-bottom:5px;">${p.views || 0} VIEWS ‚Ä¢ ${p.category?.toUpperCase()}</div>
                  <div style="font-size:14px; line-height:1.4;">${p.description ? p.description.substring(0, 70) : ''}... <span style="color:var(--accent); font-weight:900; cursor:pointer;" onclick="openReadMore('${id}')">Read More</span></div>
                  
                  ${sponsoredSection}
                </div>`;
            });
        });
    });
    displayedCount += batchSize;
}




/* ================= UPDATED MODAL VIEW LOGIC ================= */
// We removed the transaction from here so we don't double-count views
window.openReadMore = async (id) => {
    try {
        const snap = await get(ref(db, `post/${id}`));
        const p = snap.val();
        if (!p) return;

        document.getElementById('detTitle').innerText = p.title || "No Title";
        document.getElementById('detCategory').innerText = `CATEGORY: ${(p.category || 'General').toUpperCase()}`;
        document.getElementById('detStats').innerHTML = `
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">üëÅÔ∏è ${p.views || 0} Views</div>
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">‚ù§Ô∏è ${p.likeCount || 0} Likes</div>`;
        document.getElementById('detDesc').innerText = p.description || "";
        
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('detailsModal').classList.add('active');
    } catch(e) { console.error(e); }
};

/* ================= WINDOW GLOBALS & MODAL LOGIC ================= */
let currentModalType = 'post';

window.openComments = (id, type = 'post') => {
    currentActiveId = id;
    currentModalType = type;
    
    const dbPath = type === 'poll' ? `pollComments/${id}` : `post/${id}/comments`;
    const overlay = document.getElementById('overlay');
    const modal = document.getElementById('commentModal');
    
    if (overlay) overlay.style.display = 'block';
    if (modal) modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    const commentRef = ref(db, dbPath);
    onValue(commentRef, async (snap) => {
        const list = document.getElementById('commentList');
        if (!list) return;
        list.innerHTML = "";
        if (!snap.exists()) return;
        
        const entries = Object.entries(snap.val()).sort((a, b) => a[1].timestamp - b[1].timestamp);

        for (const [cid, c] of entries) {
            const uSnap = await get(ref(db, `users/${c.uid}`));
            const u = uSnap.val() || {};
            const fc = count(u.followers);
            const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
            
            let linkUI = "";
            if (c.text.includes("http")) {
                const urlMatch = c.text.match(/\bhttps?:\/\/\S+/gi);
                const url = urlMatch ? urlMatch[0] : "";
                linkUI = `
                    <div style="margin-top:10px; border:1px solid var(--border); border-radius:15px; overflow:hidden;">
                        <span style="font-size:10px; color:var(--red); font-weight:900; background:rgba(255,75,75,0.1); padding:5px; text-align:center; display:block;">‚ö†Ô∏è CLICK AT YOUR OWN RISK</span>
                        <iframe src="${url}" width="100%" height="120px" style="border:none; background:white;"></iframe>
                        <a href="https://otieu.com/4/7950037" target="_blank" style="background:var(--green); display:block; text-align:center; padding:10px; color:black; font-weight:900; text-decoration:none;">VISIT SECURELY</a>
                    </div>`;
            }

            list.innerHTML += `
                <div style="padding:15px 0; border-bottom:1px solid #222;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <img src="${u.profilePic || 'default-avatar.png'}" style="width:35px; height:35px; border-radius:10px; cursor:pointer;" onclick="window.location.href='/profile?user=${c.uid}'">
                        <div style="flex-grow:1;">
                            <div style="font-weight:900; font-size:12px;">@${u.handle || 'user'} <span style="font-size:10px; color:#666; font-weight:400;">‚Ä¢ ${timeAgo(c.timestamp)}</span></div>
                            <div style="font-size:9px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                        </div>
                        <button class="btn-action follow-btn-${c.uid} ${isF ? 'following' : ''}" style="min-width:75px; height:28px; font-size:8px;" onclick="doFollow('${c.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                        <button onclick="submitReport('${cid}', 'comment')" style="background:none; border:none; color:var(--red); font-weight:900; font-size:10px;">REPORT</button>
                    </div>
                    <div style="padding-left:45px; font-size:13px;">${c.text.replace(/\bhttps?:\/\/\S+/gi, '[Link Shared]')}</div>
                    <div style="padding-left:45px;">${linkUI}</div>
                </div>`;
        }
        list.scrollTop = list.scrollHeight;
    });
};

window.sendComment = async () => {
    // BLACKLIST CHECK
    if (window.isBlacklisted) return notify("Action Blocked: Your account is blacklisted.", "error");
    
    const input = document.getElementById('cInput');
    const val = input ? input.value.trim() : "";
    if (!val || !auth.currentUser || !currentActiveId) return;

    const path = currentModalType === 'poll' ? `pollComments/${currentActiveId}` : `post/${currentActiveId}/comments`;
    
    input.disabled = true;
    try {
        await push(ref(db, path), { uid: auth.currentUser.uid, text: val, timestamp: Date.now() });
        input.value = "";
    } catch(e) { console.error(e); }
    input.disabled = false;
    input.focus();
};

window.doLike = (id) => {
    if (!auth.currentUser) return notify("Login required", "error");
    // BLACKLIST CHECK
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted users cannot like.", "error");

    runTransaction(ref(db, `post/${id}`), (p) => {
        if (p) {
            p.likes = p.likes || {};
            if (p.likes[auth.currentUser.uid]) {
                delete p.likes[auth.currentUser.uid];
                p.likeCount = Math.max(0, (p.likeCount || 1) - 1);
            } else {
                p.likes[auth.currentUser.uid] = true;
                p.likeCount = (p.likeCount || 0) + 1;
            }
        }
        return p;
    });
};

window.openReadMore = async (id) => {
    try {
        const snap = await get(ref(db, `post/${id}`));
        const p = snap.val();
        if (!p) return;

        // Generate the unique link
        const shareURL = `${window.location.origin}/post?id=${id}`;

        document.getElementById('detTitle').innerText = p.title || "No Title";
        document.getElementById('detCategory').innerText = `CATEGORY: ${(p.category || 'General').toUpperCase()}`;
        document.getElementById('detStats').innerHTML = `
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">üëÅÔ∏è ${p.views || 0} Views</div>
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">‚ù§Ô∏è ${p.likeCount || 0} Likes</div>`;
        
        // Added the Share Section here
        document.getElementById('detDesc').innerHTML = `
            <div>${p.description || ""}</div>
            
            <div class="share-container">
                <div class="share-label">Share with friends</div>
                <div class="share-link-row">
                    <input type="text" class="share-input" value="${shareURL}" id="shareInput-${id}" readonly>
                    <button class="btn-copy" onclick="window.copyPostLink('${id}')">COPY</button>
                </div>
            </div>
        `;
        
        const repBtn = document.getElementById('repBtnMain');
        if (repBtn) {
            repBtn.onclick = () => window.submitReport(id, 'post');
        }
        
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('detailsModal').classList.add('active');
    } catch(e) { console.error("Error opening details:", e); }
};


window.submitReport = async (tid, type) => {
    if(!auth.currentUser) return notify("Login required", "error");
    // BLACKLIST CHECK
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted users cannot report.", "error");

    await push(ref(db, 'reports'), { tid, type, reporter: auth.currentUser.uid, time: Date.now() });
    notify("Report submitted", "error");
};

window.viewFull = (src) => { 
    document.getElementById('fullImgSrc').src = src; 
    document.getElementById('fullImageModal').style.display = 'flex'; 
};

window.closeAllModals = () => {
    document.getElementById('overlay').style.display = 'none';
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    document.getElementById('fullImageModal').style.display = 'none';
    document.body.style.overflow = 'auto';
};

/* ================= AUTH & INITIAL LOAD ================= */
onAuthStateChanged(auth, async user => {
    // --- LOADING INITIALIZATION ---
    const pctLabel = document.getElementById('load-pct');
    const loader = document.getElementById('ios-loader');
    const authBtn = document.getElementById('authActionBtn'); // Get the button element
    const updatePct = (val) => { if(pctLabel) pctLabel.innerText = val + '%'; };

    // 15-second Rescue Timer (Failsafe)
    const rescueTimer = setTimeout(() => {
        if (loader) {
            updatePct(100);
            loader.style.opacity = '0';
            document.body.style.overflow = 'auto';
            setTimeout(() => loader.remove(), 800);
        }
    }, 15000);

    try {
        updatePct(10); 
        
        currentUser = user || null;

        // --- DYNAMIC LOGIN/LOGOUT BUTTON LOGIC ---
        if (authBtn) {
            if (user) {
                // USER LOGGED IN: SHOW RED LOGOUT
                authBtn.innerText = "Logout";
                authBtn.style.background = "#FF4B4B"; // Red
                authBtn.style.color = "white";
                authBtn.onclick = () => {
                    auth.signOut().then(() => location.reload());
                };
            } else {
                // USER LOGGED OUT: SHOW GREEN LOGIN
                authBtn.innerText = "Login";
                authBtn.style.background = "#00E052"; // Green
                authBtn.style.color = "black";
                authBtn.onclick = () => {
                    window.location.href = '/login'; // Adjust path as needed
                };
            }
        }

        if (user) {
            const uid = user.uid;
            userLinkInput.value = `${location.origin}/profile?uid=${uid}`;
            
            checkUserSecurity(user); 
            updatePct(25);
            
            refreshStats();
            showSocialTab('followers'); 
            
            const snap = await get(ref(db, `users/${uid}`));
            const data = snap.val() || {};
            handleInput.value = data.handle || 'user';
            userBioTextarea.value = data.bio || '';
            
            if (data.profilePic) { 
                headerProfile.style.backgroundImage = `url(${data.profilePic})`; 
                panelProfilePic.style.backgroundImage = `url(${data.profilePic})`; 
            }
            updatePct(45);
        } else {
            userLinkInput.value = 'Login to get link';
            const list = document.getElementById('socialList');
            if(list) list.innerHTML = '';
            window.isBlacklisted = false;
            updatePct(45);
        }

        await loadFeaturedUsers();
        updatePct(65);
        
        await loadPolls();
        updatePct(85);
        
        await startUniverse();
        updatePct(100);

        clearTimeout(rescueTimer);

        setTimeout(() => {
            if (loader) {
                loader.style.opacity = '0';
                document.body.style.overflow = 'auto';
                document.body.style.setProperty('overflow', 'auto', 'important');
                setTimeout(() => loader.remove(), 800);
            }
        }, 3000);

    } catch (error) {
        console.error("Loading Error:", error);
        if (loader) loader.remove();
        document.body.style.overflow = 'auto';
    }
});

// Confirm Popups
confirmNo?.addEventListener('click', () => { confirmPopup.style.display = 'none'; deletePollId = null; });
confirmYes?.addEventListener('click', async () => {
    if (!deletePollId) return;
    await remove(ref(db, `/poll/${deletePollId}`));
    await remove(ref(db, `/pollVotes/${deletePollId}`));
    await remove(ref(db, `/pollComments/${deletePollId}`));
    confirmPopup.style.display = 'none';
    loadPolls();
});

// Scroll Listener
window.onscroll = () => { 
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) {
        renderBatch(); 
        if (typeof renderPollBatch === 'function') renderPollBatch();
    }
};

/* --- STATE FOR SOCIAL LAZY LOAD --- */
let socialUids = [];
let socialDisplayedCount = 0;
const socialBatchSize = 10;
let currentSocialTab = 'followers';

// Helper function to render a single user row
function renderSocialItem(container, uid, userData, btnText) {
    const div = document.createElement('div');
    div.id = `social-row-${uid}`;
    div.style.cssText = "display:flex; align-items:center; gap:12px; background:#1a1a1a; padding:10px; border-radius:15px; margin-bottom:8px;";
    
    const isUnfollow = btnText === 'UNFOLLOW';
    const btnClass = isUnfollow ? 'background:#333; color:#ff4b4b;' : 'background:var(--accent); color:white;';

    div.innerHTML = `
        <img src="${userData.profilePic || 'https://i.imgur.com/cM3Givj.jpeg'}" style="width:40px;height:40px;border-radius:12px;object-fit:cover;cursor:pointer;" onclick="window.location.href='/profile?user=${uid}'">
        <div style="flex:1; overflow:hidden;">
            <div style="font-size:13px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white;">@${userData.handle || 'user'}</div>
            <div style="font-size:10px; color:#666;">${count(userData.followers)} Followers</div>
        </div>
        <button id="socBtn-${uid}" style="border:none; border-radius:10px; padding:6px 12px; font-size:10px; font-weight:900; cursor:pointer; ${btnClass}">
            ${btnText}
        </button>
    `;

    const btn = div.querySelector(`#socBtn-${uid}`);
    btn.onclick = async () => {
        btn.disabled = true;
        btn.innerText = "...";
        
        await window.doFollow(uid); 

        // Fix: Update UI immediately based on tab context
        if (currentSocialTab === 'following') {
            div.remove(); // Remove immediately if unfollowing from following list
            if (container.children.length === 0) {
                container.innerHTML = `<p style="text-align:center; font-size:11px; color:#555; margin-top:20px;">No following yet</p>`;
            }
        } else {
            showSocialTab('followers'); // Refresh labels for followers tab
        }
    };

    container.appendChild(div);
}

/* --- FIXED SOCIAL TAB & GLOBAL FOLLOW SYNC --- */

window.showSocialTab = async (tab) => {
    const list = document.getElementById('socialList');
    const tabR = document.getElementById('tabFollowers');
    const tabG = document.getElementById('tabFollowing');
    if (!currentUser || !list) return;

    list.innerHTML = '<div class="spinner" style="display:block; margin:20px auto; border:2px solid var(--accent); border-top-color:transparent; width:20px; height:20px; border-radius:50%; animation:spin .6s linear infinite;"></div>';
    socialDisplayedCount = 0;
    currentSocialTab = tab;
    
    tabR.style.color = (tab === 'followers') ? 'var(--accent)' : '#555';
    tabG.style.color = (tab === 'following') ? 'var(--accent)' : '#555';

    const path = tab === 'followers' ? `users/${currentUser.uid}/followers` : `following/${currentUser.uid}`;
    const snap = await get(ref(db, path));
    
    if (!snap.exists() || Object.keys(snap.val()).length === 0) {
        list.innerHTML = `<p style="text-align:center; font-size:11px; color:#555; margin-top:20px;">No ${tab} yet</p>`;
        return;
    }

    socialUids = Object.keys(snap.val());
    list.innerHTML = ''; 
    renderSocialBatch(); 
};

async function renderSocialBatch() {
    const list = document.getElementById('socialList');
    if (socialDisplayedCount >= socialUids.length) return;

    const nextBatch = socialUids.slice(socialDisplayedCount, socialDisplayedCount + socialBatchSize);
    const myFollowingSnap = await get(ref(db, `following/${currentUser.uid}`));
    const myFollowing = myFollowingSnap.val() || {};

    for (const fUid of nextBatch) {
        const uSnap = await get(ref(db, `users/${fUid}`));
        const u = uSnap.val() || {};
        
        let btnText = (currentSocialTab === 'following') ? 'UNFOLLOW' : (myFollowing[fUid] ? 'FOLLOWING' : 'FOLLOW BACK');
        renderSocialItem(list, fUid, u, btnText);
    }
    socialDisplayedCount += socialBatchSize;
}

// THE MASTER FOLLOW FUNCTION (Universal Fix)
window.doFollow = async (uid) => {
    if (!currentUser) return notify("Login required", "error");
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted", "error");
    if (currentUser.uid === uid) return;

    // 1. Find ALL buttons for this user (Feed, Comments, and Social Tab)
    const allBtns = document.querySelectorAll(`.follow-btn-${uid}, #socBtn-${uid}`);
    
    // 2. Set loading state on all of them
    allBtns.forEach(b => { b.disabled = true; b.innerText = '...'; });

    try {
        const myFollowingRef = ref(db, `following/${currentUser.uid}/${uid}`);
        const snap = await get(myFollowingRef);
        const alreadyFollowing = snap.exists();
        
        const updates = {};
        if (alreadyFollowing) {
            updates[`following/${currentUser.uid}/${uid}`] = null;
            updates[`users/${uid}/followers/${currentUser.uid}`] = null;
        } else {
            updates[`following/${currentUser.uid}/${uid}`] = true;
            updates[`users/${uid}/followers/${currentUser.uid}`] = true;
        }

        await update(ref(db), updates);
        
        // 3. Update UI state for all buttons simultaneously
        const newState = !alreadyFollowing;
        allBtns.forEach(btn => {
            btn.disabled = false;
            
            // Logic for the Social Panel List
            if (btn.id.startsWith('socBtn-')) {
                if (currentSocialTab === 'following' && !newState) {
                    document.getElementById(`social-row-${uid}`)?.remove();
                } else {
                    btn.innerText = newState ? (currentSocialTab === 'following' ? 'UNFOLLOW' : 'FOLLOWING') : 'FOLLOW BACK';
                    btn.style.background = newState ? "#333" : "var(--accent)";
                }
            } 
            // Logic for Feed and Comment Modal
            else {
                btn.classList.toggle('following', newState);
                btn.innerText = newState ? 'FOLLOWING' : 'FOLLOW';
                btn.style.background = newState ? "#4caf50" : "var(--accent)";
                btn.style.color = newState ? "#000" : "#fff";
            }
        });

        refreshStats();
    } catch (e) { 
        console.error(e); 
        allBtns.forEach(b => { b.disabled = false; b.innerText = 'RETRY'; });
    }
};

document.getElementById('socialList').addEventListener('scroll', function(e) {
    const el = e.target;
    if (el.scrollHeight - el.scrollTop <= el.clientHeight + 50) {
        renderSocialBatch();
    }
});

/* --- FINALIZED SECURITY & ANNOUNCEMENT SYSTEM --- */
window.isBlacklisted = false;
let securityListener = null;
let announceListener = null;

async function checkUserSecurity(user) {
    // Cleanup previous listeners to prevent memory leaks/duplicate popups
    if (securityListener) securityListener();
    if (announceListener) announceListener();

    if (!user) return;
    
    // 1. REAL-TIME SECURITY WATCH
    const securityRef = ref(db, `users/${user.uid}/securityStatus`);
    securityListener = onValue(securityRef, (snap) => {
        const status = snap.val() || { type: 'clear' };

        if (status.type === 'banned') {
            showBanModal(status.reason || "Violation of terms", user.uid);
        } else if (status.type === 'blacklisted') {
            window.isBlacklisted = true;
            if (!sessionStorage.getItem('notified_blacklist')) {
                notify("Account Blacklisted: Interactions restricted", "error");
                sessionStorage.setItem('notified_blacklist', 'true');
            }
        } else {
            window.isBlacklisted = false;
            sessionStorage.removeItem('notified_blacklist');
        }
    });

    // 2. PERMANENT & EXPIRING ANNOUNCEMENTS
    const announceRef = ref(db, 'announcements');
    announceListener = onValue(announceRef, async (snap) => {
        if (!snap.exists()) return;

        // Fetch user's "seen" history from Firebase
        const seenSnap = await get(ref(db, `users/${user.uid}/seenAnnouncements`));
        const seenAnnouncements = seenSnap.val() || {};
        const now = Date.now();

        snap.forEach(child => {
            const announcement = child.val();
            const announceId = child.key;

            // Logic Check: Not expired + Not seen before + Correct target
            const isExpired = announcement.expiry && now > announcement.expiry;
            const alreadySeen = seenAnnouncements[announceId];
            const isTargeted = announcement.target === 'all' || announcement.target === user.uid;

            if (!isExpired && !alreadySeen && isTargeted) {
                // Check if already on screen to prevent duplicates
                if (!document.getElementById(`announce-${announceId}`)) {
                    showAnnouncement(announcement, announceId, user.uid);
                }
            }
        });
    });
}

function showAnnouncement(data, id, uid) {
    const notifyDiv = document.createElement('div');
    notifyDiv.id = `announce-${id}`;
    notifyDiv.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
        width: 90%; max-width: 400px; background: #000; color: #fff; 
        padding: 15px; border-radius: 20px; z-index: 10000; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.8); border: 2px solid #fff; 
        font-weight: 900; display: flex; flex-direction: column; 
        animation: slideDown 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    `;
    
    notifyDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:8px;">
            <span style="font-size:10px; letter-spacing:1px; color:#fff;">üì¢ RBX UPDATE</span>
            <button id="close-${id}" style="background:none; border:none; color:#fff; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <p style="margin:0; font-size:13px; font-weight:700; color:#ccc;">${data.message}</p>
    `;
    
    document.body.appendChild(notifyDiv);

    document.getElementById(`close-${id}`).onclick = async () => {
        // Mark as seen in Database so it never shows again for this user
        try {
            await update(ref(db, `users/${uid}/seenAnnouncements`), {
                [id]: true
            });
        } catch (e) { console.error("History sync failed", e); }

        notifyDiv.style.opacity = "0";
        setTimeout(() => notifyDiv.remove(), 400);
    };
}

// --- BAN MODAL & UTILS ---
async function showBanModal(reason, uid) {
    const snapshot = await get(ref(db, `users/${uid}/appealStatus`));
    const appealStatus = snapshot.val();

    let appealHTML = appealStatus === "pending" 
        ? `<p style="color:#00E052; font-weight:900; background:rgba(0,224,82,0.1); padding:15px; border-radius:12px; border: 1px solid #00E052;">APPEAL UNDER REVIEW</p>`
        : `<button id="submitAppealBtn" style="background:#fff; color:#000; border:none; width:100%; padding:15px; border-radius:15px; font-weight:900; cursor:pointer;">SUBMIT APPEAL</button>`;

    document.body.innerHTML = `
        <div style="position:fixed; inset:0; background:#000; display:flex; align-items:center; justify-content:center; z-index:99999; color:white; text-align:center; font-family:sans-serif;">
            <div style="max-width:400px; width:100%; padding:40px; border-radius:30px; border:2px solid #fff;">
                <div style="font-size:50px;">üö´</div>
                <h1 style="font-size:24px; font-weight:900;">ACCESS REVOKED</h1>
                <p style="color:#aaa;">Reason: <strong>${reason}</strong></p>
                <div id="appealArea">${appealHTML}</div>
            </div>
        </div>`;

    const btn = document.getElementById('submitAppealBtn');
    if (btn) {
        btn.onclick = async () => {
            btn.innerText = "SENDING...";
            await update(ref(db, `users/${uid}`), { appealStatus: "pending", appealTimestamp: Date.now() });
            location.reload(); // Reload to show the "Under Review" state
        };
    }
    window.stop(); 
}

</script>

</main>
</body>
</html>