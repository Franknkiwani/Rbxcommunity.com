<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBX Community</title>
</head>
<body>
<style>
*{box-sizing:border-box;user-select:none;outline:none;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#121212;color:#fff;}
header{height:50px;display:flex;align-items:center;justify-content:space-between;background:#000;border-bottom:1px solid #2a2a2a;padding:0 12px;position:sticky;top:0;z-index:1000;}
.logo{height:36px;}
.header-right{display:flex;align-items:center;gap:12px;}
.profile{width:32px;height:32px;border-radius:50%;background-size:cover;background-position:center;cursor:pointer;border:2px solid #fff;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;opacity:1;}
.hamburger{width:32px;height:24px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;padding:2px;background:#000;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.5);transition: transform 0.2s;}
.hamburger div{height:4px;background:#fff;border-radius:6px;transition:all 0.3s ease;}
.hamburger.active div:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.active div:nth-child(2){opacity:0;}
.hamburger.active div:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}
.menu-overlay{position:fixed;top:50px;left:0;width:100%;height:100vh;background:#000;overflow-y:auto;transform:translateY(-100%);transition:transform 0.3s ease;z-index:900;display:flex;flex-direction:column;align-items:center;padding-top:20px;}
.menu-overlay.active{transform:translateY(0);}
.menu-overlay a{color:#fff;text-decoration:none;font-size:20px;margin:12px 0;font-weight:bold;}
.menu-overlay a:hover{color:#ccc;}
main{padding:20px;min-height:200vh;}

/* Profile Panel */
.profile-panel{position:fixed;top:0;left:0;width:100%;height:100vh;background:#111;transform:translateX(100%);transition:transform 0.3s ease;z-index:1100;display:flex;flex-direction:column;}
.profile-panel.active{transform:translateX(0);}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #222;}
.close-btn{background:#ff3b30;color:#fff;padding:6px 16px;font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:transform 0.2s;}
.close-btn:hover{transform:scale(1.05);}
.panel-top{display:flex;flex-direction:column;align-items:center;margin:20px 0;gap:12px;}
#panelProfilePic{width:100px;height:100px;border-radius:50%;border:3px solid #fff;background-size:cover;background-position:center;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;cursor:pointer;}
#userInfo{color:#fff;font-size:16px;display:flex;flex-direction:column;align-items:center;gap:6px;}
#copyLinkContainer{display:flex;align-items:center;gap:8px;width:90%;max-width:300px;}
#copyLinkContainer input{flex:1;padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;}
#copyLinkContainer button{background:#4caf50;color:#fff;border:none;padding:6px 12px;border-radius:12px;cursor:pointer;font-weight:bold;}
#copyStatus{font-size:12px;margin-top:6px;}
.spinner{border:4px solid #ccc;border-top:4px solid #4caf50;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin-top:6px;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
button.login-btn{background:#4caf50;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;}
.profile-panel .panel-header {
  background-color: #000; /* solid black */
  border-bottom: 1px solid #222; /* optional, keeps subtle separation */
}
#headerProfile, #panelProfilePic {
  background-image: url('https://i.imgur.com/cM3Givj.jpeg'); /* default */
  background-size: cover;
  background-position: center;
}
/* Disable text selection highlight */
* {
  user-select: none;       /* Prevent selecting text */
  -webkit-user-select: none; 
  -moz-user-select: none;
  -ms-user-select: none;
}

/* Remove input, textarea, button blue outline on focus */
input:focus,
textarea:focus,
button:focus,
select:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* Remove blue tap highlight on mobile */
* {
  -webkit-tap-highlight-color: transparent; 
}

/* Optional: remove link tap highlight */
a:focus, a:active {
  outline: none !important;
}
#panelProfilePic {
  position:relative;
}
#uploadSpinner {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  display:none;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#saveHandleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #fff; /* white edges */
  background: rgba(0,0,0,0.5); /* glassy black */
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  backdrop-filter: blur(6px); /* glass effect */
  transition: none; /* no hover/movement */
}

#saveHandleBtn:active {
  transform: none; /* no click movement */
}
</style>
<header>
  <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="logo">
  <div class="header-right">
    <div class="profile" id="headerProfile"></div>
    <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <a href="#">Home</a>
  <a href="#">Community</a>
  <a href="#">Games</a>
  <a href="#">Events</a>
  <a href="#">Profile</a>
  <a href="#">Settings</a>
</div>

<div class="profile-panel" id="profilePanel">
  <div class="panel-header">
    <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="profile-logo" style="height:40px; object-fit:contain;">
    <button class="close-btn" id="closeProfile">Close</button>
  </div>
  <div class="panel-top">
    <div id="panelProfilePic"></div>
    <div id="userInfo"></div>
    <div id="copyLinkContainer">
      <input type="text" id="userLink" readonly>
      <button id="copyLinkBtn">Copy</button>
    </div>
    <span id="copyStatus"></span>
    <div class="spinner" id="uploadSpinner"></div>
    <input type="file" id="profileInput" accept="image/*" style="display:none;">
  </div>
<div class="panel-content" style="padding:20px; flex:1; display:flex; flex-direction:column;">
 <!-- Handle / Username Edit -->
<div id="handleContainer" style="display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:12px;">
  <input type="text" id="handleInput" placeholder="Username / Handle" 
         style="padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;width:60%;">
 <button id="saveHandleBtn">Save Handle</button>
  <span id="handleStatus" style="font-size:12px;color:#ccc;"></span>
</div>
  <!-- User Stats -->
  <div class="profile-stats" style="display:flex;justify-content:space-around;width:100%;margin-bottom:20px;">
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statPosts">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Posts</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowers">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Followers</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowing">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Following</p>
    </div>
  </div>


<div style="width:100%;background:#1a1a1a;padding:12px;border-radius:12px;margin-bottom:12px;">
  <h3 style="margin:0 0 8px 0;font-size:16px;">About Me</h3>
  <textarea id="userBioTextarea" maxlength="100" placeholder="Write something about yourself..." 
            style="width:100%;background:#222;color:#ccc;border:none;padding:8px;border-radius:8px;resize:none;font-size:14px;outline:none;"></textarea>
  <div id="bioCharCount" style="text-align:right;font-size:12px;color:#777;margin-top:4px;">0 / 100</div>
  <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <button id="saveProfileBtn" style="padding:8px 16px;border-radius:12px;border:none;background:#2196F3;color:#fff;font-weight:bold;cursor:pointer;flex-shrink:0;">Save Profile</button>
    <div class="spinner" id="saveProfileSpinner" style="width:20px;height:20px;border:3px solid #ccc;border-top:3px solid #4caf50;border-radius:50%;animation:spin 1s linear infinite;display:none;"></div>
    <span id="saveProfileStatus" style="font-size:12px;color:#4caf50;"></span>
  </div>
</div>

  </div>
</div>

<main style="padding:12px; background:#121212;">
  <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:bold; color:white; font-size:14px;">
    FEATURED PROFILES
    <img width="24" height="24" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified-badge"/>
  </div>

  <div id="userContainer" style="display:flex; overflow-x:auto; gap:12px; padding:8px 0; scrollbar-width:none;"></div>

<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#121212;color:#fff;margin:20px;}
h1{color:#00bfff;margin-bottom:10px;}
.stories-wrapper{display:flex;overflow-x:auto;scroll-behavior:smooth; gap:10px; height:300px; padding-bottom:10px;}
.story-card{flex:0 0 200px; background:#1e1e1e; border-radius:10px; padding:8px; display:flex; flex-direction:column; justify-content:flex-start; position:relative;}
.user-section{display:flex; align-items:center; margin-bottom:4px;}
.user-pic{width:25px; height:25px; border-radius:50%; margin-right:6px; border:2px solid #fff; object-fit:contain;}
.user-name{font-weight:bold; font-size:12px; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.follower-count{font-size:10px; color:#bbb; margin-left:4px;}
.story-title{font-size:13px; color:#ccc; margin-bottom:2px; word-break:break-word;}
.story-desc{font-size:12px; color:#aaa; flex:1; max-height:34px; overflow:hidden;}
.story-desc.expanded{max-height:none;}
.read-more{font-size:10px;color:#00bfff;cursor:pointer;margin-bottom:4px;}
.story-img{width:100%; height:auto; border-radius:6px; object-fit:contain; margin-bottom:4px;}
.follow-btn{margin-top:4px; font-size:10px; padding:2px 6px; border-radius:4px; border:none; background:#2e89ff; color:#fff; cursor:pointer; text-align:center;}
.loader{width:30px; height:30px; border:3px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin .8s linear infinite; margin:auto;}
@keyframes spin{to{transform:rotate(360deg)}}
.create-story{margin-bottom:20px;}
.create-story input, .create-story textarea{width:100%; margin-bottom:6px; padding:6px; border-radius:6px; border:none; background:#2a2a2a; color:#fff;}
.create-story button{padding:6px 10px; border:none; border-radius:6px; background:#00bfff; color:#fff; cursor:pointer;}
.story-comments{margin-top:4px; font-size:11px; max-height:60px; overflow-y:auto; border-top:1px solid #333; padding-top:2px;}
.comment-item{margin-bottom:2px;}
.comment-user{font-weight:bold; margin-right:2px;}
.comment-input{display:flex; margin-top:4px;}
.comment-input input{flex:1; padding:4px; border-radius:4px; border:none; background:#2a2a2a; color:#fff; font-size:12px;}
.comment-input button{padding:4px 6px; margin-left:4px; border:none; border-radius:4px; background:#00bfff; color:#fff; cursor:pointer; font-size:12px;}
.story-meta{position:absolute; top:6px; right:6px; font-size:9px; color:#ccc; text-align:right; line-height:1.2;}
/* Stories container - no scroll, all fit */
.stories-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  padding-bottom: 10px;
  overflow: visible; /* disable horizontal scroll */
  height: auto;
}

/* Story card */
.story-card {
  flex: none;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  border-radius: 10px;
  background: #1e1e1e;
  padding: 8px;
  position: relative;
}

/* Image with 16:9 ratio, fully contained */
.story-img {
  width: 100%;
  aspect-ratio: 16 / 9;
  object-fit: contain; /* fit entire image without cropping */
  border-radius: 6px;
  margin-bottom: 4px;
  background: #111; /* optional placeholder background */
}
.story-img-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16 / 9;
  overflow: hidden;
  border-radius: 6px;
  background: #111;
}

.story-img-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

.like-btn {
  position: absolute;
  top: 6px;
  left: 6px;
  display: flex;
  align-items: center;
  gap: 4px;
  background: rgba(0,0,0,0.5);
  padding: 2px 6px;
  border-radius: 20px;
  font-size: 12px;
  color: #fff;
  cursor: pointer;
  user-select: none;
}

.like-btn.liked {
  color: #ff4b4b;
}
.story-img-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 16/9;
  overflow: hidden;
  background: #000; /* fallback background */
}

.story-img-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Common button container */
.story-img-wrapper .like-btn,
.story-img-wrapper .share-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  position: absolute;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.story-img-wrapper .like-btn:hover,
.story-img-wrapper .share-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
}

/* Positioning */
.story-img-wrapper .like-btn {
  left: 8px;
  top: 8px;
}

.story-img-wrapper .share-btn {
  right: 8px;
  top: 8px;
}

/* Like count */
.story-img-wrapper .like-count {
  position: absolute;
  left: 8px;
  top: 46px;
  font-size: 12px;
  color: #000;
  font-weight: bold;
}
</style>
<h1>Create a Story</h1>
<div class="create-story">
  <input type="text" id="storyTitle" placeholder="Story Title" />
  <textarea id="storyDesc" placeholder="Story Description" rows="2"></textarea>
  <input type="file" id="storyImage" />
  <button id="createStoryBtn">Post Story</button>
  <span id="storyStatus"></span>
</div>

<h1>Featured Stories</h1>
<div class="stories-wrapper" id="storiesContainer">
  <div class="loader" id="initialLoader"></div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, push, runTransaction, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9cd31082a5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const storiesContainer = document.getElementById('storiesContainer');
const initialLoader = document.getElementById('initialLoader');
const createBtn = document.getElementById('createStoryBtn');
const titleInput = document.getElementById('storyTitle');
const descInput = document.getElementById('storyDesc');
const imgInput = document.getElementById('storyImage');
const status = document.getElementById('storyStatus');

let currentUser = null;
let allStories = [];
let loadedCount = 0;
const BATCH = 6;

// Simple spinner
function createSpinner(){
  const s = document.createElement('div');
  s.style.cssText = "width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;";
  return s;
}

// Count helper
function count(val){
  if(!val) return 0;
  if(typeof val==='number') return val;
  if(typeof val==='object') return Object.keys(val).length;
  return 0;
}

// Time ago helper
function timeAgo(ts){
  const diff = Date.now() - ts;
  const minutes = Math.floor(diff/60000);
  if(minutes < 1) return 'Just now';
  if(minutes < 60) return `${minutes} min ago`;
  const hours = Math.floor(minutes/60);
  if(hours < 24) return `${hours} hr ago`;
  const days = Math.floor(hours/24);
  return `${days} day${days>1?'s':''} ago`;
}

// Shuffle array
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

onAuthStateChanged(auth,user=>{
  currentUser = user || null;
  fetchStories();
});

createBtn.addEventListener('click',async()=>{
  if(!currentUser){ status.textContent='Login first'; return; }
  const title = titleInput.value.trim();
  if(!title){ status.textContent='Add a title'; return; }
  const description = descInput.value.trim();

  let imgUrl = '';
  if(imgInput.files[0]){
    const formData = new FormData();
    formData.append('image', imgInput.files[0]);
    try{
      const res = await fetch('https://api.imgur.com/3/image', {method:'POST', headers:{Authorization:'Client-ID 891e5bb4aa94282'}, body:formData});
      const data = await res.json();
      if(data.success) imgUrl = data.data.link;
    } catch(e){ console.error(e); status.textContent='Image upload failed'; return; }
  }

  const newStory = {
    title,
    description,
    image: imgUrl,
    user: { uid: currentUser.uid, displayName: currentUser.displayName || 'User' },
    timestamp: Date.now(),
    views: 0
  };

  await push(ref(db,'stories'),newStory);
  status.textContent='Story posted!';
  titleInput.value=''; descInput.value=''; imgInput.value='';
  allStories.unshift([Date.now(),newStory]);
  loadedCount = 0;
  storiesContainer.innerHTML='';
  loadNextBatch();
});

async function fetchStories(){
  const snap = await get(ref(db,'stories'));
  if(!snap.exists()){ storiesContainer.innerHTML="<p style='color:#888;'>No stories found.</p>"; return; }
  allStories = shuffle(Object.entries(snap.val()).sort((a,b)=>b[1].timestamp - a[1].timestamp));
  initialLoader.style.display='none';
  loadNextBatch();
}

async function loadNextBatch(){
  const nextBatch = allStories.slice(loadedCount, loadedCount+BATCH);
  for(const [id,story] of nextBatch){
    const userSnap = await get(ref(db,`users/${story.user.uid}`));
    const userData = userSnap.val() || {};
    const card = document.createElement('div');
    card.className='story-card';

    // Title
    const titleDiv = document.createElement('div');
    titleDiv.className='story-title';
    titleDiv.textContent = story.title;
    card.appendChild(titleDiv);

    // Meta
    const metaDiv = document.createElement('div');
    metaDiv.className='story-meta';

    // Increment views per user once
    if(currentUser){
      const userViewRef = ref(db, `storyViews/${id}/${currentUser.uid}`);
      const viewedSnap = await get(userViewRef);
      if(!viewedSnap.exists()){
        await set(userViewRef,true);
        await runTransaction(ref(db, `stories/${id}/views`), c=>(c||0)+1);
      }
    }

    const snapViews = await get(ref(db, `stories/${id}/views`));
    const timeSpan = document.createElement('div');
    timeSpan.textContent = timeAgo(story.timestamp);
    metaDiv.appendChild(timeSpan);

    const viewsSpan = document.createElement('div');
    viewsSpan.textContent = (snapViews.val()||0)+' views';
    metaDiv.appendChild(viewsSpan);
    card.appendChild(metaDiv);

    // Description
    const descDiv = document.createElement('div');
    descDiv.className='story-desc';
    descDiv.textContent = story.description || '';
    card.appendChild(descDiv);

    if(story.description && story.description.length>100){
      const readMore = document.createElement('div');
      readMore.className='read-more';
      readMore.textContent='Read more';
      readMore.addEventListener('click',()=>{
        descDiv.classList.toggle('expanded');
        readMore.textContent = descDiv.classList.contains('expanded') ? 'Show less' : 'Read more';
      });
      card.appendChild(readMore);
    }

    // Image wrapper + like/share
    if(story.image){
      const imgWrapper = document.createElement('div');
      imgWrapper.className='story-img-wrapper';
      imgWrapper.style.position='relative';
      imgWrapper.style.aspectRatio='16/9';
      const storyImg = document.createElement('img');
      storyImg.src = story.image;
      storyImg.style.width='100%';
      storyImg.style.height='100%';
      storyImg.style.objectFit='contain';
      imgWrapper.appendChild(storyImg);

      // Like
      const likeBtn = document.createElement('div');
      likeBtn.style.position='absolute';
      likeBtn.style.left='8px';
      likeBtn.style.bottom='8px';
      likeBtn.style.cursor='pointer';
      likeBtn.style.display='flex';
      likeBtn.style.alignItems='center';
      likeBtn.style.gap='4px';

      const heartSVG = document.createElementNS("http://www.w3.org/2000/svg","svg");
      heartSVG.setAttribute("viewBox","0 0 24 24");
      heartSVG.setAttribute("width","20");
      heartSVG.setAttribute("height","20");
      heartSVG.innerHTML = `<path fill="white" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5
        2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09
        1.09-1.28 2.76-2.09 4.5-2.09C19.58 3 22 5.42 22 8.5
        c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>`;

      likeBtn.appendChild(heartSVG);

      const likeCount = document.createElement('span');
      likeCount.style.color = '#fff';
      likeCount.textContent = '0';
      likeBtn.appendChild(likeCount);

      const likesRef = ref(db, `storyLikes/${id}`);
      const userLikeRef = currentUser ? ref(db, `storyLikes/${id}/${currentUser.uid}`) : null;

      async function updateLikeBtn(){
        const snapLikes = await get(likesRef);
        const likesData = snapLikes.val() || {};
        const countLikes = Object.keys(likesData).length;
        const userLiked = currentUser ? likesData[currentUser.uid] : false;
        heartSVG.querySelector('path').setAttribute('fill', userLiked ? '#ff4b4b' : 'white');
        likeCount.textContent = countLikes;
      }
      updateLikeBtn();

      likeBtn.addEventListener('click', async ()=>{
        if(!currentUser) return alert('Login first');
        const userSnap = await get(userLikeRef);
        if(userSnap.exists()) await set(userLikeRef,null);
        else await set(userLikeRef,true);
        updateLikeBtn();
      });

      imgWrapper.appendChild(likeBtn);

      // Share
      const shareBtn = document.createElement('img');
      shareBtn.src = 'https://img.icons8.com/ios-filled/50/share.png';
      shareBtn.style.width='32px';
      shareBtn.style.height='32px';
      shareBtn.style.position='absolute';
      shareBtn.style.right='8px';
      shareBtn.style.bottom='8px';
      shareBtn.style.cursor='pointer';
      shareBtn.style.background='#fff';
      shareBtn.style.borderRadius='50%';
      shareBtn.addEventListener('click',()=>{
        const shareURL = `${window.location.origin}/post?post=${id}`;
        navigator.clipboard.writeText(shareURL).then(()=>alert('Post URL copied!'));
      });
      imgWrapper.appendChild(shareBtn);

      card.appendChild(imgWrapper);
    }

    // User info + follow
    const userSec = document.createElement('div');
    userSec.className='user-section';
    const userImg = document.createElement('img');
    userImg.className='user-pic';
    userImg.src = userData.profilePic || 'https://via.placeholder.com/25';
    userSec.appendChild(userImg);

    const userName = document.createElement('div');
    userName.className='user-name';
    userName.textContent = userData.handle || story.user.displayName || 'User';
    userSec.appendChild(userName);

    const followersCount = document.createElement('div');
    followersCount.className='follower-count';
    const fSnap = await get(ref(db,`users/${story.user.uid}/followers`));
    followersCount.textContent = count(fSnap.val())+' followers';
    userSec.appendChild(followersCount);
    card.appendChild(userSec);

    if(currentUser && currentUser.uid!==story.user.uid){
      const followBtn = document.createElement('button');
      followBtn.className='follow-btn';
      card.appendChild(followBtn);

      async function updateBtn(){
        const snap = await get(ref(db,`following/${currentUser.uid}/${story.user.uid}`));
        if(snap.exists()){ followBtn.textContent='Following'; followBtn.style.background='#4caf50'; }
        else{ followBtn.textContent='Follow'; followBtn.style.background='#2e89ff'; }
      }
      updateBtn();

      followBtn.addEventListener('click', async ()=>{
        followBtn.disabled=true;
        const spinner=createSpinner();
        followBtn.innerHTML=''; followBtn.appendChild(spinner);

        const path = ref(db,`following/${currentUser.uid}/${story.user.uid}`);
        const snap = await get(path);
        if(!snap.exists()){
          await set(path,true);
          await set(ref(db, `users/${story.user.uid}/followers/${currentUser.uid}`), true);
        } else {
          await set(path,null);
          await set(ref(db, `users/${story.user.uid}/followers/${currentUser.uid}`), null);
        }

        await updateBtn();
        const fSnap2 = await get(ref(db,`users/${story.user.uid}/followers`));
        followersCount.textContent = count(fSnap2.val())+' followers';
        followBtn.disabled=false;
      });
    }

    storiesContainer.appendChild(card);
  }
  loadedCount += nextBatch.length;
}

// Scroll lazy load
storiesContainer.addEventListener('scroll',()=>{
  const scrollLeft = storiesContainer.scrollLeft;
  const scrollWidth = storiesContainer.scrollWidth;
  const clientWidth = storiesContainer.clientWidth;
  if(scrollLeft + clientWidth >= scrollWidth - 50) loadNextBatch();
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, runTransaction } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= ELEMENTS ================= */
const hamburger = document.getElementById('hamburger');
const menuOverlay = document.getElementById('menuOverlay');
const headerProfile = document.getElementById('headerProfile');
const profilePanel = document.getElementById('profilePanel');
const closeProfile = document.getElementById('closeProfile');
const panelProfilePic = document.getElementById('panelProfilePic');
const userInfo = document.getElementById('userInfo');
const userLinkInput = document.getElementById('userLink');
const copyBtn = document.getElementById('copyLinkBtn');
const copyStatus = document.getElementById('copyStatus');
const uploadSpinner = document.getElementById('uploadSpinner');
const profileInput = document.getElementById('profileInput');
const userBioTextarea = document.getElementById('userBioTextarea');
const bioCharCount = document.getElementById('bioCharCount');
const statPosts = document.getElementById('statPosts');
const statFollowers = document.getElementById('statFollowers');
const statFollowing = document.getElementById('statFollowing');
const handleInput = document.getElementById('handleInput');
const saveHandleBtn = document.getElementById('saveHandleBtn');
const handleStatus = document.getElementById('handleStatus');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const saveProfileSpinner = document.getElementById('saveProfileSpinner');
const saveProfileStatus = document.getElementById('saveProfileStatus');
const featuredContainer = document.getElementById("userContainer");

/* ================= UTILS ================= */
function notify(el,msg,ok=true,t=2000){
  if(!el) return;
  el.textContent=msg;
  el.style.color=ok?'#4caf50':'#f44336';
  setTimeout(()=>el.textContent='',t);
}

function randomColor(){
  return `hsl(${Math.random()*360},80%,60%)`;
}

function count(val){
  if(!val) return 0;
  if(typeof val === 'number') return val;
  if(typeof val === 'object') return Object.keys(val).length;
  return 0;
}

function createSpinner(){
  const s=document.createElement('div');
  s.style.cssText=`width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;`;
  return s;
}

const style=document.createElement('style');
style.innerHTML=`@keyframes spin{to{transform:rotate(360deg)}}`;
document.head.appendChild(style);

/* ================= UI ================= */
hamburger?.addEventListener('click',()=>{
  hamburger.classList.toggle('active');
  menuOverlay.classList.toggle('active');
});

headerProfile?.addEventListener('click',()=>{
  profilePanel.classList.add('active');
  document.body.style.overflow='hidden';
});

closeProfile?.addEventListener('click',()=>{
  profilePanel.classList.remove('active');
  document.body.style.overflow='auto';
});

/* ================= COPY LINK ================= */
copyBtn?.addEventListener('click',()=>{
  if(!userLinkInput.value || userLinkInput.value.includes('Login')) return;
  navigator.clipboard.writeText(userLinkInput.value);
  notify(copyStatus,'Copied');
});

/* ================= PROFILE PIC UPLOAD ================= */
panelProfilePic?.addEventListener('click',()=>profileInput.click());
profileInput?.addEventListener('change',async()=>{
  if(!profileInput.files[0] || !auth.currentUser) return;
  uploadSpinner.style.display='block';
  const formData=new FormData();
  formData.append('image',profileInput.files[0]);
  try{
    const res=await fetch('https://api.imgur.com/3/image',{method:'POST',headers:{Authorization:'Client-ID 891e5bb4aa94282'},body:formData});
    const data=await res.json();
    if(data.success){
      await set(ref(db, `users/${auth.currentUser.uid}/profilePic`),data.data.link);
      panelProfilePic.style.backgroundImage=`url(${data.data.link})`;
      headerProfile.style.backgroundImage=`url(${data.data.link})`;
      notify(saveProfileStatus,'Profile picture updated!');
    } else notify(saveProfileStatus,'Upload failed!',false);
  } catch(e){ console.error(e); notify(saveProfileStatus,'Upload error!',false);}
  uploadSpinner.style.display='none';
});

/* ================= AUTH ================= */
let currentUser=null;

onAuthStateChanged(auth, async user=>{
  currentUser=user||null;

  if(!user){
    userInfo.innerHTML='';
    userLinkInput.value='Login to get link';
    statPosts.textContent=0;
    statFollowers.textContent=0;
    statFollowing.textContent=0;
    loadFeaturedUsers();
    return;
  }

  const uid = user.uid;
  userLinkInput.value=`${location.origin}/profile?uid=${uid}`;

  const snap = await get(ref(db, `users/${uid}`));
  const data = snap.val() || {};
  
  // followers & following counters
  const followers = count(data.followers);
  const followingSnap = await get(ref(db, `following/${uid}`));
  const following = followingSnap.exists() ? Object.keys(followingSnap.val()).length : 0;

  statFollowers.textContent = followers;
  statFollowing.textContent = following;
  statPosts.textContent = count(data.posts);

  userInfo.innerHTML=`@${data.handle||'user'} (${followers})`;

  if(data.profilePic){
    headerProfile.style.backgroundImage=`url(${data.profilePic})`;
    panelProfilePic.style.backgroundImage=`url(${data.profilePic})`;
  }

  if(userBioTextarea){
    userBioTextarea.value=data.bio||'';
    bioCharCount.textContent=`${userBioTextarea.value.length} / 100`;
  }

  handleInput.value = data.handle || 'user';

  loadFeaturedUsers();
});

/* ================= SAVE HANDLE ================= */
saveHandleBtn?.addEventListener('click',async()=>{
  if(!currentUser) return notify(handleStatus,'Login first',false);
  const h = handleInput.value.trim();
  if(h.length<3) return notify(handleStatus,'Too short',false);

  // Check uniqueness
  const allSnap = await get(ref(db,'users'));
  const allUsers = allSnap.val() || {};
  const taken = Object.entries(allUsers).some(([uid,u])=>u.handle?.toLowerCase()===h.toLowerCase() && uid!==currentUser.uid);
  if(taken) return notify(handleStatus,'Handle already taken!',false);

  await set(ref(db, `users/${currentUser.uid}/handle`), h);
  notify(handleStatus,'Saved');
});

/* ================= SAVE PROFILE ================= */
saveProfileBtn?.addEventListener('click', async ()=>{
  if(!currentUser) return;
  saveProfileSpinner.style.display='block';
  if(userBioTextarea) await set(ref(db,`users/${currentUser.uid}/bio`), userBioTextarea.value);
  if(handleInput?.value.trim().length>=3) await set(ref(db,`users/${currentUser.uid}/handle`), handleInput.value.trim());
  saveProfileSpinner.style.display='none';
  notify(saveProfileStatus,'Saved');
});

/* ================= FEATURED USERS ================= */
async function loadFeaturedUsers(){
  if(!featuredContainer) return;

  const snap = await get(ref(db,'users'));
  if(!snap.exists()){ featuredContainer.innerHTML="<p style='color:#888;'>No users found.</p>"; return; }

  let allUsers = Object.entries(snap.val());
  allUsers.sort(()=>0.5-Math.random());
  const featured10 = allUsers.slice(0,10);
  featuredContainer.innerHTML='';

  featured10.forEach(([uid,user])=>{
    const div=document.createElement('div');
    div.style.cssText="flex:0 0 auto; width:70px; display:flex; flex-direction:column; align-items:center;";

    const imgWrapper=document.createElement('div');
    imgWrapper.style.cssText=`width:60px;height:60px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid #fff;transition:border-color 1s;`;
    const img=document.createElement('img');
    img.src = user.profilePic || 'https://via.placeholder.com/60?text=?';
    img.style.cssText="width:100%;height:100%;object-fit:cover;";
    imgWrapper.appendChild(img);
    div.appendChild(imgWrapper);
    setInterval(()=>{ imgWrapper.style.borderColor=randomColor(); },1000);

    const handleDiv = document.createElement('div');
    handleDiv.textContent = '@'+(user.handle||'user');
    handleDiv.style.cssText="max-width:70px;font-size:10px;color:#fff;margin-top:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
    div.appendChild(handleDiv);

    const followerDiv=document.createElement('div');
    followerDiv.style.cssText="font-size:9px;color:#bbb;text-align:center;margin-top:2px;";
    div.appendChild(followerDiv);

    const button=document.createElement('button');
    button.style.cssText="margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;background:#2e89ff;color:#fff;cursor:pointer;text-align:center;";
    div.appendChild(button);

    const msg=document.createElement('span');
    msg.style.cssText="color:#ff6b6b;font-size:10px;margin-top:2px;display:none;text-align:center;";
    div.appendChild(msg);

    async function updateButton(){
      // followers count
      const fSnap = await get(ref(db, `users/${uid}/followers`));
      followerDiv.textContent = (fSnap.val()||0)+' followers';

      if(!currentUser){
        button.textContent='Follow';
        button.style.background='#2e89ff';
        return;
      }

      const path = ref(db, `following/${currentUser.uid}/${uid}`);
      const snap = await get(path);
      if(snap.exists()){
        button.textContent='Following';
        button.style.background='#4caf50';
      } else {
        button.textContent='Follow';
        button.style.background='#2e89ff';
      }
    }
    updateButton();

    button.addEventListener('click', async ()=>{
      if(!currentUser){
        msg.textContent="Only logged in users can follow"; 
        msg.style.display='block';
        setTimeout(()=> msg.style.display='none',2000);
        return;
      }

      const spinner=createSpinner();
      button.innerHTML=''; button.appendChild(spinner); button.disabled=true;

      const path = ref(db, `following/${currentUser.uid}/${uid}`);
      const snap = await get(path);
      if(!snap.exists()){
        await set(path,true);
        await runTransaction(ref(db, `users/${uid}/followers`), c=>(c||0)+1);
      } else {
        await set(path,null);
        await runTransaction(ref(db, `users/${uid}/followers`), c=>Math.max((c||0)-1,0));
      }

      // Update my following counter
      const myFollowingSnap = await get(ref(db, `following/${currentUser.uid}`));
      statFollowing.textContent = myFollowingSnap.exists() ? Object.keys(myFollowingSnap.val()).length : 0;

      await updateButton();
      button.disabled=false;
    });

    featuredContainer.appendChild(div);
  });
}
</script>
</main>

</body>
</html>