<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBX Studio</title>
    <style>
        :root {
            --bg: #000000;
            --card: #1C1C1E;
            --accent: #00E052;
            --text-dim: #8E8E93;
            --border: #2C2C2E;
            --red: #FF453A;
        }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; }
        
        header { padding: 40px 20px 20px; }
        .view-title { font-size: 32px; font-weight: 800; margin: 0; }
        .view-subtitle { color: var(--accent); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }

        .mgmt-section { display: none; padding: 0 20px; animation: slideUp 0.4s ease; }
        .active { display: block; }

        /* Dashboard Style */
        .balance-card { background: var(--accent); padding: 30px 20px; border-radius: 24px; color: #000; margin-bottom: 20px; position: relative; }
        .payout-info { background: rgba(0,0,0,0.05); padding: 8px 12px; border-radius: 10px; font-size: 10px; font-weight: 800; margin-top: 15px; display: inline-block; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .stat-card { background: var(--card); padding: 18px; border-radius: 20px; border: 1px solid var(--border); }
        .stat-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; font-weight: 800; display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }
        .stat-val { font-size: 20px; font-weight: 800; }

        /* Content List */
        .content-card { background: var(--card); border-radius: 20px; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .content-thumb { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; }
        .mon-toggle { border: none; padding: 8px 12px; border-radius: 10px; font-weight: 800; font-size: 10px; cursor: pointer; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); display: flex; border-top: 1px solid var(--border); }
        .nav-btn { flex: 1; background: none; border: none; color: var(--text-dim); font-size: 9px; font-weight: 800; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; }
        .nav-btn.active { color: var(--accent); }
        
        svg { width: 20px; height: 20px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div class="view-subtitle" id="view-indicator">Creator Dashboard</div>
    <h1 class="view-title" id="view-name">Analysis</h1>
</header>

<section id="view-analysis" class="mgmt-section active">
    <div class="balance-card">
        <div style="font-size: 11px; font-weight: 700; opacity: 0.7;">TOTAL BALANCE</div>
        <div id="balance" style="font-size: 48px; font-weight: 900; letter-spacing: -1px;">$0.00</div>
        
        <div id="payout-notice" style="display:none;">
            <div class="payout-info">PAID MONTHLY BETWEEN 5-10</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg> Valid Clicks
            </span>
            <span id="valid-clicks" class="stat-val" style="color:var(--accent);">0</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg> Invalid
            </span>
            <span id="invalid-clicks" class="stat-val" style="color:var(--red);">0</span>
        </div>
        <div class="stat-card" style="grid-column: span 2;">
            <span class="stat-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg> Dynamic CPM
            </span>
            <span id="dynamic-cpm" class="stat-val">$2.50</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Click Revenue</span>
            <span id="click-rev-val" class="stat-val">$0.00</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Ad Revenue</span>
            <span id="ad-rev-val" class="stat-val">$0.00</span>
        </div>
    </div>
</section>

<section id="view-manage" class="mgmt-section">
    <div id="content-list"></div>
</section>

<nav>
    <button class="nav-btn active" onclick="showTab('analysis')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
        ANALYSIS
    </button>
    <button class="nav-btn" onclick="showTab('manage')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M9 3v18M3 9h18"/></svg>
        MANAGE
    </button>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
        authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
        databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
        projectId: "itzhoyoo-f9f7e",
        storageBucket: "itzhoyoo-f9f7e.filestorage.app",
        messagingSenderId: "1094792075584",
        appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    window.showTab = (tab) => {
        document.querySelectorAll('.mgmt-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById(`view-${tab}`).classList.add('active');
        document.getElementById('view-name').innerText = tab.toUpperCase();
        if(tab === 'analysis') runAnalysis();
    };

    async function runAnalysis() {
        const user = auth.currentUser;
        if (!user) return;

        let vClicks = 0, iClicks = 0, vCount = 0;
        const types = ['post', 'poll', 'story'];
        const userItems = [];

        for (const t of types) {
            const snap = await get(ref(db, t));
            if (snap.exists()) {
                Object.entries(snap.val()).forEach(([id, item]) => {
                    if (item.uid === user.uid && item.sponsored) {
                        userItems.push(id);
                        vCount += (item.views || 0);
                    }
                });
            }
        }

        for (const id of userItems) {
            const cSnap = await get(ref(db, `clicks/${id}`));
            if (cSnap.exists()) {
                Object.values(cSnap.val()).forEach(c => {
                    if (c.valid) vClicks++; else iClicks++;
                });
            }
        }

        const cpm = 2.50 + (vClicks * 0.05);
        const cRev = vClicks * 0.10;
        const aRev = (vCount / 1000) * cpm;
        const total = cRev + aRev;

        document.getElementById('valid-clicks').innerText = vClicks;
        document.getElementById('invalid-clicks').innerText = iClicks;
        document.getElementById('dynamic-cpm').innerText = `$${cpm.toFixed(2)}`;
        document.getElementById('click-rev-val').innerText = `$${cRev.toFixed(2)}`;
        document.getElementById('ad-rev-val').innerText = `$${aRev.toFixed(2)}`;
        document.getElementById('balance').innerText = `$${total.toFixed(2)}`;
        
        document.getElementById('payout-notice').style.display = total >= 10 ? 'block' : 'none';
    }

    async function loadManage() {
        const container = document.getElementById('content-list');
        container.innerHTML = "";
        const types = ['post', 'poll', 'story'];

        for (const t of types) {
            const snap = await get(ref(db, t));
            if (!snap.exists()) continue;

            Object.entries(snap.val()).forEach(([id, item]) => {
                if (item.uid === auth.currentUser.uid) {
                    const isMon = item.sponsored === true;
                    const div = document.createElement('div');
                    div.className = 'content-card';
                    div.innerHTML = `
                        <img src="${item.image || 'https://via.placeholder.com/50'}" class="content-thumb">
                        <div style="flex:1">
                            <div style="font-size:13px; font-weight:700;">${(item.title || item.question || 'Post').substring(0,18)}</div>
                            <div style="font-size:9px; color:var(--text-dim); text-transform:uppercase;">${t} â€¢ ${item.views || 0} Views</div>
                        </div>
                        <button class="mon-toggle" style="background:${isMon ? 'var(--accent)' : '#333'}; color:${isMon ? '#000' : '#888'};">
                            ${isMon ? 'MONETIZED' : 'MONETIZE'}
                        </button>
                    `;
                    container.appendChild(div);
                    div.querySelector('button').onclick = () => toggleMon(t, id, isMon);
                }
            });
        }
    }

    async function toggleMon(type, id, status) {
        const path = ref(db, `${type}/${id}`);
        if (!status) {
            const url = prompt("Enter Payout Link (https://):");
            if (url && url.includes('http')) {
                await update(path, { sponsored: true, link: url });
                loadManage();
            }
        } else {
            if (confirm("Disable monetization?")) {
                await update(path, { sponsored: null, link: null });
                loadManage();
            }
        }
    }

    onAuthStateChanged(auth, u => { if(u) { runAnalysis(); loadManage(); } });
</script>
</body>
</html>
