<!DOCTYPE html>
<html lang="en">
<head>
<script>(function(s){s.dataset.zone='9105850',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBX Community</title>
</head>
<body>
<style>
*{box-sizing:border-box;user-select:none;outline:none;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#121212;color:#fff;}
header{height:50px;display:flex;align-items:center;justify-content:space-between;background:#000;border-bottom:1px solid #2a2a2a;padding:0 12px;position:sticky;top:0;z-index:1000;}
.logo{height:36px;}
.header-right{display:flex;align-items:center;gap:12px;}
.profile{width:32px;height:32px;border-radius:50%;background-size:cover;background-position:center;cursor:pointer;border:2px solid #fff;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;opacity:1;}
.hamburger{width:32px;height:24px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;padding:2px;background:#000;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.5);transition: transform 0.2s;}
.hamburger div{height:4px;background:#fff;border-radius:6px;transition:all 0.3s ease;}
.hamburger.active div:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.active div:nth-child(2){opacity:0;}
.hamburger.active div:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}
.menu-overlay{position:fixed;top:50px;left:0;width:100%;height:100vh;background:#000;overflow-y:auto;transform:translateY(-100%);transition:transform 0.3s ease;z-index:900;display:flex;flex-direction:column;align-items:center;padding-top:20px;}
.menu-overlay.active{transform:translateY(0);}
.menu-overlay a{color:#fff;text-decoration:none;font-size:20px;margin:12px 0;font-weight:bold;}
.menu-overlay a:hover{color:#ccc;}
main{padding:20px;min-height:200vh;}

/* Profile Panel */
.profile-panel{position:fixed;top:0;left:0;width:100%;height:100vh;background:#111;transform:translateX(100%);transition:transform 0.3s ease;z-index:1100;display:flex;flex-direction:column;}
.profile-panel.active{transform:translateX(0);}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #222;}
.close-btn{background:#ff3b30;color:#fff;padding:6px 16px;font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:transform 0.2s;}
.close-btn:hover{transform:scale(1.05);}
.panel-top{display:flex;flex-direction:column;align-items:center;margin:20px 0;gap:12px;}
#panelProfilePic{width:100px;height:100px;border-radius:50%;border:3px solid #fff;background-size:cover;background-position:center;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;cursor:pointer;}
#userInfo{color:#fff;font-size:16px;display:flex;flex-direction:column;align-items:center;gap:6px;}
#copyLinkContainer{display:flex;align-items:center;gap:8px;width:90%;max-width:300px;}
#copyLinkContainer input{flex:1;padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;}
#copyLinkContainer button{background:#4caf50;color:#fff;border:none;padding:6px 12px;border-radius:12px;cursor:pointer;font-weight:bold;}
#copyStatus{font-size:12px;margin-top:6px;}
.spinner{border:4px solid #ccc;border-top:4px solid #4caf50;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin-top:6px;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
button.login-btn{background:#4caf50;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;}
.profile-panel .panel-header {
  background-color: #000; /* solid black */
  border-bottom: 1px solid #222; /* optional, keeps subtle separation */
}
#headerProfile, #panelProfilePic {
  background-image: url('https://i.imgur.com/cM3Givj.jpeg'); /* default */
  background-size: cover;
  background-position: center;
}
/* Disable text selection highlight */
* {
  user-select: none;       /* Prevent selecting text */
  -webkit-user-select: none; 
  -moz-user-select: none;
  -ms-user-select: none;
}

/* Remove input, textarea, button blue outline on focus */
input:focus,
textarea:focus,
button:focus,
select:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* Remove blue tap highlight on mobile */
* {
  -webkit-tap-highlight-color: transparent; 
}

/* Optional: remove link tap highlight */
a:focus, a:active {
  outline: none !important;
}
#panelProfilePic {
  position:relative;
}
#uploadSpinner {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  display:none;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#saveHandleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #fff; /* white edges */
  background: rgba(0,0,0,0.5); /* glassy black */
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  backdrop-filter: blur(6px); /* glass effect */
  transition: none; /* no hover/movement */
}

#saveHandleBtn:active {
  transform: none; /* no click movement */
}
</style>
<style>  
{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#121212; color:#fff; padding:20px;}  
h1 { text-align:center; font-size:24px; color:#00bfff; margin-bottom:20px; }  
  
.poll-feed-container {  
  display:flex;  
  overflow-x:auto;  
  gap:16px;  
  padding-bottom:16px;  
}  
.poll-feed-container::-webkit-scrollbar { height:6px; }  
.poll-feed-container::-webkit-scrollbar-thumb { background:#00bfff; border-radius:6px; }  
.poll-feed-container::-webkit-scrollbar-track { background:#1a1a1a; border-radius:6px; }  
  
.poll-card { flex:0 0 300px; background:#1c1c1c; border-radius:18px; padding:16px; border:1px solid rgba(255,255,255,0.1); }  
  
.poll-card h2 { color:#00bfff; font-size:18px; margin-bottom:10px; }  
  
ul { list-style:none; padding-left:0; margin-bottom:10px; }  
li { background:#181818; padding:10px 12px; border-radius:12px; margin-bottom:8px; cursor:pointer; position: relative; overflow: hidden; transition:0.2s; }  
.vote-bar { position:absolute; top:0; left:0; height:100%; background:#00bfff; width:0%; z-index:0; border-radius:12px; opacity:0.3; transition:width 0.3s; }  
.vote-label { position: relative; z-index:1; display:flex; justify-content: space-between; }  
  
.comments { background:#fff; color:#121212; border-radius:12px; padding:8px; max-height:110px; min-height:110px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-top:8px; }  
.comment { background:#f1f1f1; padding:6px 10px; border-radius:12px; display:flex; gap:10px; align-items:center; font-size:14px; }  
.comment img { width:28px; height:28px; border-radius:50%; object-fit:cover; }  
.comment span { display:block; }  
  
.comment-form { display:flex; gap:8px; margin-top:8px; }  
.comment-form input { flex:1; padding:8px 10px; border-radius:12px; border:none; background:#1a1a1a; color:#fff; }  
.comment-form button { padding:8px 12px; border-radius:12px; border:none; background:#00bfff; color:#121212; cursor:pointer; }  
  
.poll-author { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }  
.author-left { display:flex; align-items:center; gap:6px; }  
.author-left img { width:36px; height:36px; border-radius:50%; border:2px solid #00bfff; object-fit:cover; }  
.author-left span { font-weight:500; }  
.verified-badge { width:16px; height:16px; margin-left:4px; vertical-align:middle; }  
  
.follow-btn, .delete-btn { padding:6px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:500; }  
.follow-btn { background:#00bfff; color:#121212; }  
.follow-btn.following { background:#1a1a1a; color:#00bfff; border:1px solid #00bfff; }  
.delete-btn { background:#f44336; color:#fff; }  
  
.spinner { border:4px solid rgba(255,255,255,0.1); border-top:4px solid #00bfff; border-radius:50%; width:32px; height:32px; animation:spin 1s linear infinite; margin:30px auto; }  
  
.status-msg { text-align:center; margin:12px 0; font-size:14px; }  
  
.confirm-popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:999; display:none; }  
.confirm-popup .popup-content { background:#1c1c1c; padding:20px; border-radius:16px; width:90%; max-width:300px; text-align:center; }  
.confirm-popup button { margin:10px; padding:8px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:500; }  
.confirm-popup .confirm { background:#4caf50; color:#fff; }  
.confirm-popup .cancel { background:#f44336; color:#fff; }  
  
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}  
.comments {  
  background:#fff;   
  color:#121212;   
  border-radius:12px;   
  padding:8px;   
  height:110px; /* Fixed height */  
  overflow-y:auto;   
  display:flex;   
  flex-direction:column;   
  gap:6px;   
  margin-top:8px;  
}  
.comments {  
  background: rgba(255, 255, 255, 0.05); /* glassy effect */  
  backdrop-filter: blur(6px);  
  border-radius: 12px;   
  padding: 8px;   
  height: 110px; /* fixed height */  
  display: flex;   
  flex-direction: column;   
  gap: 6px;   
  margin-top: 8px;  
}  
  
.comment-counter {  
  align-self: flex-end;  
  padding: 4px 10px;  
  border-radius: 12px;  
  background: rgba(255, 255, 255, 0.1); /* glassy */  
  color: #fff;  
  font-size: 12px;  
  font-weight: 600;  
  border: 1px solid #fff; /* white edge */  
  flex-shrink: 0;  
}  
  
.comments-list {  
  overflow-y: auto;  
  flex: 1; /* take remaining space */  
}  
  
.comment-form input {  
  flex: 1;  
  padding: 8px 10px;  
  border-radius: 12px;  
  border: 1px solid #fff; /* white edge */  
  background: rgba(255, 255, 255, 0.05); /* glassy */  
  color: #fff;  
  outline: none;  
}  
  
.comment-form button {  
  padding: 8px 12px;  
  border-radius: 12px;  
  border: none;  
  background: rgba(255, 255, 255, 0.15); /* glassy */  
  color: #fff;  
  cursor: pointer;  
}  
.poll-feed-container, 
.poll-feed-container * {
    color: #fff !important;
}

/* Keep backgrounds and borders as you have them */
.poll-card { 
    background: #1c1c1c; 
    border-radius: 18px; 
    padding: 16px; 
    border: 1px solid rgba(255,255,255,0.1); 
}

/* Optional: vote labels */
.vote-label span {
    color: #fff !important;
}

/* Optional: comment text */
.comment span {
    color: #fff !important;
}

/* Author names */
.author-left span {
    color: #fff !important;
}
.comments {
  background: #000; /* black background */
  color: #fff; /* text white */
  border-radius: 12px;
  padding: 8px;
  height: 110px; /* fixed height */
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
  /* optional glassy blur effect */
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.1);
}

.comment {
  background: #181818; /* keep each comment slightly lighter */
  color: #fff;
}
</style>  
    <style>
        :root {
            --bg: #050505; --card: #121214; --glass: rgba(255, 255, 255, 0.08);
            --accent: #00A2FF; --green: #00E052; --red: #FF4B4B; --text: #FFFFFF;
            --text-dim: #8E8E93; --border: #242426;
        }
        #feed { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px;}

        /* Toasts */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { padding: 12px; border-radius: 12px; font-weight: 800; font-size: 14px; margin-bottom: 8px; animation: slideDown 0.4s ease forwards; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .toast.success { background: var(--green); color: #000; }
        .toast.error { background: var(--red); color: #fff; }

        /* Card Elements */
        .card { background: var(--card); border-radius: 30px; border: 2px solid var(--border); overflow: hidden; position: relative; }
        .header { padding: 15px; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 15px; border: 2px solid var(--border); object-fit: cover; cursor: pointer; }
        .post-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: zoom-in; background: #222; }
        
        .glass-title-row { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            margin: -25px 15px 10px 15px; padding: 15px; border-radius: 20px; border: 1px solid var(--glass);
            position: relative; z-index: 10; pointer-events: none;
        }

        .btn-action { 
            background: var(--accent); color: white; border: none; height: 35px; min-width: 95px; 
            border-radius: 12px; font-weight: 900; cursor: pointer; border-bottom: 4px solid #0072B3; 
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .btn-action.following { background: var(--green); border-bottom-color: #009e3a; color: #000; }
        
        /* Modals */
        .modal { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%; background: #111; border-radius: 30px 30px 0 0; z-index: 1000; transition: 0.4s cubic-bezier(0,1,0,1); padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; border-top: 2px solid var(--border); }
        .modal.active { bottom: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 999; backdrop-filter: blur(5px); }
        
        #fullImageModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10001; display: none; align-items: center; justify-content: center; }
        #fullImgSrc { max-width: 100%; max-height: 85%; object-fit: contain; }

        #end-msg { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--red); color: white; text-align: center; padding: 10px; font-weight: 900; z-index: 998; display: none; font-size: 12px; }
        
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
<header>
  <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="logo">
  <div class="header-right">
    <div class="profile" id="headerProfile"></div>
    <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <a href="#">Home</a>
  <a href="#">Community</a>
  <a href="#">Games</a>
  <a href="#">Events</a>
  <a href="#">Profile</a>
  <a href="#">Settings</a>
</div>

<div class="profile-panel" id="profilePanel">
  <div class="panel-header">
    <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="profile-logo" style="height:40px; object-fit:contain;">
    <button class="close-btn" id="closeProfile">Close</button>
  </div>
  <div class="panel-top">
    <div id="panelProfilePic"></div>
    <div id="userInfo"></div>
    <div id="copyLinkContainer">
      <input type="text" id="userLink" readonly>
      <button id="copyLinkBtn">Copy</button>
    </div>
    <span id="copyStatus"></span>
    <div class="spinner" id="uploadSpinner"></div>
    <input type="file" id="profileInput" accept="image/*" style="display:none;">
  </div>
<div class="panel-content" style="padding:20px; flex:1; display:flex; flex-direction:column;">
 <!-- Handle / Username Edit -->
<div id="handleContainer" style="display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:12px;">
  <input type="text" id="handleInput" placeholder="Username / Handle" 
         style="padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;width:60%;">
 <button id="saveHandleBtn">Save Handle</button>
  <span id="handleStatus" style="font-size:12px;color:#ccc;"></span>
</div>
  <!-- User Stats -->
  <div class="profile-stats" style="display:flex;justify-content:space-around;width:100%;margin-bottom:20px;">
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statPosts">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Posts</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowers">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Followers</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowing">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Following</p>
    </div>
  </div>


<div style="width:100%;background:#1a1a1a;padding:12px;border-radius:12px;margin-bottom:12px;">
  <h3 style="margin:0 0 8px 0;font-size:16px;">About Me</h3>
  <textarea id="userBioTextarea" maxlength="100" placeholder="Write something about yourself..." 
            style="width:100%;background:#222;color:#ccc;border:none;padding:8px;border-radius:8px;resize:none;font-size:14px;outline:none;"></textarea>
  <div id="bioCharCount" style="text-align:right;font-size:12px;color:#777;margin-top:4px;">0 / 100</div>
  <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <button id="saveProfileBtn" style="padding:8px 16px;border-radius:12px;border:none;background:#2196F3;color:#fff;font-weight:bold;cursor:pointer;flex-shrink:0;">Save Profile</button>
    <div class="spinner" id="saveProfileSpinner" style="width:20px;height:20px;border:3px solid #ccc;border-top:3px solid #4caf50;border-radius:50%;animation:spin 1s linear infinite;display:none;"></div>
    <span id="saveProfileStatus" style="font-size:12px;color:#4caf50;"></span>
  </div>
</div>

  </div>
</div>

<main style="padding:12px; background:#121212;">
  <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:bold; color:white; font-size:14px;">
    FEATURED PROFILES
    <img width="24" height="24" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified-badge"/>
  </div>

  <div id="userContainer" style="display:flex; overflow-x:auto; gap:12px; padding:8px 0; scrollbar-width:none;"></div>
<h1>Polls</h1>  
<div class="status-msg" id="statusMsg"></div>  
<div class="poll-feed-container" id="pollFeed"></div>  
<div class="spinner" id="spinner"></div>  
  
<div class="confirm-popup" id="confirmPopup">  
  <div class="popup-content">  
    <p id="confirmText">Are you sure you want to delete this poll?</p>  
    <button class="confirm" id="confirmYes">Yes</button>  
    <button class="cancel" id="confirmNo">Cancel</button>  
  </div>  
</div>  
  <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:bold; color:white; font-size:14px;">
    FEED
    <img width="24" height="24" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified-badge"/>
  </div>
<div id="toast-container"></div>
<div id="feed"></div>
<div id="end-msg">üõë YOU'VE REACHED THE END OF THE UNIVERSE</div>
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="fullImageModal" onclick="this.style.display='none'">
    <button style="position:absolute; top:40px; left:20px; background:var(--accent); color:white; border:none; padding:12px; border-radius:12px; font-weight:900;">‚Üê BACK</button>
    <img id="fullImgSrc" src="">
</div>

<div class="modal" id="detailsModal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="detTitle" style="margin:0; font-weight: 900; color:var(--accent);"></h2>
        <button id="repBtnMain" class="btn-action" style="min-width:70px; height:30px; background:var(--red); border-bottom-color:#b30000;">REPORT</button>
    </div>
    <div id="detCategory" style="color: var(--text-dim); font-size: 11px; font-weight: 900; margin-bottom: 10px;"></div>
    <div id="detStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    <div id="detDesc" style="background: #1c1c1e; padding: 20px; border-radius: 20px; margin-top: 20px; line-height: 1.6; color: #ddd; flex-grow: 1; overflow-y: auto; border: 1px solid var(--border);"></div>
</div>

<div class="modal" id="commentModal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">Comments</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; color:var(--text-dim); font-weight:900;">CLOSE</button>
    </div>
    <div id="commentList" style="flex-grow:1; overflow-y:auto;"></div>
    <div style="display:flex; gap:10px; padding-top:15px; border-top:1px solid var(--border);">
        <input type="text" id="cInput" placeholder="Write message..." style="flex-grow:1; background:#222; border:none; padding:15px; border-radius:15px; color:white;">
        <button onclick="sendComment()" class="btn-action" style="min-width:80px;">SEND</button>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, push, update, runTransaction, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* ================= CONFIG & INITIALIZATION ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= STATE & FEED VARIABLES ================= */
let currentUser = null;
let allPostIds = [];
let displayedCount = 0;
const batchSize = 5;
let currentActiveId = null;
let deletePollId = null;

/* ================= ELEMENTS ================= */
const hamburger = document.getElementById('hamburger');
const menuOverlay = document.getElementById('menuOverlay');
const headerProfile = document.getElementById('headerProfile');
const profilePanel = document.getElementById('profilePanel');
const closeProfile = document.getElementById('closeProfile');
const panelProfilePic = document.getElementById('panelProfilePic');
const userInfo = document.getElementById('userInfo');
const userLinkInput = document.getElementById('userLink');
const copyBtn = document.getElementById('copyLinkBtn');
const copyStatus = document.getElementById('copyStatus');
const uploadSpinner = document.getElementById('uploadSpinner');
const profileInput = document.getElementById('profileInput');
const userBioTextarea = document.getElementById('userBioTextarea');
const bioCharCount = document.getElementById('bioCharCount');
const statPosts = document.getElementById('statPosts');
const statFollowers = document.getElementById('statFollowers');
const statFollowing = document.getElementById('statFollowing');
const handleInput = document.getElementById('handleInput');
const saveHandleBtn = document.getElementById('saveHandleBtn');
const handleStatus = document.getElementById('handleStatus');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const saveProfileSpinner = document.getElementById('saveProfileSpinner');
const saveProfileStatus = document.getElementById('saveProfileStatus');
const featuredContainer = document.getElementById("userContainer");
const pollFeed = document.getElementById('pollFeed');
const spinner = document.getElementById('spinner');
const statusMsg = document.getElementById('statusMsg');
const confirmPopup = document.getElementById('confirmPopup');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

/* ================= UTILS ================= */
function notify(elOrMsg, msgOrType = 'success', ok = true, t = 3000) {
    if (typeof elOrMsg === 'string') {
        const container = document.getElementById('toast-container');
        if (container) {
            const toast = document.createElement('div');
            toast.className = `toast ${msgOrType}`;
            toast.innerText = elOrMsg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), t);
            return;
        }
    }
    const el = elOrMsg;
    const msg = msgOrType;
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? '#4caf50' : '#f44336';
    setTimeout(() => el.textContent = '', t);
}

function showStatus(msg, type = 'success') { notify(statusMsg, msg, type === 'success'); }
function randomColor() { return `hsl(${Math.random() * 360},80%,60%)`; }
function count(val) { if (!val) return 0; if (typeof val === 'number') return val; if (typeof val === 'object') return Object.keys(val).length; return 0; }
function createSpinner() { const s = document.createElement('div'); s.style.cssText = `width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;`; return s; }
function timeAgo(ts) { const now = Date.now(); const diff = now - ts; const sec = Math.floor(diff / 1000), min = Math.floor(sec / 60), hr = Math.floor(min / 60), day = Math.floor(hr / 24); if (day > 0) return `${day} day${day > 1 ? 's' : ''} ago`; if (hr > 0) return `${hr} hour${hr > 1 ? 's' : ''} ago`; if (min > 0) return `${min} min${min > 1 ? 's' : ''} ago`; return 'just now'; }
function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

/* ================= RATE LIMIT & STAT HELPERS ================= */
async function checkWeeklyLimit(type) {
    if (!currentUser) return null;
    const historyRef = ref(db, `users/${currentUser.uid}/updateHistory/${type}`);
    const snap = await get(historyRef);
    const now = Date.now();
    const oneWeek = 7 * 24 * 60 * 60 * 1000;
    
    // Filter history to last 7 days
    const recentChanges = (snap.val() || []).filter(ts => (now - ts) < oneWeek);
    
    if (recentChanges.length >= 2) return null; 
    return [...recentChanges, now]; 
}

async function refreshStats() {
    if (!currentUser) return;
    const snap = await get(ref(db, `users/${currentUser.uid}`));
    const data = snap.val() || {};
    if (statPosts) statPosts.textContent = count(data.posts);
    if (statFollowers) statFollowers.textContent = count(data.followers);
    
    // For "Following", we check the dedicated path
    const followSnap = await get(ref(db, `following/${currentUser.uid}`));
    if (statFollowing) statFollowing.textContent = count(followSnap.val());
}

/* ================= PROFILE ACTIONS ================= */
hamburger?.addEventListener('click', () => { hamburger.classList.toggle('active'); menuOverlay.classList.toggle('active'); });
headerProfile?.addEventListener('click', () => { profilePanel.classList.add('active'); document.body.style.overflow = 'hidden'; });
closeProfile?.addEventListener('click', () => { profilePanel.classList.remove('active'); document.body.style.overflow = 'auto'; });
copyBtn?.addEventListener('click', () => { if (!userLinkInput.value || userLinkInput.value.includes('Login')) return; navigator.clipboard.writeText(userLinkInput.value); notify(copyStatus, 'Copied'); });

// Handle Input: Enforce 12-character limit
handleInput?.addEventListener('input', () => {
    if (handleInput.value.length > 12) {
        handleInput.value = handleInput.value.substring(0, 12);
        notify(handleStatus, 'Max 12 characters', false);
    }
});

// Profile Picture Upload
panelProfilePic?.addEventListener('click', () => profileInput.click());
profileInput?.addEventListener('change', async () => {
    if (!profileInput.files[0] || !currentUser) return;

    const newHistory = await checkWeeklyLimit('profilePic');
    if (!newHistory) return notify(saveProfileStatus, 'Limit: 2 changes per week', false);

    uploadSpinner.style.display = 'block';
    const formData = new FormData();
    formData.append('image', profileInput.files[0]);

    try {
        const res = await fetch('https://api.imgur.com/3/image', { 
            method: 'POST', 
            headers: { Authorization: 'Client-ID 891e5bb4aa94282' }, 
            body: formData 
        });
        const data = await res.json();
        
        if (data.success) {
            const updates = {};
            updates[`users/${currentUser.uid}/profilePic`] = data.data.link;
            updates[`users/${currentUser.uid}/updateHistory/profilePic`] = newHistory;
            
            await update(ref(db), updates);
            panelProfilePic.style.backgroundImage = `url(${data.data.link})`;
            headerProfile.style.backgroundImage = `url(${data.data.link})`;
            notify(saveProfileStatus, 'Profile picture updated!');
        } else {
            notify(saveProfileStatus, 'Upload failed!', false);
        }
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Upload error!', false);
    }
    uploadSpinner.style.display = 'none';
});

// Consolidated Profile Save
saveProfileBtn?.addEventListener('click', async () => {
    if (!currentUser) return;

    const h = handleInput.value.trim();
    const b = userBioTextarea.value;

    if (h.length < 3) return notify(saveProfileStatus, 'Handle too short', false);
    if (h.length > 12) return notify(saveProfileStatus, 'Handle max 12 chars', false);

    saveProfileSpinner.style.display = 'block';

    try {
        const newHistory = await checkWeeklyLimit('profileInfo');
        if (!newHistory) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Limit: 2 changes per week', false);
        }

        const allSnap = await get(ref(db, 'users'));
        const allUsers = allSnap.val() || {};
        const taken = Object.entries(allUsers).some(([uid, u]) => 
            u.handle?.toLowerCase() === h.toLowerCase() && uid !== currentUser.uid
        );

        if (taken) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Handle already taken!', false);
        }

        const updates = {};
        updates[`users/${currentUser.uid}/handle`] = h;
        updates[`users/${currentUser.uid}/bio`] = b;
        updates[`users/${currentUser.uid}/updateHistory/profileInfo`] = newHistory;

        await update(ref(db), updates);
        await refreshStats();
        notify(saveProfileStatus, 'Profile saved!');
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Save error!', false);
    }
    saveProfileSpinner.style.display = 'none';
});

saveHandleBtn?.addEventListener('click', () => saveProfileBtn.click());

/* ================= FEATURED USERS & POLLS ================= */
async function loadFeaturedUsers() {
    if (!featuredContainer) return;
    try {
        const snap = await get(ref(db, 'users'));
        if (!snap.exists()) { featuredContainer.innerHTML = "<p style='color:#888;'>No users found.</p>"; return; }
        let allUsers = Object.entries(snap.val());
        allUsers.sort(() => 0.5 - Math.random());
        const featured10 = allUsers.slice(0, 10);
        featuredContainer.innerHTML = '';
        let myFollowing = new Set();
        if (currentUser) {
            const fSnap = await get(ref(db, `following/${currentUser.uid}`));
            if (fSnap.exists()) myFollowing = new Set(Object.keys(fSnap.val()));
        }
        featured10.forEach(([uid, user]) => {
            const div = document.createElement('div');
            div.style.cssText = "flex:0 0 auto; width:70px; display:flex; flex-direction:column; align-items:center;";
            const imgWrapper = document.createElement('div');
            imgWrapper.style.cssText = `width:60px;height:60px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid #fff;transition:border-color 1s;`;
            const img = document.createElement('img');
            img.src = user.profilePic || 'https://via.placeholder.com/60?text=?';
            img.style.cssText = "width:100%;height:100%;object-fit:cover;";
            imgWrapper.appendChild(img); div.appendChild(imgWrapper);
            setInterval(() => { imgWrapper.style.borderColor = randomColor(); }, 1000);
            const handleDiv = document.createElement('div');
            handleDiv.textContent = '@' + (user.handle || 'user');
            handleDiv.style.cssText = "max-width:70px;font-size:10px;color:#fff;margin-top:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
            div.appendChild(handleDiv);
            const followerDiv = document.createElement('div');
            followerDiv.style.cssText = "font-size:9px;color:#bbb;text-align:center;margin-top:2px;";
            div.appendChild(followerDiv);
            const button = document.createElement('button');
            button.style.cssText = "margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;background:#2e89ff;color:#fff;cursor:pointer;text-align:center;";
            div.appendChild(button);
            const msg = document.createElement('span');
            msg.style.cssText = "color:#ff6b6b;font-size:10px;margin-top:2px;display:none;text-align:center;";
            div.appendChild(msg);

            async function updateButton() {
                const fSnap = await get(ref(db, `users/${uid}/followers`));
                followerDiv.textContent = count(fSnap.val()) + ' followers';
                if (!currentUser) { button.textContent = 'Follow'; button.style.background = '#2e89ff'; return; }
                const isFollowing = myFollowing.has(uid);
                button.textContent = isFollowing ? 'Following' : 'Follow';
                button.style.background = isFollowing ? '#4caf50' : '#2e89ff';
            }
            updateButton();

            button.addEventListener('click', async () => {
                if (!currentUser) { msg.textContent = "Only logged in users can follow"; msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); return; }
                const spinnerIcon = createSpinner(); button.innerHTML = ''; button.appendChild(spinnerIcon); button.disabled = true;
                const path = ref(db, `following/${currentUser.uid}/${uid}`);
                const snapF = await get(path);
                if (!snapF.exists()) {
                    await set(path, true);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => (c || 0) + 1);
                    myFollowing.add(uid);
                } else {
                    await set(path, null);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => Math.max((c || 0) - 1, 0));
                    myFollowing.delete(uid);
                }
                if (statFollowing) statFollowing.textContent = myFollowing.size;
                updateButton(); button.disabled = false;
            });
            featuredContainer.appendChild(div);
        });
    } catch (e) { console.error(e); }
}

async function loadPolls() {
    if (!pollFeed) return;
    if (spinner) spinner.style.display = 'block';
    try {
        const snap = await get(ref(db, '/poll'));
        if (!snap.exists()) return;
        let polls = Object.entries(snap.val());
        polls = shuffleArray(polls);
        let following = [];
        if (currentUser) {
            const followingSnap = await get(ref(db, `/following/${currentUser.uid}`));
            if (followingSnap.exists()) following = Object.keys(followingSnap.val());
        }
        pollFeed.innerHTML = '';
        for (const [id, data] of polls) renderPoll(id, data, following);
    } catch (e) { console.error(e); showStatus('Error loading polls', 'error'); }
    finally { if (spinner) spinner.style.display = 'none'; }
}

async function renderPoll(pollId, data, following = []) {
    const card = document.createElement('div'); card.className = 'poll-card'; card.dataset.uid = data.uid;
    const authorSection = document.createElement('div'); authorSection.className = 'poll-author';
    const authorLeft = document.createElement('div'); authorLeft.className = 'author-left';
    const profileImg = document.createElement('img'); profileImg.src = 'default-avatar.png';
    const authorHandle = document.createElement('span'); authorHandle.textContent = '@user';
    authorLeft.append(profileImg, authorHandle); authorSection.append(authorLeft);

    const actionBtn = document.createElement('button');
    if (currentUser?.uid === data.uid) {
        actionBtn.className = 'delete-btn'; actionBtn.textContent = 'Delete';
        actionBtn.addEventListener('click', () => { deletePollId = pollId; confirmPopup.style.display = 'flex'; });
    } else {
        actionBtn.className = 'follow-btn';
        const isFollowing = following.includes(data.uid);
        actionBtn.textContent = isFollowing ? 'Following' : 'Follow';
        if (isFollowing) actionBtn.classList.add('following');
        actionBtn.addEventListener('click', async () => {
            if (!currentUser) { showStatus('Login required', 'error'); return; }
            const followRef = ref(db, `/users/${data.uid}/followers/${currentUser.uid}`);
            const followingRef = ref(db, `/following/${currentUser.uid}/${data.uid}`);
            const snap = await get(followRef);
            let state = !snap.exists();
            if (state) { await update(followRef, { timestamp: Date.now() }); await update(followingRef, { timestamp: Date.now() }); }
            else { await remove(followRef); await remove(followingRef); }
            document.querySelectorAll(`.poll-card[data-uid="${data.uid}"] .follow-btn`).forEach(btn => {
                btn.textContent = state ? 'Following' : 'Follow';
                btn.classList.toggle('following', state);
            });
        });
    }
    authorSection.append(actionBtn); card.appendChild(authorSection);
    get(ref(db, `/users/${data.uid}`)).then(uSnap => {
        const u = uSnap.val() || {}; profileImg.src = u.profilePic || 'default-avatar.png'; authorHandle.textContent = '@' + (u.handle || 'user');
        if (u.followers && Object.keys(u.followers).length >= 1000) {
            const badge = document.createElement('img'); badge.src = 'https://img.icons8.com/stickers/100/verified-badge.png';
            badge.className = 'verified-badge'; badge.style.cssText = 'width:16px;height:16px;margin-left:4px;'; authorHandle.appendChild(badge);
        }
    });

    const title = document.createElement('h2'); title.textContent = data.question; card.appendChild(title);
    const footer = document.createElement('div'); footer.style.cssText = 'display:flex;justify-content:space-between;font-size:12px;opacity:0.7;';
    const timeSpan = document.createElement('span'); timeSpan.textContent = timeAgo(data.timestamp || Date.now());
    const viewsSpan = document.createElement('span'); viewsSpan.textContent = 'Views: 0';
    footer.append(timeSpan, viewsSpan); card.appendChild(footer);
    runTransaction(ref(db, `/pollViews/${pollId}`), v => (v || 0) + 1).then(tx => { viewsSpan.textContent = `Views: ${tx.snapshot.val()}`; });

    const ul = document.createElement('ul'); card.appendChild(ul);
    data.options.forEach((opt, idx) => {
        const li = document.createElement('li'); li.innerHTML = `<div class="vote-bar"></div><div class="vote-label"><span>${opt}</span><span>0 votes</span></div>`;
        ul.appendChild(li);
        li.addEventListener('click', async () => {
            if (!currentUser) { showStatus('Login required', 'error'); return; }
            const userVoteRef = ref(db, `/pollVotes/${pollId}/${currentUser.uid}`);
            const votedSnap = await get(userVoteRef);
            if (votedSnap.exists()) { showStatus('You already voted', 'error'); return; }
            await runTransaction(ref(db, `/poll/${pollId}/votes/${idx}`), v => (v || 0) + 1);
            await update(userVoteRef, { option: idx });
            showStatus('Vote submitted', 'success');
        });
    });

    onValue(ref(db, `/poll/${pollId}/votes`), snap => {
        const votes = snap.val() || {}; const total = Object.values(votes).reduce((a, b) => a + b, 0) || 1;
        card.querySelectorAll('li').forEach((li, i) => {
            const c = votes[i] || 0; const p = Math.round((c / total) * 100);
            li.querySelector('.vote-bar').style.width = p + '%';
            li.querySelector('.vote-label span:last-child').textContent = `${c} votes (${p}%)`;
        });
    });

    const commentsDiv = document.createElement('div'); commentsDiv.className = 'comments'; commentsDiv.style.cssText = 'display:flex;flex-direction:column;height:110px;';
    const counter = document.createElement('div'); counter.className = 'comment-counter'; counter.textContent = 'Comments: 0';
    const list = document.createElement('div'); list.className = 'comments-list'; list.style.cssText = 'flex:1;overflow-y:auto;';
    commentsDiv.append(counter, list); card.appendChild(commentsDiv);

    const form = document.createElement('form'); form.className = 'comment-form';
    form.innerHTML = `<input type="text" placeholder="Add comment" required><button type="submit">Post</button>`;
    card.appendChild(form);

    onValue(ref(db, `/pollComments/${pollId}`), async snap => {
        const comments = snap.val() || {}; list.innerHTML = '';
        const sorted = Object.entries(comments).sort((a, b) => a[1].timestamp - b[1].timestamp);
        counter.textContent = `Comments: ${sorted.length}`;
        for (const [key, c] of sorted) {
            const userSnap = await get(ref(db, `/users/${c.uid}`));
            const u = userSnap.val() || {};
            const div = document.createElement('div'); div.className = 'comment';
            div.innerHTML = `<img src="${u.profilePic || 'default-avatar.png'}" alt="avatar"><span><strong>@${u.handle || 'user'}</strong> (${timeAgo(c.timestamp)}): ${c.text}</span>`;
            list.appendChild(div);
        }
    });

    form.addEventListener('submit', async e => {
        e.preventDefault(); const inp = form.querySelector('input'); if (!currentUser || !inp.value.trim()) return;
        await push(ref(db, `/pollComments/${pollId}`), { text: inp.value.trim(), uid: currentUser.uid, timestamp: Date.now() });
        inp.value = '';
    });
    pollFeed.appendChild(card);
}

/* ================= FEED (POSTS) LOGIC ================= */
async function startUniverse() {
    const snap = await get(ref(db, 'post'));
    if (!snap.exists()) return;
    allPostIds = Object.entries(snap.val()).sort(() => Math.random() - 0.5);
    const feed = document.getElementById('feed'); if (feed) feed.innerHTML = '';
    displayedCount = 0; renderBatch();
}

function renderBatch() {
    const feed = document.getElementById('feed'); if (!feed) return;
    if (displayedCount >= allPostIds.length) { document.getElementById('end-msg').style.display = 'block'; return; }
    const batch = allPostIds.slice(displayedCount, displayedCount + batchSize);
    batch.forEach(([id, post]) => {
        const card = document.createElement('div'); card.className = 'card'; feed.appendChild(card);
        onValue(ref(db, `post/${id}`), (pSnap) => {
            const p = pSnap.val(); if (!p) return;
            onValue(ref(db, `users/${p.uid}`), (uSnap) => {
                const u = uSnap.val() || {}; const fc = count(u.followers); const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
                card.innerHTML = `
                <div class="header">
                  <img src="${u.profilePic || ''}" class="avatar" onclick="window.location.href='/profile?user=${p.uid}'">
                  <div style="flex-grow:1; cursor:pointer;" onclick="window.location.href='/profile?user=${p.uid}'">
                    <div style="font-weight:900; display:flex; align-items:center; gap:4px;">@${u.handle || 'user'} ${fc >= 1000 ? '‚úÖ' : ''}</div>
                    <div style="font-size:10px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                  </div>
                  <button class="btn-action follow-btn-${p.uid} ${isF ? 'following' : ''}" onclick="doFollow('${p.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                </div>
                <img src="${p.image}" class="post-img" onclick="viewFull('${p.image}')" ondblclick="doLike('${id}')">
                <div class="glass-title-row"><h3 style="margin:0; font-size:17px; font-weight:900; color:white;">${p.title}</h3></div>
                <div style="padding:0 16px 15px 16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="display:flex; gap:20px;">
                      <div onclick="doLike('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="${(p.likes && auth.currentUser && p.likes[auth.currentUser.uid]) ? 'var(--red)' : 'white'}"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        ${p.likeCount || 0}
                      </div>
                      <div onclick="openComments('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        ${p.comments ? Object.keys(p.comments).length : 0}
                      </div>
                    </div>
                    <span style="font-size:10px; color:var(--text-dim); font-weight:900;">${timeAgo(p.timestamp)}</span>
                  </div>
                  <div style="font-size:10px; color:var(--accent); font-weight:900; margin-bottom:5px;">${p.views || 0} VIEWS ‚Ä¢ ${p.category?.toUpperCase()}</div>
                  <div style="font-size:14px; line-height:1.4;">${p.description ? p.description.substring(0, 70) : ''}... <span style="color:var(--accent); font-weight:900; cursor:pointer;" onclick="openReadMore('${id}')">Read More</span></div>
                </div>`;
            });
        });
    });
    displayedCount += batchSize;
}

/* ================= WINDOW GLOBALS ================= */
window.openComments = (id) => {
        currentActiveId = id;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('commentModal').classList.add('active');
        onValue(ref(db, `post/${id}/comments`), async (snap) => {
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            if (!snap.exists()) return;
            for (const [cid, c] of Object.entries(snap.val())) {
                const u = (await get(ref(db, `users/${c.uid}`))).val() || {};
                const fc = count(u.followers);
                const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
                let linkUI = "";
                if (c.text.includes("http")) {
                    const url = c.text.match(/\bhttps?:\/\/\S+/gi)[0];
                    linkUI = `<div style="margin-top:10px; border:1px solid var(--border); border-radius:15px; overflow:hidden;">
                        <span style="font-size:10px; color:var(--red); font-weight:900; background:rgba(255,75,75,0.1); padding:5px; text-align:center; display:block;">‚ö†Ô∏è CLICK AT YOUR OWN RISK</span>
                        <iframe src="${url}" width="100%" height="120px" style="border:none; background:white;"></iframe>
                        <a href="https://otieu.com/4/7950037" target="_blank" style="background:var(--green); display:block; text-align:center; padding:10px; color:black; font-weight:900; text-decoration:none;">VISIT SECURELY</a>
                    </div>`;
                }
                list.innerHTML += `<div style="padding:15px 0; border-bottom:1px solid #222;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <img src="${u.profilePic}" style="width:35px; height:35px; border-radius:10px; cursor:pointer;" onclick="window.location.href='/profile?user=${c.uid}'">
                        <div style="flex-grow:1; cursor:pointer;" onclick="window.location.href='/profile?user=${c.uid}'">
                            <div style="font-weight:900; font-size:12px;">@${u.handle}</div>
                            <div style="font-size:9px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                        </div>
                        <button class="btn-action follow-btn-${c.uid} ${isF ? 'following' : ''}" style="min-width:75px; height:28px; font-size:8px;" onclick="doFollow('${c.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                        <button onclick="submitReport('${cid}', 'comment')" style="background:none; border:none; color:var(--red); font-weight:900; font-size:10px;">REPORT</button>
                    </div>
                    <div style="padding-left:45px; font-size:13px;">${c.text.replace(/\bhttps?:\/\/\S+/gi, '[Link Shared]')}</div>
                    <div style="padding-left:45px;">${linkUI}</div>
                </div>`;
            }
        });
    };

    window.submitReport = async (tid, type) => {
        if(!auth.currentUser) return notify("Login required", "error");
        await push(ref(db, 'reports'), { tid, type, reporter: auth.currentUser.uid, time: Date.now() });
        notify("Report submitted", "error");
    };

    window.sendComment = async () => {
        const val = document.getElementById('cInput').value;
        if(!val || !auth.currentUser) return;
        await push(ref(db, `post/${currentActiveId}/comments`), { uid: auth.currentUser.uid, text: val, timestamp: Date.now() });
        document.getElementById('cInput').value = "";
    };

window.doFollow = async (uid) => {
    if (!auth.currentUser) return notify("Login required", "error");
    const fRef = ref(db, `users/${uid}/followers/${auth.currentUser.uid}`);
    const snap = await get(fRef); const active = snap.exists();
    await update(ref(db, `users/${uid}/followers`), { [auth.currentUser.uid]: active ? null : true });
    
    // Manage following list
    const myFRef = ref(db, `following/${auth.currentUser.uid}/${uid}`);
    if(!active) await set(myFRef, true); else await remove(myFRef);

    document.querySelectorAll(`.follow-btn-${uid}`).forEach(btn => { btn.classList.toggle('following', !active); btn.innerText = !active ? 'FOLLOWING' : 'FOLLOW'; });
    refreshStats();
};

window.doLike = (id) => {
    if (!auth.currentUser) return notify("Login required", "error");
    runTransaction(ref(db, `post/${id}`), (p) => {
        if (p) { p.likes = p.likes || {}; if (p.likes[auth.currentUser.uid]) { delete p.likes[auth.currentUser.uid]; p.likeCount = Math.max(0, (p.likeCount || 1) - 1); } else { p.likes[auth.currentUser.uid] = true; p.likeCount = (p.likeCount || 0) + 1; } } return p;
    });
};

window.openReadMore = async (id) => {
    const p = (await get(ref(db, `post/${id}`))).val();
    document.getElementById('detTitle').innerText = p.title;
    document.getElementById('detCategory').innerText = `CATEGORY: ${p.category?.toUpperCase()}`;
    document.getElementById('detStats').innerHTML = `<div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">üëÅÔ∏è ${p.views || 0} Views</div><div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">‚ù§Ô∏è ${p.likeCount || 0} Likes</div>`;
    document.getElementById('detDesc').innerText = p.description;
    document.getElementById('overlay').style.display = 'block'; document.getElementById('detailsModal').classList.add('active');
    runTransaction(ref(db, `post/${id}/views`), v => (v || 0) + 1);
};

window.viewFull = (src) => { document.getElementById('fullImgSrc').src = src; document.getElementById('fullImageModal').style.display = 'flex'; };
window.closeAllModals = () => { document.getElementById('overlay').style.display = 'none'; document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); };

/* ================= AUTH & INITIAL LOAD ================= */
onAuthStateChanged(auth, async user => {
    currentUser = user || null;
    if (user) {
        const uid = user.uid;
        userLinkInput.value = `${location.origin}/profile?uid=${uid}`;
        refreshStats();
        
        const snap = await get(ref(db, `users/${uid}`));
        const data = snap.val() || {};
        handleInput.value = data.handle || 'user';
        userBioTextarea.value = data.bio || '';
        
        if (data.profilePic) { 
            headerProfile.style.backgroundImage = `url(${data.profilePic})`; 
            panelProfilePic.style.backgroundImage = `url(${data.profilePic})`; 
        }
    } else {
        userLinkInput.value = 'Login to get link';
    }
    loadFeaturedUsers();
    loadPolls();
    startUniverse();
});

confirmNo?.addEventListener('click', () => { confirmPopup.style.display = 'none'; deletePollId = null; });
confirmYes?.addEventListener('click', async () => {
    if (!deletePollId) return;
    await remove(ref(db, `/poll/${deletePollId}`));
    await remove(ref(db, `/pollVotes/${deletePollId}`));
    await remove(ref(db, `/pollComments/${deletePollId}`));
    confirmPopup.style.display = 'none'; loadPolls();
});

window.onscroll = () => { if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) renderBatch(); };
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, push, update, runTransaction, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* ================= CONFIG & INITIALIZATION ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ================= STATE & FEED VARIABLES ================= */
let currentUser = null;
let allPostIds = [];
let displayedCount = 0;
const batchSize = 5;
let currentActiveId = null;
let deletePollId = null;

/* ================= ELEMENTS ================= */
const hamburger = document.getElementById('hamburger');
const menuOverlay = document.getElementById('menuOverlay');
const headerProfile = document.getElementById('headerProfile');
const profilePanel = document.getElementById('profilePanel');
const closeProfile = document.getElementById('closeProfile');
const panelProfilePic = document.getElementById('panelProfilePic');
const userInfo = document.getElementById('userInfo');
const userLinkInput = document.getElementById('userLink');
const copyBtn = document.getElementById('copyLinkBtn');
const copyStatus = document.getElementById('copyStatus');
const uploadSpinner = document.getElementById('uploadSpinner');
const profileInput = document.getElementById('profileInput');
const userBioTextarea = document.getElementById('userBioTextarea');
const bioCharCount = document.getElementById('bioCharCount');
const statPosts = document.getElementById('statPosts');
const statFollowers = document.getElementById('statFollowers');
const statFollowing = document.getElementById('statFollowing');
const handleInput = document.getElementById('handleInput');
const saveHandleBtn = document.getElementById('saveHandleBtn');
const handleStatus = document.getElementById('handleStatus');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const saveProfileSpinner = document.getElementById('saveProfileSpinner');
const saveProfileStatus = document.getElementById('saveProfileStatus');
const featuredContainer = document.getElementById("userContainer");
const pollFeed = document.getElementById('pollFeed');
const spinner = document.getElementById('spinner');
const statusMsg = document.getElementById('statusMsg');
const confirmPopup = document.getElementById('confirmPopup');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

/* ================= UTILS ================= */
function notify(elOrMsg, msgOrType = 'success', ok = true, t = 2000) {
    if (typeof elOrMsg === 'string') {
        const container = document.getElementById('toast-container');
        if (container) {
            const toast = document.createElement('div');
            toast.className = `toast ${msgOrType}`;
            toast.innerText = elOrMsg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
            return;
        }
    }
    const el = elOrMsg;
    const msg = msgOrType;
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? '#4caf50' : '#f44336';
    setTimeout(() => el.textContent = '', t);
}

function showStatus(msg, type = 'success') { notify(statusMsg, msg, type === 'success'); }
function randomColor() { return `hsl(${Math.random() * 360},80%,60%)`; }
function count(val) { if (!val) return 0; if (typeof val === 'number') return val; if (typeof val === 'object') return Object.keys(val).length; return 0; }
function createSpinner() { const s = document.createElement('div'); s.style.cssText = `width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;`; return s; }
function timeAgo(ts) { const now = Date.now(); const diff = now - ts; const sec = Math.floor(diff / 1000), min = Math.floor(sec / 60), hr = Math.floor(min / 60), day = Math.floor(hr / 24); if (day > 0) return `${day} day${day > 1 ? 's' : ''} ago`; if (hr > 0) return `${hr} hour${hr > 1 ? 's' : ''} ago`; if (min > 0) return `${min} min${min > 1 ? 's' : ''} ago`; return 'just now'; }
function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

/* ================= PROFILE ACTIONS ================= */
hamburger?.addEventListener('click', () => { hamburger.classList.toggle('active'); menuOverlay.classList.toggle('active'); });
headerProfile?.addEventListener('click', () => { profilePanel.classList.add('active'); document.body.style.overflow = 'hidden'; });
closeProfile?.addEventListener('click', () => { profilePanel.classList.remove('active'); document.body.style.overflow = 'auto'; });
copyBtn?.addEventListener('click', () => { if (!userLinkInput.value || userLinkInput.value.includes('Login')) return; navigator.clipboard.writeText(userLinkInput.value); notify(copyStatus, 'Copied'); });

/* ================= HELPERS ================= */
// Helper to manage notification styling
const notify = (el, msg, success = true) => {
    if (!el) return;
    el.textContent = msg;
    el.style.color = success ? '#4CAF50' : '#f44336';
    setTimeout(() => el.textContent = '', 3000);
};

// Helper to check the 2-changes-per-week limit
async function checkWeeklyLimit(type) {
    const historyRef = ref(db, `users/${currentUser.uid}/updateHistory/${type}`);
    const snap = await get(historyRef);
    const now = Date.now();
    const oneWeek = 7 * 24 * 60 * 60 * 1000;
    
    // Filter history to only include timestamps within the last 7 days
    const recentChanges = (snap.val() || []).filter(ts => (now - ts) < oneWeek);
    
    if (recentChanges.length >= 2) return null; // Limit reached
    return [...recentChanges, now]; // Return updated history array
}

// Helper to refresh UI stats from DB
async function refreshStats() {
    const snap = await get(ref(db, `users/${currentUser.uid}`));
    const data = snap.val() || {};
    if (statPosts) statPosts.textContent = data.posts || 0;
    if (statFollowers) statFollowers.textContent = data.followers || 0;
    if (statFollowing) statFollowing.textContent = data.following || 0;
}

/* ================= UPDATED EVENT LISTENERS ================= */

// 1. Handle Input: Enforce 12-character limit in real-time
handleInput?.addEventListener('input', () => {
    if (handleInput.value.length > 12) {
        handleInput.value = handleInput.value.substring(0, 12);
        notify(handleStatus, 'Max 12 characters', false);
    }
});

// 2. Profile Picture Upload
panelProfilePic?.addEventListener('click', () => profileInput.click());
profileInput?.addEventListener('change', async () => {
    if (!profileInput.files[0] || !currentUser) return;

    const newHistory = await checkWeeklyLimit('profilePic');
    if (!newHistory) return notify(saveProfileStatus, 'Limit: 2 changes per week', false);

    uploadSpinner.style.display = 'block';
    const formData = new FormData();
    formData.append('image', profileInput.files[0]);

    try {
        const res = await fetch('https://api.imgur.com/3/image', { 
            method: 'POST', 
            headers: { Authorization: 'Client-ID 891e5bb4aa94282' }, 
            body: formData 
        });
        const data = await res.json();
        
        if (data.success) {
            const updates = {};
            updates[`users/${currentUser.uid}/profilePic`] = data.data.link;
            updates[`users/${currentUser.uid}/updateHistory/profilePic`] = newHistory;
            
            await update(ref(db), updates);
            panelProfilePic.style.backgroundImage = `url(${data.data.link})`;
            headerProfile.style.backgroundImage = `url(${data.data.link})`;
            notify(saveProfileStatus, 'Profile picture updated!');
        } else {
            notify(saveProfileStatus, 'Upload failed!', false);
        }
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Upload error!', false);
    }
    uploadSpinner.style.display = 'none';
});

// 3. Consolidated Profile Save (Handle & Bio)
saveProfileBtn?.addEventListener('click', async () => {
    if (!currentUser) return;

    const h = handleInput.value.trim();
    const b = userBioTextarea.value;

    // Validation
    if (h.length < 3) return notify(saveProfileStatus, 'Handle too short', false);
    if (h.length > 12) return notify(saveProfileStatus, 'Handle max 12 chars', false);

    saveProfileSpinner.style.display = 'block';

    try {
        // Check Limit
        const newHistory = await checkWeeklyLimit('profileInfo');
        if (!newHistory) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Limit: 2 changes per week', false);
        }

        // Handle Availability Check
        const allSnap = await get(ref(db, 'users'));
        const allUsers = allSnap.val() || {};
        const taken = Object.entries(allUsers).some(([uid, u]) => 
            u.handle?.toLowerCase() === h.toLowerCase() && uid !== currentUser.uid
        );

        if (taken) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Handle already taken!', false);
        }

        // Save Data
        const updates = {};
        updates[`users/${currentUser.uid}/handle`] = h;
        updates[`users/${currentUser.uid}/bio`] = b;
        updates[`users/${currentUser.uid}/updateHistory/profileInfo`] = newHistory;

        await update(ref(db), updates);
        
        // Immediate Stat Refresh
        await refreshStats();
        
        notify(saveProfileStatus, 'Profile saved!');
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Save error!', false);
    }
    saveProfileSpinner.style.display = 'none';
});

// Optional: Also hook up the specific saveHandleBtn if it's visible
saveHandleBtn?.addEventListener('click', () => saveProfileBtn.click());


/* ================= FEATURED USERS & POLLS ================= */
async function loadFeaturedUsers() {
    if (!featuredContainer) return;
    try {
        const snap = await get(ref(db, 'users'));
        if (!snap.exists()) { featuredContainer.innerHTML = "<p style='color:#888;'>No users found.</p>"; return; }
        let allUsers = Object.entries(snap.val());
        allUsers.sort(() => 0.5 - Math.random());
        const featured10 = allUsers.slice(0, 10);
        featuredContainer.innerHTML = '';
        let myFollowing = new Set();
        if (currentUser) {
            const fSnap = await get(ref(db, `following/${currentUser.uid}`));
            if (fSnap.exists()) myFollowing = new Set(Object.keys(fSnap.val()));
        }
        featured10.forEach(([uid, user]) => {
            const div = document.createElement('div');
            div.style.cssText = "flex:0 0 auto; width:70px; display:flex; flex-direction:column; align-items:center;";
            const imgWrapper = document.createElement('div');
            imgWrapper.style.cssText = `width:60px;height:60px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid #fff;transition:border-color 1s;`;
            const img = document.createElement('img');
            img.src = user.profilePic || 'https://via.placeholder.com/60?text=?';
            img.style.cssText = "width:100%;height:100%;object-fit:cover;";
            imgWrapper.appendChild(img); div.appendChild(imgWrapper);
            setInterval(() => { imgWrapper.style.borderColor = randomColor(); }, 1000);
            const handleDiv = document.createElement('div');
            handleDiv.textContent = '@' + (user.handle || 'user');
            handleDiv.style.cssText = "max-width:70px;font-size:10px;color:#fff;margin-top:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
            div.appendChild(handleDiv);
            const followerDiv = document.createElement('div');
            followerDiv.style.cssText = "font-size:9px;color:#bbb;text-align:center;margin-top:2px;";
            div.appendChild(followerDiv);
            const button = document.createElement('button');
            button.style.cssText = "margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;background:#2e89ff;color:#fff;cursor:pointer;text-align:center;";
            div.appendChild(button);
            const msg = document.createElement('span');
            msg.style.cssText = "color:#ff6b6b;font-size:10px;margin-top:2px;display:none;text-align:center;";
            div.appendChild(msg);

            async function updateButton() {
                const fSnap = await get(ref(db, `users/${uid}/followers`));
                followerDiv.textContent = count(fSnap.val()) + ' followers';
                if (!currentUser) { button.textContent = 'Follow'; button.style.background = '#2e89ff'; return; }
                const isFollowing = myFollowing.has(uid);
                button.textContent = isFollowing ? 'Following' : 'Follow';
                button.style.background = isFollowing ? '#4caf50' : '#2e89ff';
            }
            updateButton();

            button.addEventListener('click', async () => {
                if (!currentUser) { msg.textContent = "Only logged in users can follow"; msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); return; }
                const spinnerIcon = createSpinner(); button.innerHTML = ''; button.appendChild(spinnerIcon); button.disabled = true;
                const path = ref(db, `following/${currentUser.uid}/${uid}`);
                const snapF = await get(path);
                if (!snapF.exists()) {
                    await set(path, true);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => (c || 0) + 1);
                    myFollowing.add(uid);
                } else {
                    await set(path, null);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => Math.max((c || 0) - 1, 0));
                    myFollowing.delete(uid);
                }
                if (statFollowing) statFollowing.textContent = myFollowing.size;
                updateButton(); button.disabled = false;
            });
            featuredContainer.appendChild(div);
        });
    } catch (e) { console.error(e); }
}

async function loadPolls() {
    if (!pollFeed) return;
    if (spinner) spinner.style.display = 'block';
    try {
        const snap = await get(ref(db, '/poll'));
        if (!snap.exists()) return;
        let polls = Object.entries(snap.val());
        polls = shuffleArray(polls);
        let following = [];
        if (currentUser) {
            const followingSnap = await get(ref(db, `/following/${currentUser.uid}`));
            if (followingSnap.exists()) following = Object.keys(followingSnap.val());
        }
        pollFeed.innerHTML = '';
        for (const [id, data] of polls) renderPoll(id, data, following);
    } catch (e) { console.error(e); showStatus('Error loading polls', 'error'); }
    finally { if (spinner) spinner.style.display = 'none'; }
}

async function renderPoll(pollId, data, following = []) {
    const card = document.createElement('div'); card.className = 'poll-card'; card.dataset.uid = data.uid;
    const authorSection = document.createElement('div'); authorSection.className = 'poll-author';
    const authorLeft = document.createElement('div'); authorLeft.className = 'author-left';
    const profileImg = document.createElement('img'); profileImg.src = 'default-avatar.png';
    const authorHandle = document.createElement('span'); authorHandle.textContent = '@user';
    authorLeft.append(profileImg, authorHandle); authorSection.append(authorLeft);

    const actionBtn = document.createElement('button');
    if (currentUser?.uid === data.uid) {
        actionBtn.className = 'delete-btn'; actionBtn.textContent = 'Delete';
        actionBtn.addEventListener('click', () => { deletePollId = pollId; confirmPopup.style.display = 'flex'; });
    } else {
        actionBtn.className = 'follow-btn';
        const isFollowing = following.includes(data.uid);
        actionBtn.textContent = isFollowing ? 'Following' : 'Follow';
        if (isFollowing) actionBtn.classList.add('following');
        actionBtn.addEventListener('click', async () => {
            if (!currentUser) { showStatus('Login required', 'error'); return; }
            const followRef = ref(db, `/users/${data.uid}/followers/${currentUser.uid}`);
            const followingRef = ref(db, `/following/${currentUser.uid}/${data.uid}`);
            const snap = await get(followRef);
            let state = !snap.exists();
            if (state) { await update(followRef, { timestamp: Date.now() }); await update(followingRef, { timestamp: Date.now() }); }
            else { await remove(followRef); await remove(followingRef); }
            document.querySelectorAll(`.poll-card[data-uid="${data.uid}"] .follow-btn`).forEach(btn => {
                btn.textContent = state ? 'Following' : 'Follow';
                btn.classList.toggle('following', state);
            });
        });
    }
    authorSection.append(actionBtn); card.appendChild(authorSection);
    get(ref(db, `/users/${data.uid}`)).then(uSnap => {
        const u = uSnap.val() || {}; profileImg.src = u.profilePic || 'default-avatar.png'; authorHandle.textContent = '@' + (u.handle || 'user');
        if (u.followers && Object.keys(u.followers).length >= 1000) {
            const badge = document.createElement('img'); badge.src = 'https://img.icons8.com/stickers/100/verified-badge.png';
            badge.className = 'verified-badge'; badge.style.cssText = 'width:16px;height:16px;margin-left:4px;'; authorHandle.appendChild(badge);
        }
    });

    const title = document.createElement('h2'); title.textContent = data.question; card.appendChild(title);
    const footer = document.createElement('div'); footer.style.cssText = 'display:flex;justify-content:space-between;font-size:12px;opacity:0.7;';
    const timeSpan = document.createElement('span'); timeSpan.textContent = timeAgo(data.timestamp || Date.now());
    const viewsSpan = document.createElement('span'); viewsSpan.textContent = 'Views: 0';
    footer.append(timeSpan, viewsSpan); card.appendChild(footer);
    runTransaction(ref(db, `/pollViews/${pollId}`), v => (v || 0) + 1).then(tx => { viewsSpan.textContent = `Views: ${tx.snapshot.val()}`; });

    const ul = document.createElement('ul'); card.appendChild(ul);
    data.options.forEach((opt, idx) => {
        const li = document.createElement('li'); li.innerHTML = `<div class="vote-bar"></div><div class="vote-label"><span>${opt}</span><span>0 votes</span></div>`;
        ul.appendChild(li);
        li.addEventListener('click', async () => {
            if (!currentUser) { showStatus('Login required', 'error'); return; }
            const userVoteRef = ref(db, `/pollVotes/${pollId}/${currentUser.uid}`);
            const votedSnap = await get(userVoteRef);
            if (votedSnap.exists()) { showStatus('You already voted', 'error'); return; }
            await runTransaction(ref(db, `/poll/${pollId}/votes/${idx}`), v => (v || 0) + 1);
            await update(userVoteRef, { option: idx });
            showStatus('Vote submitted', 'success');
        });
    });

    onValue(ref(db, `/poll/${pollId}/votes`), snap => {
        const votes = snap.val() || {}; const total = Object.values(votes).reduce((a, b) => a + b, 0) || 1;
        card.querySelectorAll('li').forEach((li, i) => {
            const c = votes[i] || 0; const p = Math.round((c / total) * 100);
            li.querySelector('.vote-bar').style.width = p + '%';
            li.querySelector('.vote-label span:last-child').textContent = `${c} votes (${p}%)`;
        });
    });

    const commentsDiv = document.createElement('div'); commentsDiv.className = 'comments'; commentsDiv.style.cssText = 'display:flex;flex-direction:column;height:110px;';
    const counter = document.createElement('div'); counter.className = 'comment-counter'; counter.textContent = 'Comments: 0';
    const list = document.createElement('div'); list.className = 'comments-list'; list.style.cssText = 'flex:1;overflow-y:auto;';
    commentsDiv.append(counter, list); card.appendChild(commentsDiv);

    const form = document.createElement('form'); form.className = 'comment-form';
    form.innerHTML = `<input type="text" placeholder="Add comment" required><button type="submit">Post</button>`;
    card.appendChild(form);

    onValue(ref(db, `/pollComments/${pollId}`), async snap => {
        const comments = snap.val() || {}; list.innerHTML = '';
        const sorted = Object.entries(comments).sort((a, b) => a[1].timestamp - b[1].timestamp);
        counter.textContent = `Comments: ${sorted.length}`;
        for (const [key, c] of sorted) {
            const userSnap = await get(ref(db, `/users/${c.uid}`));
            const u = userSnap.val() || {};
            const div = document.createElement('div'); div.className = 'comment';
            div.innerHTML = `<img src="${u.profilePic || 'default-avatar.png'}" alt="avatar"><span><strong>@${u.handle || 'user'}</strong> (${timeAgo(c.timestamp)}): ${c.text}</span>`;
            list.appendChild(div);
        }
    });

    form.addEventListener('submit', async e => {
        e.preventDefault(); const inp = form.querySelector('input'); if (!currentUser || !inp.value.trim()) return;
        await push(ref(db, `/pollComments/${pollId}`), { text: inp.value.trim(), uid: currentUser.uid, timestamp: Date.now() });
        inp.value = '';
    });
    pollFeed.appendChild(card);
}

/* ================= FEED (POSTS) LOGIC ================= */
async function startUniverse() {
    const snap = await get(ref(db, 'post'));
    if (!snap.exists()) return;
    allPostIds = Object.entries(snap.val()).sort(() => Math.random() - 0.5);
    const feed = document.getElementById('feed'); if (feed) feed.innerHTML = '';
    displayedCount = 0; renderBatch();
}

function renderBatch() {
    const feed = document.getElementById('feed'); if (!feed) return;
    if (displayedCount >= allPostIds.length) { document.getElementById('end-msg').style.display = 'block'; return; }
    const batch = allPostIds.slice(displayedCount, displayedCount + batchSize);
    batch.forEach(([id, post]) => {
        const card = document.createElement('div'); card.className = 'card'; feed.appendChild(card);
        onValue(ref(db, `post/${id}`), (pSnap) => {
            const p = pSnap.val(); if (!p) return;
            onValue(ref(db, `users/${p.uid}`), (uSnap) => {
                const u = uSnap.val() || {}; const fc = count(u.followers); const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
                card.innerHTML = `
                <div class="header">
                  <img src="${u.profilePic || ''}" class="avatar" onclick="window.location.href='/profile?user=${p.uid}'">
                  <div style="flex-grow:1; cursor:pointer;" onclick="window.location.href='/profile?user=${p.uid}'">
                    <div style="font-weight:900; display:flex; align-items:center; gap:4px;">@${u.handle || 'user'} ${fc >= 1000 ? '‚úÖ' : ''}</div>
                    <div style="font-size:10px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                  </div>
                  <button class="btn-action follow-btn-${p.uid} ${isF ? 'following' : ''}" onclick="doFollow('${p.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                </div>
                <img src="${p.image}" class="post-img" onclick="viewFull('${p.image}')" ondblclick="doLike('${id}')">
                <div class="glass-title-row"><h3 style="margin:0; font-size:17px; font-weight:900; color:white;">${p.title}</h3></div>
                <div style="padding:0 16px 15px 16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="display:flex; gap:20px;">
                      <div onclick="doLike('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="${(p.likes && auth.currentUser && p.likes[auth.currentUser.uid]) ? 'var(--red)' : 'white'}"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        ${p.likeCount || 0}
                      </div>
                      <div onclick="openComments('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        ${p.comments ? Object.keys(p.comments).length : 0}
                      </div>
                    </div>
                    <span style="font-size:10px; color:var(--text-dim); font-weight:900;">${timeAgo(p.timestamp)}</span>
                  </div>
                  <div style="font-size:10px; color:var(--accent); font-weight:900; margin-bottom:5px;">${p.views || 0} VIEWS ‚Ä¢ ${p.category?.toUpperCase()}</div>
                  <div style="font-size:14px; line-height:1.4;">${p.description ? p.description.substring(0, 70) : ''}... <span style="color:var(--accent); font-weight:900; cursor:pointer;" onclick="openReadMore('${id}')">Read More</span></div>
                </div>`;
            });
        });
    });
    displayedCount += batchSize;
}

/* ================= WINDOW GLOBALS ================= */
window.openComments = (id) => {
        currentActiveId = id;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('commentModal').classList.add('active');
        onValue(ref(db, `post/${id}/comments`), async (snap) => {
            const list = document.getElementById('commentList');
            list.innerHTML = "";
            if (!snap.exists()) return;
            for (const [cid, c] of Object.entries(snap.val())) {
                const u = (await get(ref(db, `users/${c.uid}`))).val() || {};
                const fc = u.followers ? Object.keys(u.followers).length : 0;
                const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
                let linkUI = "";
                if (c.text.includes("http")) {
                    const url = c.text.match(/\bhttps?:\/\/\S+/gi)[0];
                    linkUI = `<div style="margin-top:10px; border:1px solid var(--border); border-radius:15px; overflow:hidden;">
                        <span style="font-size:10px; color:var(--red); font-weight:900; background:rgba(255,75,75,0.1); padding:5px; text-align:center; display:block;">‚ö†Ô∏è CLICK AT YOUR OWN RISK</span>
                        <iframe src="${url}" width="100%" height="120px" style="border:none; background:white;"></iframe>
                        <a href="https://otieu.com/4/7950037" target="_blank" style="background:var(--green); display:block; text-align:center; padding:10px; color:black; font-weight:900; text-decoration:none;">VISIT SECURELY</a>
                    </div>`;
                }
                list.innerHTML += `<div style="padding:15px 0; border-bottom:1px solid #222;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <img src="${u.profilePic}" style="width:35px; height:35px; border-radius:10px; cursor:pointer;" onclick="window.location.href='/profile?user=${c.uid}'">
                        <div style="flex-grow:1; cursor:pointer;" onclick="window.location.href='/profile?user=${c.uid}'">
                            <div style="font-weight:900; font-size:12px;">@${u.handle}</div>
                            <div style="font-size:9px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                        </div>
                        <button class="btn-action follow-btn-${c.uid} ${isF ? 'following' : ''}" style="min-width:75px; height:28px; font-size:8px;" onclick="doFollow('${c.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                        <button onclick="submitReport('${cid}', 'comment')" style="background:none; border:none; color:var(--red); font-weight:900; font-size:10px;">REPORT</button>
                    </div>
                    <div style="padding-left:45px; font-size:13px;">${c.text.replace(/\bhttps?:\/\/\S+/gi, '[Link Shared]')}</div>
                    <div style="padding-left:45px;">${linkUI}</div>
                </div>`;
            }
        });
    };

    window.submitReport = async (tid, type) => {
        if(!auth.currentUser) return notify("Login required", "error");
        await push(ref(db, 'reports'), { tid, type, reporter: auth.currentUser.uid, time: Date.now() });
        notify("Report submitted", "error");
    };

    window.sendComment = async () => {
        const val = document.getElementById('cInput').value;
        if(!val || !auth.currentUser) return;
        await push(ref(db, `post/${currentActiveId}/comments`), { uid: auth.currentUser.uid, text: val, timestamp: Date.now() });
        document.getElementById('cInput').value = "";
    };

window.doFollow = async (uid) => {
    if (!auth.currentUser) return notify("Login required", "error");
    const fRef = ref(db, `users/${uid}/followers/${auth.currentUser.uid}`);
    const snap = await get(fRef); const active = snap.exists();
    await update(ref(db, `users/${uid}/followers`), { [auth.currentUser.uid]: active ? null : true });
    document.querySelectorAll(`.follow-btn-${uid}`).forEach(btn => { btn.classList.toggle('following', !active); btn.innerText = !active ? 'FOLLOWING' : 'FOLLOW'; });
};

window.doLike = (id) => {
    if (!auth.currentUser) return notify("Login required", "error");
    runTransaction(ref(db, `post/${id}`), (p) => {
        if (p) { p.likes = p.likes || {}; if (p.likes[auth.currentUser.uid]) { delete p.likes[auth.currentUser.uid]; p.likeCount = Math.max(0, (p.likeCount || 1) - 1); } else { p.likes[auth.currentUser.uid] = true; p.likeCount = (p.likeCount || 0) + 1; } } return p;
    });
};

window.openReadMore = async (id) => {
    const p = (await get(ref(db, `post/${id}`))).val();
    document.getElementById('detTitle').innerText = p.title;
    document.getElementById('detCategory').innerText = `CATEGORY: ${p.category?.toUpperCase()}`;
    document.getElementById('detStats').innerHTML = `<div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">üëÅÔ∏è ${p.views || 0} Views</div><div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">‚ù§Ô∏è ${p.likeCount || 0} Likes</div>`;
    document.getElementById('detDesc').innerText = p.description;
    document.getElementById('overlay').style.display = 'block'; document.getElementById('detailsModal').classList.add('active');
    runTransaction(ref(db, `post/${id}/views`), v => (v || 0) + 1);
};

window.viewFull = (src) => { document.getElementById('fullImgSrc').src = src; document.getElementById('fullImageModal').style.display = 'flex'; };
window.closeAllModals = () => { document.getElementById('overlay').style.display = 'none'; document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); };

/* ================= AUTH & INITIAL LOAD ================= */
onAuthStateChanged(auth, async user => {
    currentUser = user || null;
    if (user) {
        const uid = user.uid;
        userLinkInput.value = `${location.origin}/profile?uid=${uid}`;
        const snap = await get(ref(db, `users/${uid}`));
        const data = snap.val() || {};
        statFollowers.textContent = count(data.followers);
        statPosts.textContent = count(data.posts);
        handleInput.value = data.handle || 'user';
        if (data.profilePic) { headerProfile.style.backgroundImage = `url(${data.profilePic})`; panelProfilePic.style.backgroundImage = `url(${data.profilePic})`; }
    } else {
        userLinkInput.value = 'Login to get link';
    }
    loadFeaturedUsers();
    loadPolls();
    startUniverse();
});

confirmNo?.addEventListener('click', () => { confirmPopup.style.display = 'none'; deletePollId = null; });
confirmYes?.addEventListener('click', async () => {
    if (!deletePollId) return;
    await remove(ref(db, `/poll/${deletePollId}`));
    await remove(ref(db, `/pollVotes/${deletePollId}`));
    await remove(ref(db, `/pollComments/${deletePollId}`));
    confirmPopup.style.display = 'none'; loadPolls();
});

window.onscroll = () => { if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) renderBatch(); };
</script>



</main>
</body>
</html>