<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>View Post | RBX</title>
    <style>
        :root { --accent: #0095f6; --bg: #000; --card: #111; --border: #262626; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 50px; }

        /* Top Navigation */
        .nav-header { 
            position: sticky; top: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); z-index: 100;
        }
        .back-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; margin-right: 15px; }

        /* Post Container */
        .post-wrapper { max-width: 600px; margin: 0 auto; border-bottom: 1px solid var(--border); }
        
        .post-header { display: flex; align-items: center; padding: 12px; }
        .author-pfp { width: 35px; height: 35px; border-radius: 50%; background: #222; margin-right: 10px; border: 1px solid var(--border); }
        .author-info { flex: 1; }
        .author-handle { font-size: 14px; font-weight: 700; color: #fff; text-decoration: none; }

        /* Media */
        .post-media { width: 100%; background: #050505; min-height: 300px; display: flex; align-items: center; }
        .post-media img { width: 100%; height: auto; display: block; }

        /* Actions */
        .post-actions { padding: 12px 12px 8px; display: flex; gap: 18px; }
        .action-icon { font-size: 24px; cursor: pointer; transition: transform 0.1s; background: none; border: none; color: #fff; padding: 0; }
        .action-icon:active { transform: scale(1.2); }
        .heart.liked { color: #ff3040; animation: pop 0.3s ease; }

        @keyframes pop { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.3); } 
            100% { transform: scale(1); } 
        }

        /* Details */
        .post-details { padding: 0 12px 15px; }
        .like-count { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
        .caption { font-size: 14px; line-height: 1.5; color: #efefef; }
        .caption b { margin-right: 6px; }
        .post-time { font-size: 11px; color: #8e8e8e; margin-top: 8px; text-transform: uppercase; }

        #loading-view { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 200; }
    </style>
</head>
<body>

    <div id="loading-view">Loading...</div>

    <header class="nav-header">
        <button class="back-btn" onclick="history.back()">‚Üê</button>
        <div style="font-weight: 700;">Post</div>
    </header>

    <div class="post-wrapper">
        <div class="post-header">
            <div id="pfp" class="author-pfp"></div>
            <div class="author-info">
                <a id="handleLink" href="#" class="author-handle">loading...</a>
            </div>
        </div>

        <div class="post-media">
            <img id="postImg" src="" alt="">
        </div>

        <div class="post-actions">
            <button id="likeBtn" class="action-icon">‚ô°</button>
            <button class="action-icon">üí¨</button>
            <button class="action-icon">‚úà</button>
        </div>

        <div class="post-details">
            <div class="like-count"><span id="likesNum">0</span> likes</div>
            <div class="caption">
                <b id="capHandle">user</b>
                <span id="capText">...</span>
            </div>
            <div id="postDate" class="post-time">---</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, runTransaction } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        const config = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
            projectId: "itzhoyoo-f9f7e",
            appId: "1:1094792075584:web:d49e9cd31082a5"
        };

        const app = initializeApp(config);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Get ID from URL
        const params = new URLSearchParams(window.location.search);
        const postId = params.get('id');

        if (!postId) {
            document.body.innerHTML = "<div style='padding:50px; text-align:center'>Post not found.</div>";
        } else {
            initPost();
        }

        async function initPost() {
            // 1. Fetch Post Data
            onValue(ref(db, `post/${postId}`), (snap) => {
                const post = snap.val();
                if (!post) return;

                document.getElementById('postImg').src = post.image || post.url;
                document.getElementById('capText').innerText = post.caption || "";
                document.getElementById('postDate').innerText = post.createdAt || "Just now";
                
                const likes = post.likes ? Object.keys(post.likes).length : 0;
                document.getElementById('likesNum').innerText = likes;

                // 2. Fetch Author Data
                onValue(ref(db, `users/${post.uid}`), (uSnap) => {
                    const user = uSnap.val() || {};
                    document.getElementById('handleLink').innerText = user.handle || "user";
                    document.getElementById('handleLink').href = `profile.html?user=${post.uid}`;
                    document.getElementById('capHandle').innerText = user.handle || "user";
                    if(user.profilePic) document.getElementById('pfp').style.background = `url(${user.profilePic}) center/cover`;
                });

                // 3. Handle Likes (Auth required)
                onAuthStateChanged(auth, (currentUser) => {
                    const btn = document.getElementById('likeBtn');
                    const isLiked = currentUser && post.likes && post.likes[currentUser.uid];
                    
                    btn.innerText = isLiked ? "‚ù§Ô∏è" : "‚ô°";
                    btn.classList.toggle('liked', isLiked);

                    btn.onclick = () => {
                        if (!currentUser) return alert("Please log in to like!");
                        
                        const updates = {};
                        updates[`post/${postId}/likes/${currentUser.uid}`] = isLiked ? null : true;
                        update(ref(db), updates);
                    };
                });

                document.getElementById('loading-view').style.display = 'none';
            });
        }
    </script>
</body>
</html>
