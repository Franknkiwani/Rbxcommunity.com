<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Post View | RBX</title>
    <style>
        :root { --accent: #0095f6; --bg: #000; --card: #111; --border: #262626; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 60px; }

        /* Header */
        .nav-header { 
            position: sticky; top: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); z-index: 100;
        }
        .back-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; margin-right: 15px; }

        /* Post Content */
        .post-container { max-width: 600px; margin: 0 auto; }
        .post-header { display: flex; align-items: center; padding: 12px; }
        .author-pfp { width: 34px; height: 34px; border-radius: 50%; background: #222; margin-right: 10px; background-size: cover; background-position: center; }
        
        .media-box { width: 100%; background: #050505; display: flex; align-items: center; justify-content: center; }
        .media-box img { width: 100%; height: auto; display: block; }

        /* Info Section */
        .details { padding: 15px; border-bottom: 1px solid var(--border); }
        .post-title { font-size: 18px; font-weight: 800; margin: 0 0 5px 0; color: #fff; }
        .post-desc { font-size: 14px; color: #ccc; margin-bottom: 10px; line-height: 1.4; }
        .meta-info { font-size: 12px; color: #888; display: flex; gap: 15px; }

        /* Comments Section */
        .comments-section { padding: 15px; }
        .comments-title { font-size: 14px; font-weight: 700; margin-bottom: 15px; color: #888; }
        .comment-item { margin-bottom: 12px; font-size: 14px; }
        .comment-item b { color: var(--accent); margin-right: 5px; }

        /* Floating Comment Input */
        .comment-input-area {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #000;
            padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 10px;
        }
        .comment-input-area input {
            flex: 1; background: #1a1a1a; border: 1px solid var(--border);
            border-radius: 20px; padding: 8px 15px; color: #fff; outline: none;
        }
        .send-btn { background: none; border: none; color: var(--accent); font-weight: 700; cursor: pointer; }

        #loader { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 200; }
    </style>
</head>
<body>

    <div id="loader">Loading...</div>

    <nav class="nav-header">
        <button class="back-btn" onclick="history.back()">‚Üê</button>
        <span style="font-weight:700">Explore</span>
    </nav>

    <div class="post-container">
        <div class="post-header">
            <div id="uPfp" class="author-pfp"></div>
            <span id="uHandle" style="font-weight:700; font-size:14px;">@username</span>
        </div>

        <div class="media-box">
            <img id="postImg" src="" alt="">
        </div>

        <div class="details">
            <h1 id="postTitle" class="post-title">Post Title</h1>
            <p id="postDesc" class="post-desc">Loading description...</p>
            <div class="meta-info">
                <span><b id="likesNum">0</b> likes</span>
                <span><b id="viewsNum">0</b> views</span>
            </div>
        </div>

        <div class="comments-section">
            <div class="comments-title">Comments</div>
            <div id="commentsList"></div>
        </div>
    </div>

    <div class="comment-input-area">
        <input type="text" id="commentInput" placeholder="Add a comment...">
        <button class="send-btn" id="sendComment">Post</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set, runTransaction } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        const config = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
            projectId: "itzhoyoo-f9f7e",
            appId: "1:1094792075584:web:d49e9cd31082a5"
        };

        const app = initializeApp(config);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const postId = new URLSearchParams(window.location.search).get('id');

        if (!postId) {
            document.getElementById('loader').innerText = "Post Not Found";
        } else {
            initPost();
        }

        async function initPost() {
            // 1. Increment View Count (Runs only once per page load)
            const viewRef = ref(db, `post/${postId}/views`);
            runTransaction(viewRef, (currentViews) => (currentViews || 0) + 1);

            // 2. Load Post Data
            onValue(ref(db, `post/${postId}`), (snap) => {
                const post = snap.val();
                if (!post) return;

                document.getElementById('postImg').src = post.image || post.url;
                document.getElementById('postTitle').innerText = post.title || "Untitled Post";
                document.getElementById('postDesc').innerText = post.description || post.caption || "No description.";
                document.getElementById('viewsNum').innerText = post.views || 1;
                document.getElementById('likesNum').innerText = post.likes ? Object.keys(post.likes).length : 0;

                // Load Author
                onValue(ref(db, `users/${post.uid}`), (uSnap) => {
                    const u = uSnap.val();
                    document.getElementById('uHandle').innerText = `@${u.handle}`;
                    if(u.profilePic) document.getElementById('uPfp').style.backgroundImage = `url('${u.profilePic}')`;
                });

                document.getElementById('loader').style.display = 'none';
            });

            // 3. Load Comments
            onValue(ref(db, `post/${postId}/comments`), (snap) => {
                const list = document.getElementById('commentsList');
                list.innerHTML = "";
                if (snap.exists()) {
                    Object.values(snap.val()).forEach(c => {
                        const div = document.createElement('div');
                        div.className = "comment-item";
                        div.innerHTML = `<b>${c.user}:</b> ${c.text}`;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = "<div style='color:#444'>No comments yet.</div>";
                }
            });

            // 4. Handle Sending Comments
            onAuthStateChanged(auth, (user) => {
                document.getElementById('sendComment').onclick = () => {
                    const text = document.getElementById('commentInput').value;
                    if (!user) return alert("Log in to comment!");
                    if (!text.trim()) return;

                    // Get user handle first
                    onValue(ref(db, `users/${user.uid}/handle`), (hSnap) => {
                        const newCommentRef = push(ref(db, `post/${postId}/comments`));
                        set(newCommentRef, {
                            user: hSnap.val() || "User",
                            text: text,
                            timestamp: Date.now()
                        });
                        document.getElementById('commentInput').value = "";
                    }, { onlyOnce: true });
                };
            });
        }
    </script>
</body>
</html>
