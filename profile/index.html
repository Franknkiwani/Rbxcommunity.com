<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile | RBX</title>
    <style>
        :root { --accent: #2196F3; --red: #ff453a; --bg: #000; --card: #111; --border: #222; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Header Section */
        .profile-header { padding: 50px 20px 20px; text-align: center; border-bottom: 1px solid var(--border); }
        #uPfp { 
            width: 90px; height: 90px; border-radius: 50%; border: 2px solid #fff; 
            margin: 0 auto 15px; background-size: cover; background-position: center; background-color: var(--card);
        }
        #uHandle { font-size: 20px; font-weight: 900; letter-spacing: -0.5px; }
        #uBio { color: #888; font-size: 13px; margin: 10px auto; max-width: 80%; line-height: 1.4; }
        
        .stats-row { display: flex; justify-content: center; gap: 40px; margin: 15px 0; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-num { font-weight: 900; font-size: 17px; }
        .stat-label { font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 1px; }

        #followBtn {
            width: 100%; max-width: 250px; padding: 10px; border-radius: 10px; font-weight: 900;
            border: none; cursor: pointer; font-size: 13px; transition: 0.2s;
        }
        .btn-follow { background: #fff; color: #000; }
        .btn-unfollow { background: var(--red); color: #fff; }

        /* Tabs System */
        .tabs { display: flex; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg); z-index: 10; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 11px; font-weight: 900; color: #555; cursor: pointer; transition: 0.3s; }
        .tab.active { color: #fff; border-bottom: 2px solid #fff; }

        /* Content Grids */
        .content-container { padding: 2px; display: none; }
        .content-container.active { display: grid; }
        
        /* Posts & Stories Grid */
        .grid { grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .grid-item { aspect-ratio: 1/1; background: var(--card); background-size: cover; background-position: center; border-radius: 4px; }
        
        /* Polls List */
        .poll-list { display: flex; flex-direction: column; gap: 10px; padding: 15px; }
        .poll-item { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .poll-q { font-weight: 800; font-size: 14px; margin-bottom: 5px; }

        .back-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.1); border: none; color: #fff; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; z-index: 20; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="window.history.back()">âœ•</button>

    <div class="profile-header">
        <div id="uPfp"></div>
        <div id="uHandle">@loading</div>
        <div class="stats-row">
            <div class="stat-item"><span class="stat-num" id="count-followers">0</span><span class="stat-label">Followers</span></div>
            <div class="stat-item"><span class="stat-num" id="count-following">0</span><span class="stat-label">Following</span></div>
        </div>
        <div id="uBio">...</div>
        <button id="followBtn" style="display:none;">Follow</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('posts', this)">POSTS</div>
        <div class="tab" onclick="switchTab('polls', this)">POLLS</div>
        <div class="tab" onclick="switchTab('stories', this)">STORIES</div>
    </div>

    <div id="posts" class="content-container grid active"></div>
    <div id="polls" class="content-container poll-list"></div>
    <div id="stories" class="content-container grid"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        const config = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
            projectId: "itzhoyoo-f9f7e",
            appId: "1:1094792075584:web:d49e9cd31082a5"
        };

        const app = initializeApp(config);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const targetUID = new URLSearchParams(window.location.search).get('user');

        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-container').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(id).classList.add('active');
        };

        async function init() {
            if (!targetUID) return;

            // 1. Profile & Stats
            onValue(ref(db, `users/${targetUID}`), (snap) => {
                const d = snap.val() || {};
                document.getElementById('uHandle').innerText = "@" + (d.handle || "user");
                document.getElementById('uBio').innerText = d.bio || "";
                document.getElementById('count-followers').innerText = d.followers ? Object.keys(d.followers).length : 0;
                if (d.profilePic) document.getElementById('uPfp').style.backgroundImage = `url('${d.profilePic}')`;
            });

            onValue(ref(db, `following/${targetUID}`), s => {
                document.getElementById('count-following').innerText = s.exists() ? Object.keys(s.val()).length : 0;
            });

            // 2. Auth & Follow Logic
            onAuthStateChanged(auth, (user) => {
                const fBtn = document.getElementById('followBtn');
                if (!user || user.uid === targetUID) return;
                fBtn.style.display = 'inline-block';
                
                onValue(ref(db, `following/${user.uid}/${targetUID}`), (snap) => {
                    const isF = snap.exists();
                    fBtn.innerText = isF ? "Unfollow" : "Follow";
                    fBtn.className = isF ? "btn-unfollow" : "btn-follow";
                    fBtn.onclick = () => {
                        const updates = {};
                        updates[`following/${user.uid}/${targetUID}`] = isF ? null : true;
                        updates[`users/${targetUID}/followers/${user.uid}`] = isF ? null : true;
                        set(ref(db), updates); // Batch update
                    };
                });
            });

            // 3. Content Fetching (Filtered by targetUID)
            const fetchContent = (path, containerId, isGrid) => {
                onValue(ref(db, path), (snap) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = "";
                    if (!snap.exists()) { container.innerHTML = "<p style='grid-column:1/4; color:#333; padding:40px; text-align:center;'>No content yet</p>"; return; }
                    
                    Object.entries(snap.val()).forEach(([id, item]) => {
                        if (item.uid !== targetUID) return;
                        
                        const el = document.createElement('div');
                        if (isGrid) {
                            el.className = "grid-item";
                            el.style.backgroundImage = `url('${item.image}')`;
                            el.onclick = () => window.location.href = `/${path.slice(0,-1)}?id=${id}`;
                        } else {
                            el.className = "poll-item";
                            el.innerHTML = `<div class="poll-q">${item.question}</div><div style="font-size:10px; color:var(--accent)">VIEW POLL</div>`;
                            el.onclick = () => window.location.href = `/poll?id=${id}`;
                        }
                        container.appendChild(el);
                    });
                });
            };

            fetchContent('post', 'posts', true);
            fetchContent('poll', 'polls', false);
            fetchContent('story', 'stories', true);
        }

        init();
    </script>
</body>
</html>
