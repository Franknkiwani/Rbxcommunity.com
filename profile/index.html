<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile | RBX</title>
    <style>
        :root { --accent: #0095f6; --bg: #000; --card: #111; --border: #262626; --glass: rgba(255, 255, 255, 0.1); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; margin: 0; overflow-x: hidden; }

        /* Navigation Header */
        .nav-top { position: sticky; top: 0; background: #000; z-index: 500; display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); }
        .back-btn { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding-right: 20px; }

        /* Glassy Loader */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .shimmer {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%; animation: shine 1.5s infinite;
        }
        @keyframes shine { to { background-position: -200% 0; } }

        /* Profile Header */
        .profile-header { padding: 20px 20px 10px; text-align: center; }
        #uPfp { 
            width: 85px; height: 85px; border-radius: 50%; border: 2px solid #333; 
            margin: 0 auto 12px; background-size: cover; background-position: center; background-color: var(--card);
        }
        .handle-container { display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
        #uHandle { font-size: 20px; font-weight: 700; }
        .v-badge { width: 18px; height: 18px; display: none; }
        
        .view-bio-btn { color: var(--accent); font-size: 13px; font-weight: 600; margin-top: 8px; cursor: pointer; border: none; background: none; }

        /* Actions */
        .action-btns { display: flex; gap: 8px; justify-content: center; padding: 15px 20px; }
        .btn { flex: 1; max-width: 150px; padding: 8px; border-radius: 8px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; }
        .btn-follow { background: var(--accent); color: #fff; }
        .btn-unfollow { background: #333; color: #fff; }
        .btn-msg { background: #333; color: #fff; }

        /* Content Sections */
        .tabs { display: flex; border-top: 1px solid var(--border); margin-top: 10px; }
        .tab { flex: 1; padding: 12px; text-align: center; color: #888; cursor: pointer; font-size: 12px; font-weight: 700; }
        .tab.active { color: #fff; border-top: 2px solid #fff; margin-top: -1px; }

        .content-container { display: none; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; min-height: 200px; }
        .content-container.active { display: grid; }
        .empty-msg { grid-column: 1/4; text-align: center; padding: 60px 20px; color: #555; font-size: 14px; }
        .grid-item { aspect-ratio: 1/1; background: var(--card); background-size: cover; background-position: center; cursor: pointer; }

        /* About Modal */
        #aboutModal {
            position: fixed; bottom: -100%; left: 0; width: 100%; background: #181818;
            border-radius: 20px 20px 0 0; padding: 30px 20px; z-index: 2000;
            transition: bottom 0.4s cubic-bezier(0,1,0,1); border-top: 1px solid #333;
        }
        #aboutModal.open { bottom: 0; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; z-index: 1999; }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #222; font-size: 14px; }
        .info-label { color: #888; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="shimmer"></div>
        <p style="margin-top: 15px; color: #555; font-weight: 600; font-size: 12px; letter-spacing: 2px;">LOADING PROFILE</p>
    </div>

    <nav class="nav-top">
        <button class="back-btn" onclick="history.back()">‚Üê</button>
        <div style="font-weight: 700; font-size: 14px;">Profile</div>
    </nav>

    <div class="profile-header">
        <div id="uPfp"></div>
        <div class="handle-container" onclick="openAbout()">
            <span id="uHandle">@loading</span>
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="v-badge" id="vBadge">
        </div>
        <button class="view-bio-btn" onclick="openAbout()">View Bio & Info</button>
    </div>

    <div class="action-btns">
        <button id="followBtn" class="btn btn-follow" style="display:none;">Follow</button>
        <button id="msgBtn" class="btn btn-msg" style="display:none;">Message</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('posts', this)">POSTS</div>
        <div class="tab" onclick="switchTab('polls', this)">POLLS</div>
        <div class="tab" onclick="switchTab('stories', this)">STORIES</div>
    </div>

    <div id="posts" class="content-container active"></div>
    <div id="polls" class="content-container" style="grid-template-columns: 1fr; padding: 15px;"></div>
    <div id="stories" class="content-container"></div>

    <div class="modal-overlay" id="overlay" onclick="closeAbout()"></div>
    <div id="aboutModal">
        <h3 style="margin-top:0">About Account</h3>
        <div id="bioText" style="margin-bottom:20px; color:#ccc; font-size:14px;"></div>
        <div class="info-row"><span class="info-label">Joined</span><span id="info-date">-</span></div>
        <div class="info-row"><span class="info-label">Followers</span><span id="info-followers">0</span></div>
        <div class="info-row"><span class="info-label">Post Count</span><span id="info-posts">0</span></div>
        <div class="info-row"><span class="info-label">Poll Count</span><span id="info-polls">0</span></div>
        <div class="info-row"><span class="info-label">Story Count</span><span id="info-stories">0</span></div>
        <button class="btn btn-msg" style="width:100%; margin-top:20px; background:#fff; color:#000;" onclick="closeAbout()">Close</button>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const config = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    appId: "1:1094792075584:web:d49e9cd31082a5"
};

const app = initializeApp(config);
const db = getDatabase(app);
const auth = getAuth(app);

const targetUID = new URLSearchParams(window.location.search).get('user');

// Toast helper
function showToast(msg, type="success") {
    const container = document.getElementById('toastContainer');
    if(!container) return;
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerText = msg;
    container.appendChild(toast);
    setTimeout(()=>toast.remove(),3000);
}

window.openAbout = () => { 
    document.getElementById('aboutModal').classList.add('open'); 
    document.getElementById('overlay').style.display = 'block'; 
};
window.closeAbout = () => { 
    document.getElementById('aboutModal').classList.remove('open'); 
    document.getElementById('overlay').style.display = 'none'; 
};

window.switchTab = (id, el) => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content-container').forEach(c => c.classList.remove('active'));
    el.classList.add('active'); 
    document.getElementById(id).classList.add('active');
};

async function init() {
    if(!targetUID) return;

    // Load profile
    onValue(ref(db, `users/${targetUID}`), (snap) => {
        const d = snap.val() || {};
        document.getElementById('uHandle').innerText = d.handle || "user";
        document.getElementById('bioText').innerText = d.bio || "No bio available.";
        // Correct join date
        if(d.joined){
            const date = new Date(d.joined);
            document.getElementById('info-date').innerText = date.toLocaleDateString();
        } else {
            document.getElementById('info-date').innerText = "Long ago";
        }
        if(d.profilePic) document.getElementById('uPfp').style.backgroundImage = `url('${d.profilePic}')`;
        const followers = d.followers ? Object.keys(d.followers).length : 0;
        document.getElementById('info-followers').innerText = followers;
        document.getElementById('vBadge').style.display = followers >= 1000 ? "block" : "none";
    });

    // Show buttons regardless of auth
    const fBtn = document.getElementById('followBtn');
    const mBtn = document.getElementById('msgBtn');
    fBtn.style.display = 'block';
    mBtn.style.display = 'block';

    // Default inline messages if user not logged in
    const handleFollow = () => showToast("Login to follow users","warning");
    const handleMessage = () => showToast("Login to send messages","warning");

    onAuthStateChanged(auth, (user) => {
        if(!user || user.uid === targetUID){
            fBtn.onclick = handleFollow;
            mBtn.onclick = handleMessage;
            fBtn.innerText = "Follow";
            fBtn.className = "btn btn-follow";
            return;
        }

        // Logged in user logic
        mBtn.onclick = () => window.location.href = `/messages/?chat=${targetUID}`;

        onValue(ref(db, `following/${user.uid}/${targetUID}`), (snap) => {
            const isF = snap.exists();
            fBtn.innerText = isF ? "Unfollow" : "Follow";
            fBtn.className = isF ? "btn btn-unfollow" : "btn btn-follow";
            fBtn.onclick = () => {
                const updates = {};
                updates[`following/${user.uid}/${targetUID}`] = isF ? null : true;
                updates[`users/${targetUID}/followers/${user.uid}`] = isF ? null : true;
                update(ref(db), updates);
            };
        });
    });

    // Sections loader
    const loadSection = (path, divId, type) => {
        onValue(ref(db, path), (snap) => {
            const box = document.getElementById(divId);
            box.innerHTML = "";
            let count = 0;

            if(snap.exists()){
                Object.entries(snap.val()).forEach(([id,item])=>{
                    if(item.uid !== targetUID) return;
                    count++;
                    const el = document.createElement('div');

                    if(type==='grid'){
                        el.className="grid-item";
                        el.style.backgroundImage = `url('${item.image||item.url}')`;
                        el.onclick = () => window.location.href = `/${path}/?id=${id}`;
                    } else {
                        el.style.cssText = "background:#111; padding:15px; border-radius:12px; margin-bottom:8px; border:1px solid #222; cursor:pointer;";
                        el.innerHTML = `<div style="font-weight:700">${item.question || 'View Poll'}</div>`;
                        el.onclick = () => window.location.href = `/${path}/?id=${id}`;
                    }
                    box.appendChild(el);
                });
            }

            if(count===0) box.innerHTML = `<div class="empty-msg">No ${path}s yet</div>`;
            const counterEl = document.getElementById(`info-${path}s`);
            if(counterEl) counterEl.innerText = count;
        });
    };

    loadSection('post','posts','grid');
    loadSection('poll','polls','list');
    loadSection('story','stories','grid');

    setTimeout(()=>{
        const loader = document.getElementById('loader');
        if(loader){
            loader.style.opacity='0';
            setTimeout(()=>loader.style.display='none',500);
        }
    },2000);
}

init();
</script>

</body>
</html>
