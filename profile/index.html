<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile | RBX</title>
    <style>
        :root { --accent: #0095f6; --red: #ff453a; --bg: #000; --card: #111; --border: #222; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; }
        
        .profile-header { padding: 40px 20px 20px; text-align: center; border-bottom: 1px solid var(--border); }
        #uPfp { 
            width: 85px; height: 85px; border-radius: 50%; border: 2px solid #333; 
            margin: 0 auto 12px; background-size: cover; background-position: center; background-color: var(--card);
        }
        
        /* Handle & Verified Badge */
        .handle-container { display: flex; align-items: center; justify-content: center; gap: 5px; }
        #uHandle { font-size: 20px; font-weight: 700; }
        .v-badge { width: 18px; height: 18px; display: none; }

        #uBio { color: #efefef; font-size: 14px; margin: 8px auto; max-width: 90%; line-height: 1.4; white-space: pre-wrap; }
        
        .stats-row { display: flex; justify-content: center; gap: 30px; margin: 15px 0; }
        .stat-item { display: flex; flex-direction: column; min-width: 70px; }
        .stat-num { font-weight: 700; font-size: 18px; }
        .stat-label { font-size: 12px; color: #a8a8a8; }

        .btn-container { display: flex; justify-content: center; padding: 0 20px 15px; }
        #followBtn {
            width: 100%; max-width: 300px; padding: 8px; border-radius: 8px; font-weight: 600;
            border: none; cursor: pointer; font-size: 14px; transition: 0.2s; display: none;
        }
        .btn-follow { background: var(--accent); color: #fff; }
        .btn-unfollow { background: #333; color: #fff; border: 1px solid #444 !important; }

        /* Tabs */
        .tabs { display: flex; border-top: 1px solid var(--border); }
        .tab { flex: 1; padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #a8a8a8; cursor: pointer; }
        .tab.active { color: #fff; border-top: 2px solid #fff; margin-top: -1px; }

        .content-container { padding: 2px; display: none; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .content-container.active { display: grid; }
        .grid-item { aspect-ratio: 1/1; background: var(--card); background-size: cover; background-position: center; }
        
        .back-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; z-index: 20; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="window.history.back()">â€¹</button>

    <div class="profile-header">
        <div id="uPfp"></div>
        <div class="handle-container">
            <span id="uHandle">loading...</span>
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="v-badge" id="vBadge">
        </div>
        
        <div class="stats-row">
            <div class="stat-item"><span class="stat-num" id="count-followers">0</span><span class="stat-label">followers</span></div>
            <div class="stat-item"><span class="stat-num" id="count-following">0</span><span class="stat-label">following</span></div>
        </div>
        
        <div id="uBio"></div>
    </div>

    <div class="btn-container">
        <button id="followBtn">Follow</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('posts', this)">POSTS</div>
        <div class="tab" onclick="switchTab('polls', this)">POLLS</div>
        <div class="tab" onclick="switchTab('stories', this)">STORIES</div>
    </div>

    <div id="posts" class="content-container active"></div>
    <div id="polls" class="content-container" style="grid-template-columns: 1fr; padding: 15px;"></div>
    <div id="stories" class="content-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        const config = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
            projectId: "itzhoyoo-f9f7e",
            appId: "1:1094792075584:web:d49e9cd31082a5"
        };

        const app = initializeApp(config);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const targetUID = new URLSearchParams(window.location.search).get('user');

        window.switchTab = (id, el) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-container').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.getElementById(id).classList.add('active');
        };

        function init() {
            if (!targetUID) return;

            // 1. Core Profile Data (Bio, Handle, Pfp)
            onValue(ref(db, `users/${targetUID}`), (snap) => {
                const d = snap.val();
                if (!d) return;

                document.getElementById('uHandle').innerText = d.handle || "user";
                document.getElementById('uBio').innerText = d.bio || "";
                if (d.profilePic) document.getElementById('uPfp').style.backgroundImage = `url('${d.profilePic}')`;
                
                // Follower Count & Verified Badge
                const followerCount = d.followers ? Object.keys(d.followers).length : 0;
                document.getElementById('count-followers').innerText = followerCount;
                document.getElementById('vBadge').style.display = followerCount >= 1000 ? "block" : "none";
            });

            // 2. Following Count
            onValue(ref(db, `following/${targetUID}`), (snap) => {
                document.getElementById('count-following').innerText = snap.exists() ? Object.keys(snap.val()).length : 0;
            });

            // 3. Auth & Follow Interaction
            onAuthStateChanged(auth, (user) => {
                const fBtn = document.getElementById('followBtn');
                if (!user || user.uid === targetUID) {
                    fBtn.style.display = 'none';
                    return;
                }
                fBtn.style.display = 'block';

                onValue(ref(db, `following/${user.uid}/${targetUID}`), (snap) => {
                    const isF = snap.exists();
                    fBtn.innerText = isF ? "Unfollow" : "Follow";
                    fBtn.className = isF ? "btn-unfollow" : "btn-follow";

                    fBtn.onclick = () => {
                        const updates = {};
                        updates[`following/${user.uid}/${targetUID}`] = isF ? null : true;
                        updates[`users/${targetUID}/followers/${user.uid}`] = isF ? null : true;
                        update(ref(db), updates); 
                    };
                });
            });

            // 4. Content Sections
            const loadData = (path, divId, isGrid) => {
                onValue(ref(db, path), (snap) => {
                    const box = document.getElementById(divId);
                    box.innerHTML = "";
                    if (!snap.exists()) return;

                    Object.entries(snap.val()).forEach(([id, item]) => {
                        if (item.uid !== targetUID) return;
                        const el = document.createElement('div');
                        if (isGrid) {
                            el.className = "grid-item";
                            el.style.backgroundImage = `url('${item.image || item.url}')`;
                        } else {
                            el.style.cssText = "background:#111; padding:12px; border-radius:8px; margin-bottom:8px; border:1px solid #222";
                            el.innerHTML = `<div style="font-weight:700">${item.question}</div>`;
                        }
                        box.appendChild(el);
                    });
                });
            };

            loadData('post', 'posts', true);
            loadData('poll', 'polls', false);
            loadData('story', 'stories', true);
        }

        init();
    </script>
</body>
</html>
