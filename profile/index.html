<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | RBX</title>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        .profile-container { width: 100%; max-width: 400px; margin: 0 auto; padding: 60px 20px; text-align: center; }
        
        #uPfp { 
            width: 100px; height: 100px; border-radius: 50%; 
            border: 2px solid #fff; margin: 0 auto 15px;
            background-size: cover; background-position: center; background-color: #111;
        }
        #uHandle { font-size: 22px; font-weight: 900; }
        
        /* Stats row like Instagram */
        .stats-row { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-num { font-weight: 900; font-size: 18px; }
        .stat-label { font-size: 12px; color: #888; text-transform: uppercase; }

        #uBio { color: #ccc; font-size: 14px; margin-bottom: 25px; line-height: 1.4; }

        /* Follow Button Logic */
        #followBtn {
            width: 80%; padding: 12px; border-radius: 12px; font-weight: 900;
            border: none; cursor: pointer; transition: 0.3s; text-transform: uppercase;
        }
        .btn-follow { background: #fff; color: #000; }
        .btn-unfollow { background: #ff453a; color: #fff; }
        
        .back-btn { position: absolute; top: 20px; left: 20px; background: none; border: none; color: #fff; cursor: pointer; font-weight: 800; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="window.history.back()">‚Üê BACK</button>

    <div class="profile-container">
        <div id="uPfp"></div>
        <div id="uHandle">@loading...</div>
        
        <div class="stats-row">
            <div class="stat-item">
                <span class="stat-num" id="count-followers">0</span>
                <span class="stat-label">Followers</span>
            </div>
            <div class="stat-item">
                <span class="stat-num" id="count-following">0</span>
                <span class="stat-label">Following</span>
            </div>
        </div>

        <div id="uBio">...</div>
        <button id="followBtn" style="display:none;">Follow</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        const config = {
            apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
            authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
            databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
            projectId: "itzhoyoo-f9f7e",
            appId: "1:1094792075584:web:d49e9cd31082a5"
        };

        const app = initializeApp(config);
        const db = getDatabase(app);
        const auth = getAuth(app);

        const targetUID = new URLSearchParams(window.location.search).get('user');
        const followBtn = document.getElementById('followBtn');

        // Helper to count object keys
        const count = (obj) => obj ? Object.keys(obj).length : 0;

        async function initProfile() {
            if (!targetUID) return;

            // 1. Listen to Profile Data & Stats
            onValue(ref(db, `users/${targetUID}`), (snap) => {
                const data = snap.val();
                if (!data) return;

                document.getElementById('uHandle').innerText = "@" + (data.handle || "user");
                document.getElementById('uBio').innerText = data.bio || "No bio yet.";
                document.getElementById('count-followers').innerText = count(data.followers);
                if (data.profilePic) document.getElementById('uPfp').style.backgroundImage = `url('${data.profilePic}')`;
            });

            // 2. Listen to "Following" (Stored in your separate following node)
            onValue(ref(db, `following/${targetUID}`), (snap) => {
                document.getElementById('count-following').innerText = count(snap.val());
            });

            // 3. Handle Follow Logic
            onAuthStateChanged(auth, (user) => {
                if (!user || user.uid === targetUID) {
                    followBtn.style.display = 'none'; // Don't follow yourself
                    return;
                }

                followBtn.style.display = 'inline-block';
                const followRef = ref(db, `following/${user.uid}/${targetUID}`);
                const followerRef = ref(db, `users/${targetUID}/followers/${user.uid}`);

                onValue(followRef, (snap) => {
                    const isFollowing = snap.exists();
                    
                    if (isFollowing) {
                        followBtn.innerText = "Unfollow";
                        followBtn.className = "btn-unfollow";
                        followBtn.onclick = () => {
                            remove(followRef);
                            remove(followerRef);
                        };
                    } else {
                        followBtn.innerText = "Follow";
                        followBtn.className = "btn-follow";
                        followBtn.onclick = () => {
                            set(followRef, true);
                            set(followerRef, true);
                        };
                    }
                });
            });
        }

        initProfile();
    </script>
</body>
</html>
