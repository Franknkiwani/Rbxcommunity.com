<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Profile</title>
    <style>
        :root { --bg: #000; --text: #fff; --gray: #888; --border: #222; --accent: #fff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding-bottom: 50px; overflow-x: hidden; }
        
        /* Header Section */
        .profile-header { padding: 50px 20px 30px; text-align: center; border-bottom: 1px solid var(--border); }
        .pfp-circle { width: 110px; height: 110px; border-radius: 50%; margin: 0 auto 15px; background-size: cover; background-position: center; background-color: #111; border: 2px solid var(--border); }
        .username { font-size: 1.4rem; font-weight: 900; margin: 5px 0; letter-spacing: -0.5px; }
        .bio-text { font-size: 0.95rem; color: var(--gray); max-width: 350px; margin: 10px auto; line-height: 1.5; white-space: pre-wrap; }
        
        /* Tab Navigation */
        .tabs { display: flex; justify-content: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(0,0,0,0.95); z-index: 100; backdrop-filter: blur(10px); }
        .tab { padding: 18px 20px; font-size: 0.75rem; font-weight: 800; color: var(--gray); cursor: pointer; text-transform: uppercase; letter-spacing: 1.5px; transition: 0.2s; }
        .tab.active { color: var(--text); border-bottom: 2px solid var(--accent); }

        /* Grid for Media (Posts/Stories) */
        .section { display: none; padding: 2px; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        .media-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .media-item { aspect-ratio: 1/1; background-size: cover; background-position: center; background-color: #0a0a0a; border-radius: 2px; }
        
        /* Polls List */
        .poll-card { background: #0a0a0a; padding: 20px; border-bottom: 1px solid var(--border); margin-bottom: 1px; }
        .poll-question { font-weight: bold; font-size: 1rem; margin-bottom: 8px; }

        /* Navigation */
        .nav-top { position: fixed; top: 0; width: 100%; padding: 15px; z-index: 1000; display: flex; align-items: center; }
        .back-circle { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="nav-top">
        <button class="back-circle" onclick="window.history.back()">‚Üê</button>
    </div>

    <div class="profile-header">
        <div id="uPfp" class="pfp-circle"></div>
        <div id="uHandle" class="username">Loading...</div>
        <div id="uBio" class="bio-text"></div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="openTab('posts', this)">Posts</div>
        <div class="tab" onclick="openTab('polls', this)">Polls</div>
        <div class="tab" onclick="openTab('stories', this)">Stories</div>
    </div>

    <div id="postsSec" class="section active"><div id="postsGrid" class="media-grid"></div></div>
    <div id="pollsSec" class="section"><div id="pollsList"></div></div>
    <div id="storiesSec" class="section"><div id="storiesGrid" class="media-grid"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // UI Helpers
        window.openTab = (name, el) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name + 'Sec').classList.add('active');
            el.classList.add('active');
        };

        // Read URL Parameters
        const urlParams = new URLSearchParams(window.location.search);
        const targetUid = urlParams.get('user');

        if (!targetUid) {
            document.getElementById('uHandle').innerText = "Invalid User";
        } else {
            initProfile(targetUid);
        }

        async function initProfile(uid) {
            try {
                // 1. Fetch User Identity
                const userSnap = await get(ref(db, `users/${uid}`));
                if (userSnap.exists()) {
                    const data = userSnap.val();
                    document.getElementById('uPfp').style.backgroundImage = `url(${data.profilePic || ''})`;
                    document.getElementById('uHandle').innerText = `@${(data.handle || 'user').toLowerCase()}`;
                    document.getElementById('uBio').innerText = data.bio || "";
                } else {
                    document.getElementById('uHandle').innerText = "User Not Found";
                    return;
                }

                // 2. Pull User Content (Requires .indexOn: ["uid"] in Firebase Rules)
                
                // Fetch Posts
                fetchContent('posts', 'postsGrid', uid);
                
                // Fetch Polls
                fetchContent('polls', 'pollsList', uid);
                
                // Fetch Stories
                fetchContent('stories', 'storiesGrid', uid);

            } catch (err) {
                console.error("Profile Fetch Error:", err);
            }
        }

        async function fetchContent(path, containerId, uid) {
            const container = document.getElementById(containerId);
            try {
                const q = query(ref(db, path), orderByChild('uid'), equalTo(uid));
                const snap = await get(q);
                
                if (snap.exists()) {
                    container.innerHTML = "";
                    const items = Object.values(snap.val()).reverse();
                    
                    items.forEach(item => {
                        if (path === 'polls') {
                            const div = document.createElement('div');
                            div.className = 'poll-card';
                            div.innerHTML = `<div class="poll-question">${item.question}</div><div style="color:#444; font-size:11px;">View Poll Details</div>`;
                            container.appendChild(div);
                        } else {
                            const div = document.createElement('div');
                            div.className = 'media-item';
                            div.style.backgroundImage = `url(${item.imageUrl || item.url || ''})`;
                            container.appendChild(div);
                        }
                    });
                } else {
                    container.innerHTML = `<p style="grid-column:1/4; text-align:center; padding:50px; color:#333;">No ${path} found.</p>`;
                }
            } catch (e) {
                console.error(`Error fetching ${path}:`, e);
                container.innerHTML = `<p style="color:red; text-align:center;">Failed to load ${path}. Check Firebase Indexing Rules.</p>`;
            }
        }
    </script>
</body>
</html>
