<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile View</title>
    <style>
        :root { --bg: #000; --text: #fff; --gray: #888; --danger: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; }
        
        /* Status Pages (404, Banned, Blacklist) */
        .status-container { text-align: center; margin-top: 100px; padding: 20px; }
        .status-icon { font-size: 60px; margin-bottom: 20px; }
        .status-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        
        /* Profile UI */
        #profileUI { display: none; }
        .pfp { width: 100px; height: 100px; border-radius: 50%; background: #111; margin: 0 auto; background-size: cover; background-position: center; border: 1px solid #222; }
        .handle { text-align: center; font-size: 1.5rem; margin: 15px 0 5px; font-weight: 900; }
        .bio { text-align: center; color: var(--gray); margin-bottom: 30px; font-size: 0.9rem; line-height: 1.4; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .grid-item { aspect-ratio: 1/1; background-color: #0a0a0a; background-size: cover; background-position: center; }
        
        .back-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="window.history.back()">‚Üê Back</button>

    <div id="profileUI">
        <div id="uPfp" class="pfp"></div>
        <div id="uHandle" class="handle"></div>
        <div id="uBio" class="bio"></div>
        <div id="postsGrid" class="grid"></div>
    </div>

    <div id="statusUI" class="status-container" style="display:none;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            databaseURL: "...", 
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // 2. GET UID FROM URL
        const urlParams = new URLSearchParams(window.location.search);
        const targetUid = urlParams.get('user');

        if (!targetUid) {
            showStatus("404", "No user specified.", "üîç");
        } else {
            init(targetUid);
        }

        async function init(uid) {
            try {
                const userSnap = await get(ref(db, `users/${uid}`));
                
                // CHECK 1: DOES USER EXIST?
                if (!userSnap.exists()) {
                    showStatus("404", "User does not exist.", "‚ùì");
                    return;
                }

                const user = userSnap.val();

                // CHECK 2: BLACKLISTED
                if (user.isBlacklisted) {
                    showStatus("ACCESS DENIED", "System-wide blacklist active.", "‚ö†Ô∏è");
                    return;
                }

                // CHECK 3: BANNED
                if (user.isBanned) {
                    showStatus("BANNED", "This account has been suspended.", "üö´");
                    return;
                }

                // SHOW PROFILE
                document.getElementById('profileUI').style.display = 'block';
                document.getElementById('uHandle').innerText = "@" + (user.handle || "user");
                document.getElementById('uBio').innerText = user.bio || "No bio available.";
                document.getElementById('uPfp').style.backgroundImage = `url(${user.profilePic || ''})`;

                // LOAD POSTS
                loadPosts(uid);

            } catch (err) {
                console.error(err);
                showStatus("Error", "Something went wrong.", "‚ùå");
            }
        }

        async function loadPosts(uid) {
            const grid = document.getElementById('postsGrid');
            const q = query(ref(db, 'posts'), orderByChild('uid'), equalTo(uid));
            const snap = await get(q);
            
            if (snap.exists()) {
                Object.values(snap.val()).reverse().forEach(post => {
                    const div = document.createElement('div');
                    div.className = 'grid-item';
                    div.style.backgroundImage = `url(${post.imageUrl})`;
                    grid.appendChild(div);
                });
            } else {
                grid.innerHTML = "<p style='grid-column:1/4;text-align:center;color:#444;padding:40px;'>No posts yet.</p>";
            }
        }

        function showStatus(title, msg, icon) {
            const sUI = document.getElementById('statusUI');
            sUI.style.display = 'block';
            sUI.innerHTML = `
                <div class="status-icon">${icon}</div>
                <div class="status-title">${title}</div>
                <p style="color:#888;">${msg}</p>
                <button onclick="window.location.href='index.html'" style="background:#fff; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; margin-top:20px;">Return Home</button>
            `;
        }
    </script>
</body>
</html>
