<!DOCTYPE html>
<html lang="en">
<head>
<script>(function(s){s.dataset.zone='9105850',s.src='https://groleegni.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RBX Community</title>
</head>
<body>
<style>
*{box-sizing:border-box;user-select:none;outline:none;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#121212;color:#fff;}
header{height:50px;display:flex;align-items:center;justify-content:space-between;background:#000;border-bottom:1px solid #2a2a2a;padding:0 12px;position:sticky;top:0;z-index:1000;}
.logo{height:36px;}
.header-right{display:flex;align-items:center;gap:12px;}
.profile{width:32px;height:32px;border-radius:50%;background-size:cover;background-position:center;cursor:pointer;border:2px solid #fff;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;opacity:1;}
.hamburger{width:32px;height:24px;display:flex;flex-direction:column;justify-content:space-between;cursor:pointer;padding:2px;background:#000;border-radius:12px;box-shadow:2px 2px 6px rgba(0,0,0,0.5);transition: transform 0.2s;}
.hamburger div{height:4px;background:#fff;border-radius:6px;transition:all 0.3s ease;}
.hamburger.active div:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.hamburger.active div:nth-child(2){opacity:0;}
.hamburger.active div:nth-child(3){transform:rotate(-45deg) translate(5px,-5px);}
.menu-overlay{position:fixed;top:50px;left:0;width:100%;height:100vh;background:#000;overflow-y:auto;transform:translateY(-100%);transition:transform 0.3s ease;z-index:900;display:flex;flex-direction:column;align-items:center;padding-top:20px;}
.menu-overlay.active{transform:translateY(0);}
.menu-overlay a{color:#fff;text-decoration:none;font-size:20px;margin:12px 0;font-weight:bold;}
.menu-overlay a:hover{color:#ccc;}
main{padding:20px;min-height:200vh;}

/* Profile Panel */
.profile-panel{position:fixed;top:0;left:0;width:100%;height:100vh;background:#111;transform:translateX(100%);transition:transform 0.3s ease;z-index:1100;display:flex;flex-direction:column;}
.profile-panel.active{transform:translateX(0);}
.panel-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #222;}
.close-btn{background:#ff3b30;color:#fff;padding:6px 16px;font-size:16px;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:transform 0.2s;}
.close-btn:hover{transform:scale(1.05);}
.panel-top{display:flex;flex-direction:column;align-items:center;margin:20px 0;gap:12px;}
#panelProfilePic{width:100px;height:100px;border-radius:50%;border:3px solid #fff;background-size:cover;background-position:center;transition:border-color 1s ease, background-image 1s ease, opacity 1s ease;cursor:pointer;}
#userInfo{color:#fff;font-size:16px;display:flex;flex-direction:column;align-items:center;gap:6px;}
#copyLinkContainer{display:flex;align-items:center;gap:8px;width:90%;max-width:300px;}
#copyLinkContainer input{flex:1;padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;}
#copyLinkContainer button{background:#4caf50;color:#fff;border:none;padding:6px 12px;border-radius:12px;cursor:pointer;font-weight:bold;}
#copyStatus{font-size:12px;margin-top:6px;}
.spinner{border:4px solid #ccc;border-top:4px solid #4caf50;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin-top:6px;display:none;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
button.login-btn{background:#4caf50;color:#fff;border:none;padding:6px 16px;border-radius:12px;cursor:pointer;}
.profile-panel .panel-header {
  background-color: #000; /* solid black */
  border-bottom: 1px solid #222; /* optional, keeps subtle separation */
}
#headerProfile, #panelProfilePic {
  background-image: url('https://i.imgur.com/cM3Givj.jpeg'); /* default */
  background-size: cover;
  background-position: center;
}
/* Disable text selection highlight */
* {
  user-select: none;       /* Prevent selecting text */
  -webkit-user-select: none; 
  -moz-user-select: none;
  -ms-user-select: none;
}

/* Remove input, textarea, button blue outline on focus */
input:focus,
textarea:focus,
button:focus,
select:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* Remove blue tap highlight on mobile */
* {
  -webkit-tap-highlight-color: transparent; 
}

/* Optional: remove link tap highlight */
a:focus, a:active {
  outline: none !important;
}
#panelProfilePic {
  position:relative;
}
#uploadSpinner {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  display:none;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#saveHandleBtn {
  padding: 8px 16px;
  border-radius: 12px;
  border: 2px solid #fff; /* white edges */
  background: rgba(0,0,0,0.5); /* glassy black */
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  backdrop-filter: blur(6px); /* glass effect */
  transition: none; /* no hover/movement */
}

#saveHandleBtn:active {
  transform: none; /* no click movement */
}
</style>
<style>  
{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; background:#121212; color:#fff; padding:20px;}  
h1 { text-align:center; font-size:24px; color:#00bfff; margin-bottom:20px; }  
  
.poll-feed-container {  
  display:flex;  
  overflow-x:auto;  
  gap:16px;  
  padding-bottom:16px;  
}  
.poll-feed-container::-webkit-scrollbar { height:6px; }  
.poll-feed-container::-webkit-scrollbar-thumb { background:#00bfff; border-radius:6px; }  
.poll-feed-container::-webkit-scrollbar-track { background:#1a1a1a; border-radius:6px; }  
  
.poll-card { flex:0 0 300px; background:#1c1c1c; border-radius:18px; padding:16px; border:1px solid rgba(255,255,255,0.1); }  
  
.poll-card h2 { color:#00bfff; font-size:18px; margin-bottom:10px; }  
  
ul { list-style:none; padding-left:0; margin-bottom:10px; }  
li { background:#181818; padding:10px 12px; border-radius:12px; margin-bottom:8px; cursor:pointer; position: relative; overflow: hidden; transition:0.2s; }  
.vote-bar { position:absolute; top:0; left:0; height:100%; background:#00bfff; width:0%; z-index:0; border-radius:12px; opacity:0.3; transition:width 0.3s; }  
.vote-label { position: relative; z-index:1; display:flex; justify-content: space-between; }  
  
.comments { background:#fff; color:#121212; border-radius:12px; padding:8px; max-height:110px; min-height:110px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-top:8px; }  
.comment { background:#f1f1f1; padding:6px 10px; border-radius:12px; display:flex; gap:10px; align-items:center; font-size:14px; }  
.comment img { width:28px; height:28px; border-radius:50%; object-fit:cover; }  
.comment span { display:block; }  
  
.comment-form { display:flex; gap:8px; margin-top:8px; }  
.comment-form input { flex:1; padding:8px 10px; border-radius:12px; border:none; background:#1a1a1a; color:#fff; }  
.comment-form button { padding:8px 12px; border-radius:12px; border:none; background:#00bfff; color:#121212; cursor:pointer; }  
  
.poll-author { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }  
.author-left { display:flex; align-items:center; gap:6px; }  
.author-left img { width:36px; height:36px; border-radius:50%; border:2px solid #00bfff; object-fit:cover; }  
.author-left span { font-weight:500; }  
.verified-badge { width:16px; height:16px; margin-left:4px; vertical-align:middle; }  
  
.follow-btn, .delete-btn { padding:6px 12px; border-radius:12px; border:none; cursor:pointer; font-weight:500; }  
.follow-btn { background:#00bfff; color:#121212; }  
.follow-btn.following { background:#1a1a1a; color:#00bfff; border:1px solid #00bfff; }  
.delete-btn { background:#f44336; color:#fff; }  
  
.spinner { border:4px solid rgba(255,255,255,0.1); border-top:4px solid #00bfff; border-radius:50%; width:32px; height:32px; animation:spin 1s linear infinite; margin:30px auto; }  
  
.status-msg { text-align:center; margin:12px 0; font-size:14px; }  
  
.confirm-popup { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:999; display:none; }  
.confirm-popup .popup-content { background:#1c1c1c; padding:20px; border-radius:16px; width:90%; max-width:300px; text-align:center; }  
.confirm-popup button { margin:10px; padding:8px 14px; border:none; border-radius:12px; cursor:pointer; font-weight:500; }  
.confirm-popup .confirm { background:#4caf50; color:#fff; }  
.confirm-popup .cancel { background:#f44336; color:#fff; }  
  
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}  
.comments {  
  background:#fff;   
  color:#121212;   
  border-radius:12px;   
  padding:8px;   
  height:110px; /* Fixed height */  
  overflow-y:auto;   
  display:flex;   
  flex-direction:column;   
  gap:6px;   
  margin-top:8px;  
}  
.comments {  
  background: rgba(255, 255, 255, 0.05); /* glassy effect */  
  backdrop-filter: blur(6px);  
  border-radius: 12px;   
  padding: 8px;   
  height: 110px; /* fixed height */  
  display: flex;   
  flex-direction: column;   
  gap: 6px;   
  margin-top: 8px;  
}  
  
.comment-counter {  
  align-self: flex-end;  
  padding: 4px 10px;  
  border-radius: 12px;  
  background: rgba(255, 255, 255, 0.1); /* glassy */  
  color: #fff;  
  font-size: 12px;  
  font-weight: 600;  
  border: 1px solid #fff; /* white edge */  
  flex-shrink: 0;  
}  
  
.comments-list {  
  overflow-y: auto;  
  flex: 1; /* take remaining space */  
}  
  
.comment-form input {  
  flex: 1;  
  padding: 8px 10px;  
  border-radius: 12px;  
  border: 1px solid #fff; /* white edge */  
  background: rgba(255, 255, 255, 0.05); /* glassy */  
  color: #fff;  
  outline: none;  
}  
  
.comment-form button {  
  padding: 8px 12px;  
  border-radius: 12px;  
  border: none;  
  background: rgba(255, 255, 255, 0.15); /* glassy */  
  color: #fff;  
  cursor: pointer;  
}  
.poll-feed-container, 
.poll-feed-container * {
    color: #fff !important;
}

/* Keep backgrounds and borders as you have them */
.poll-card { 
    background: #1c1c1c; 
    border-radius: 18px; 
    padding: 16px; 
    border: 1px solid rgba(255,255,255,0.1); 
}

/* Optional: vote labels */
.vote-label span {
    color: #fff !important;
}

/* Optional: comment text */
.comment span {
    color: #fff !important;
}

/* Author names */
.author-left span {
    color: #fff !important;
}
.comments {
  background: #000; /* black background */
  color: #fff; /* text white */
  border-radius: 12px;
  padding: 8px;
  height: 110px; /* fixed height */
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
  /* optional glassy blur effect */
  backdrop-filter: blur(4px);
  border: 1px solid rgba(255,255,255,0.1);
}

.comment {
  background: #181818; /* keep each comment slightly lighter */
  color: #fff;
}
/* Update these specific classes in your <style> block */

.profile-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: #111;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    z-index: 1100;
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Prevent the whole panel from bouncing */
}

.panel-content {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* This allows scrolling inside the panel */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
}

</style>  
    <style>
        :root {
            --bg: #050505; --card: #121214; --glass: rgba(255, 255, 255, 0.08);
            --accent: #00A2FF; --green: #00E052; --red: #FF4B4B; --text: #FFFFFF;
            --text-dim: #8E8E93; --border: #242426;
        }
        #feed { width: 100%; max-width: 480px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 100px;}

        /* Toasts */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { padding: 12px; border-radius: 12px; font-weight: 800; font-size: 14px; margin-bottom: 8px; animation: slideDown 0.4s ease forwards; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .toast.success { background: var(--green); color: #000; }
        .toast.error { background: var(--red); color: #fff; }

        /* Card Elements */
        .card { background: var(--card); border-radius: 30px; border: 2px solid var(--border); overflow: hidden; position: relative; }
        .header { padding: 15px; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 45px; height: 45px; border-radius: 15px; border: 2px solid var(--border); object-fit: cover; cursor: pointer; }
        .post-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: zoom-in; background: #222; }
        
        .glass-title-row { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            margin: -25px 15px 10px 15px; padding: 15px; border-radius: 20px; border: 1px solid var(--glass);
            position: relative; z-index: 10; pointer-events: none;
        }

        .btn-action { 
            background: var(--accent); color: white; border: none; height: 35px; min-width: 95px; 
            border-radius: 12px; font-weight: 900; cursor: pointer; border-bottom: 4px solid #0072B3; 
            display: flex; align-items: center; justify-content: center; font-size: 10px;
        }
        .btn-action.following { background: var(--green); border-bottom-color: #009e3a; color: #000; }
        
        /* Modals */
        .modal { position: fixed; bottom: -100%; left: 0; width: 100%; height: 85%; background: #111; border-radius: 30px 30px 0 0; z-index: 1000; transition: 0.4s cubic-bezier(0,1,0,1); padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; border-top: 2px solid var(--border); }
        .modal.active { bottom: 0; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 999; backdrop-filter: blur(5px); }
        
        #fullImageModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10001; display: none; align-items: center; justify-content: center; }
        #fullImgSrc { max-width: 100%; max-height: 85%; object-fit: contain; }

        #end-msg { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--red); color: white; text-align: center; padding: 10px; font-weight: 900; z-index: 998; display: none; font-size: 12px; }
        
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
<header>
  <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="logo">
  <div class="header-right">
    <div class="profile" id="headerProfile"></div>
    <div class="hamburger" id="hamburger"><div></div><div></div><div></div></div>
  </div>
</header>

<div class="menu-overlay" id="menuOverlay">
  <a href="#">Home</a>
  <a href="#">Community</a>
  <a href="#">Games</a>
  <a href="#">Events</a>
  <a href="#">Profile</a>
  <a href="#">Settings</a>
</div>

<div class="profile-panel" id="profilePanel">
  <div class="panel-header">
    <img src="https://i.imgur.com/cM3Givj.jpeg" alt="RBX Community" class="profile-logo" style="height:40px; object-fit:contain;">
    <button class="close-btn" id="closeProfile">Close</button>
  </div>
  <div class="panel-top">
    <div id="panelProfilePic"></div>
    <div id="userInfo"></div>
    <div id="copyLinkContainer">
      <input type="text" id="userLink" readonly>
      <button id="copyLinkBtn">Copy</button>
    </div>
    <span id="copyStatus"></span>
    <div class="spinner" id="uploadSpinner"></div>
    <input type="file" id="profileInput" accept="image/*" style="display:none;">
  </div>
<div class="panel-content" style="padding:20px; flex:1; display:flex; flex-direction:column;">
 <!-- Handle / Username Edit -->
<div id="handleContainer" style="display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:12px;">
  <input type="text" id="handleInput" placeholder="Username / Handle" 
         style="padding:6px 12px;border-radius:12px;border:1px solid #333;background:#222;color:#fff;text-align:center;font-size:14px;width:60%;">
 <button id="saveHandleBtn">Save Handle</button>
  <span id="handleStatus" style="font-size:12px;color:#ccc;"></span>
</div>
  <!-- User Stats -->
  <div class="profile-stats" style="display:flex;justify-content:space-around;width:100%;margin-bottom:20px;">
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statPosts">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Posts</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowers">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Followers</p>
    </div>
    <div style="text-align:center;">
      <span style="font-weight:bold;font-size:18px;" id="statFollowing">0</span>
      <p style="font-size:12px;color:#aaa;margin:0;">Following</p>
    </div>
  </div>


<div style="width:100%;background:#1a1a1a;padding:12px;border-radius:12px;margin-bottom:12px;">
  <h3 style="margin:0 0 8px 0;font-size:16px;">About Me</h3>
  <textarea id="userBioTextarea" maxlength="100" placeholder="Write something about yourself..." 
            style="width:100%;background:#222;color:#ccc;border:none;padding:8px;border-radius:8px;resize:none;font-size:14px;outline:none;"></textarea>
  <div id="bioCharCount" style="text-align:right;font-size:12px;color:#777;margin-top:4px;">0 / 100</div>
  <div style="display:flex;align-items:center;gap:8px;margin-top:8px;">
    <button id="saveProfileBtn" style="padding:8px 16px;border-radius:12px;border:none;background:#2196F3;color:#fff;font-weight:bold;cursor:pointer;flex-shrink:0;">Save Profile</button>
    <div class="spinner" id="saveProfileSpinner" style="width:20px;height:20px;border:3px solid #ccc;border-top:3px solid #4caf50;border-radius:50%;animation:spin 1s linear infinite;display:none;"></div>
    <span id="saveProfileStatus" style="font-size:12px;color:#4caf50;"></span>
  </div>
<div style="margin-top: 20px; border-top: 1px solid #222; padding-top: 20px; flex:1; display:flex; flex-direction:column; overflow:hidden;">
    <div style="display: flex; justify-content: space-around; margin-bottom: 15px; flex-shrink:0;">
        <button onclick="showSocialTab('followers')" id="tabFollowers" style="background:none; border:none; color:var(--accent); font-weight:900; cursor:pointer; font-size:12px;">FOLLOWERS</button>
        <button onclick="showSocialTab('following')" id="tabFollowing" style="background:none; border:none; color:#555; font-weight:900; cursor:pointer; font-size:12px;">FOLLOWING</button>
    </div>

    <div id="socialList" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; padding-bottom: 20px;">
        </div>
</div>

    </div>
</div>

</div>

  </div>
</div>

<main style="padding:12px; background:#121212;">
  <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:bold; color:white; font-size:14px;">
    FEATURED PROFILES
    <img width="24" height="24" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified-badge"/>
  </div>

  <div id="userContainer" style="display:flex; overflow-x:auto; gap:12px; padding:8px 0; scrollbar-width:none;"></div>
<h1>Polls</h1>  
<div class="status-msg" id="statusMsg"></div>  
<div class="poll-feed-container" id="pollFeed"></div>  
<div class="spinner" id="spinner"></div>  
  
<div class="confirm-popup" id="confirmPopup">  
  <div class="popup-content">  
    <p id="confirmText">Are you sure you want to delete this poll?</p>  
    <button class="confirm" id="confirmYes">Yes</button>  
    <button class="cancel" id="confirmNo">Cancel</button>  
  </div>  
</div>  
  <div style="display:flex; align-items:center; gap:6px; margin-bottom:8px; font-weight:bold; color:white; font-size:14px;">
    FEED
    <img width="24" height="24" src="https://img.icons8.com/stickers/100/verified-badge.png" alt="verified-badge"/>
  </div>
<div id="toast-container"></div>
<div id="feed"></div>
<div id="end-msg">üõë YOU'VE REACHED THE END OF THE UNIVERSE</div>
<div class="overlay" id="overlay" onclick="closeAllModals()"></div>

<div id="fullImageModal" onclick="this.style.display='none'">
    <button style="position:absolute; top:40px; left:20px; background:var(--accent); color:white; border:none; padding:12px; border-radius:12px; font-weight:900;">‚Üê BACK</button>
    <img id="fullImgSrc" src="">
</div>

<div class="modal" id="detailsModal">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 id="detTitle" style="margin:0; font-weight: 900; color:var(--accent);"></h2>
        <button id="repBtnMain" class="btn-action" style="min-width:70px; height:30px; background:var(--red); border-bottom-color:#b30000;">REPORT</button>
    </div>
    <div id="detCategory" style="color: var(--text-dim); font-size: 11px; font-weight: 900; margin-bottom: 10px;"></div>
    <div id="detStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    <div id="detDesc" style="background: #1c1c1e; padding: 20px; border-radius: 20px; margin-top: 20px; line-height: 1.6; color: #ddd; flex-grow: 1; overflow-y: auto; border: 1px solid var(--border);"></div>
</div>

<div class="modal" id="commentModal">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">Comments</h3>
        <button onclick="closeAllModals()" style="background:none; border:none; color:var(--text-dim); font-weight:900;">CLOSE</button>
    </div>
    <div id="commentList" style="flex-grow:1; overflow-y:auto;"></div>
    <div style="display:flex; gap:10px; padding-top:15px; border-top:1px solid var(--border);">
        <input type="text" id="cInput" placeholder="Write message..." style="flex-grow:1; background:#222; border:none; padding:15px; border-radius:15px; color:white;">
        <button onclick="sendComment()" class="btn-action" style="min-width:80px;">SEND</button>
    </div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, push, update, runTransaction, onValue, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

/* ================= CONFIG & INITIALIZATION ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
/* ================= GLOBAL MASTER FOLLOW ================= */
window.doFollow = async (uid) => {
    // Basic Guards
    if (!auth || !auth.currentUser) return notify("Login required", "error");
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted", "error");
    if (auth.currentUser.uid === uid) return;

    // Find all instances of this button (Feed, Comments, and Profile)
    const btns = document.querySelectorAll(`.follow-btn-${uid}`);
    
    // Set all to loading
    btns.forEach(b => { 
        b.disabled = true; 
        b.innerText = '...'; 
    });

    const followerRef = ref(db, `users/${uid}/followers/${auth.currentUser.uid}`);
    const followingRef = ref(db, `following/${auth.currentUser.uid}/${uid}`);
    
    try {
        const snap = await get(followerRef);
        const alreadyFollowing = snap.exists();

        if (!alreadyFollowing) {
            await set(followerRef, true);
            await set(followingRef, true);
        } else {
            await remove(followerRef);
            await remove(followingRef);
        }
        
        // Final UI Sync
        const newState = !alreadyFollowing;
        btns.forEach(btn => {
            btn.disabled = false;
            btn.classList.toggle('following', newState);
            btn.innerText = newState ? 'FOLLOWING' : 'FOLLOW';
            // Force color styles for dynamic modal buttons
            btn.style.background = newState ? "#4caf50" : "var(--accent)";
            btn.style.color = newState ? "#000" : "#fff";
        });

        // Update the stats numbers in the profile panel if it's open
        if (typeof refreshStats === "function") refreshStats();
        
    } catch(e) { 
        console.error("Follow error:", e);
        btns.forEach(b => { b.disabled = false; b.innerText = 'RETRY'; });
    }
};

/* ================= STATE & FEED VARIABLES ================= */
let currentUser = null;
let allPostIds = [];
let displayedCount = 0;
const batchSize = 5;
let currentActiveId = null;
let deletePollId = null;

/* ================= ELEMENTS ================= */
const hamburger = document.getElementById('hamburger');
const menuOverlay = document.getElementById('menuOverlay');
const headerProfile = document.getElementById('headerProfile');
const profilePanel = document.getElementById('profilePanel');
const closeProfile = document.getElementById('closeProfile');
const panelProfilePic = document.getElementById('panelProfilePic');
const userInfo = document.getElementById('userInfo');
const userLinkInput = document.getElementById('userLink');
const copyBtn = document.getElementById('copyLinkBtn');
const copyStatus = document.getElementById('copyStatus');
const uploadSpinner = document.getElementById('uploadSpinner');
const profileInput = document.getElementById('profileInput');
const userBioTextarea = document.getElementById('userBioTextarea');
const bioCharCount = document.getElementById('bioCharCount');
const statPosts = document.getElementById('statPosts');
const statFollowers = document.getElementById('statFollowers');
const statFollowing = document.getElementById('statFollowing');
const handleInput = document.getElementById('handleInput');
const saveHandleBtn = document.getElementById('saveHandleBtn');
const handleStatus = document.getElementById('handleStatus');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const saveProfileSpinner = document.getElementById('saveProfileSpinner');
const saveProfileStatus = document.getElementById('saveProfileStatus');
const featuredContainer = document.getElementById("userContainer");
const pollFeed = document.getElementById('pollFeed');
const spinner = document.getElementById('spinner');
const statusMsg = document.getElementById('statusMsg');
const confirmPopup = document.getElementById('confirmPopup');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');

/* ================= UTILS ================= */
function notify(elOrMsg, msgOrType = 'success', ok = true, t = 3000) {
    if (typeof elOrMsg === 'string') {
        const container = document.getElementById('toast-container');
        if (container) {
            const toast = document.createElement('div');
            toast.className = `toast ${msgOrType}`;
            toast.innerText = elOrMsg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), t);
            return;
        }
    }
    const el = elOrMsg;
    const msg = msgOrType;
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? '#4caf50' : '#f44336';
    setTimeout(() => el.textContent = '', t);
}

function showStatus(msg, type = 'success') { notify(statusMsg, msg, type === 'success'); }
function randomColor() { return `hsl(${Math.random() * 360},80%,60%)`; }
function count(val) { if (!val) return 0; if (typeof val === 'number') return val; if (typeof val === 'object') return Object.keys(val).length; return 0; }
function createSpinner() { const s = document.createElement('div'); s.style.cssText = `width:12px;height:12px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .6s linear infinite;margin:auto;`; return s; }
function timeAgo(ts) { const now = Date.now(); const diff = now - ts; const sec = Math.floor(diff / 1000), min = Math.floor(sec / 60), hr = Math.floor(min / 60), day = Math.floor(hr / 24); if (day > 0) return `${day} day${day > 1 ? 's' : ''} ago`; if (hr > 0) return `${hr} hour${hr > 1 ? 's' : ''} ago`; if (min > 0) return `${min} min${min > 1 ? 's' : ''} ago`; return 'just now'; }
function shuffleArray(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }

/* ================= RATE LIMIT & STAT HELPERS ================= */
async function checkWeeklyLimit(type) {
    if (!currentUser) return null;
    const historyRef = ref(db, `users/${currentUser.uid}/updateHistory/${type}`);
    const snap = await get(historyRef);
    const now = Date.now();
    const oneWeek = 7 * 24 * 60 * 60 * 1000;
    
    // Filter history to last 7 days
    const recentChanges = (snap.val() || []).filter(ts => (now - ts) < oneWeek);
    
    if (recentChanges.length >= 2) return null; 
    return [...recentChanges, now]; 
}

async function refreshStats() {
    if (!currentUser) return;
    const snap = await get(ref(db, `users/${currentUser.uid}`));
    const data = snap.val() || {};
    if (statPosts) statPosts.textContent = count(data.posts);
    if (statFollowers) statFollowers.textContent = count(data.followers);
    
    // For "Following", we check the dedicated path
    const followSnap = await get(ref(db, `following/${currentUser.uid}`));
    if (statFollowing) statFollowing.textContent = count(followSnap.val());
}

/* ================= PROFILE ACTIONS ================= */
hamburger?.addEventListener('click', () => { hamburger.classList.toggle('active'); menuOverlay.classList.toggle('active'); });
headerProfile?.addEventListener('click', () => { profilePanel.classList.add('active'); document.body.style.overflow = 'hidden'; });
closeProfile?.addEventListener('click', () => { profilePanel.classList.remove('active'); document.body.style.overflow = 'auto'; });
copyBtn?.addEventListener('click', () => { if (!userLinkInput.value || userLinkInput.value.includes('Login')) return; navigator.clipboard.writeText(userLinkInput.value); notify(copyStatus, 'Copied'); });

// Handle Input: Enforce 12-character limit
handleInput?.addEventListener('input', () => {
    if (handleInput.value.length > 12) {
        handleInput.value = handleInput.value.substring(0, 12);
        notify(handleStatus, 'Max 12 characters', false);
    }
});

// Profile Picture Upload
panelProfilePic?.addEventListener('click', () => profileInput.click());
profileInput?.addEventListener('change', async () => {
    if (!profileInput.files[0] || !currentUser) return;

    const newHistory = await checkWeeklyLimit('profilePic');
    if (!newHistory) return notify(saveProfileStatus, 'Limit: 2 changes per week', false);

    uploadSpinner.style.display = 'block';
    const formData = new FormData();
    formData.append('image', profileInput.files[0]);

    try {
        const res = await fetch('https://api.imgur.com/3/image', { 
            method: 'POST', 
            headers: { Authorization: 'Client-ID 891e5bb4aa94282' }, 
            body: formData 
        });
        const data = await res.json();
        
        if (data.success) {
            const updates = {};
            updates[`users/${currentUser.uid}/profilePic`] = data.data.link;
            updates[`users/${currentUser.uid}/updateHistory/profilePic`] = newHistory;
            
            await update(ref(db), updates);
            panelProfilePic.style.backgroundImage = `url(${data.data.link})`;
            headerProfile.style.backgroundImage = `url(${data.data.link})`;
            notify(saveProfileStatus, 'Profile picture updated!');
        } else {
            notify(saveProfileStatus, 'Upload failed!', false);
        }
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Upload error!', false);
    }
    uploadSpinner.style.display = 'none';
});

// Consolidated Profile Save
saveProfileBtn?.addEventListener('click', async () => {
    if (!currentUser) return;

    const h = handleInput.value.trim();
    const b = userBioTextarea.value;

    if (h.length < 3) return notify(saveProfileStatus, 'Handle too short', false);
    if (h.length > 12) return notify(saveProfileStatus, 'Handle max 12 chars', false);

    saveProfileSpinner.style.display = 'block';

    try {
        const newHistory = await checkWeeklyLimit('profileInfo');
        if (!newHistory) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Limit: 2 changes per week', false);
        }

        const allSnap = await get(ref(db, 'users'));
        const allUsers = allSnap.val() || {};
        const taken = Object.entries(allUsers).some(([uid, u]) => 
            u.handle?.toLowerCase() === h.toLowerCase() && uid !== currentUser.uid
        );

        if (taken) {
            saveProfileSpinner.style.display = 'none';
            return notify(saveProfileStatus, 'Handle already taken!', false);
        }

        const updates = {};
        updates[`users/${currentUser.uid}/handle`] = h;
        updates[`users/${currentUser.uid}/bio`] = b;
        updates[`users/${currentUser.uid}/updateHistory/profileInfo`] = newHistory;

        await update(ref(db), updates);
        await refreshStats();
        notify(saveProfileStatus, 'Profile saved!');
    } catch (e) {
        console.error(e);
        notify(saveProfileStatus, 'Save error!', false);
    }
    saveProfileSpinner.style.display = 'none';
});

saveHandleBtn?.addEventListener('click', () => saveProfileBtn.click());

/* ================= FEATURED USERS & POLLS ================= */
async function loadFeaturedUsers() {
    if (!featuredContainer) return;
    try {
        const snap = await get(ref(db, 'users'));
        if (!snap.exists()) { featuredContainer.innerHTML = "<p style='color:#888;'>No users found.</p>"; return; }
        let allUsers = Object.entries(snap.val());
        allUsers.sort(() => 0.5 - Math.random());
        const featured10 = allUsers.slice(0, 10);
        featuredContainer.innerHTML = '';
        let myFollowing = new Set();
        if (currentUser) {
            const fSnap = await get(ref(db, `following/${currentUser.uid}`));
            if (fSnap.exists()) myFollowing = new Set(Object.keys(fSnap.val()));
        }
        featured10.forEach(([uid, user]) => {
            const div = document.createElement('div');
            div.style.cssText = "flex:0 0 auto; width:70px; display:flex; flex-direction:column; align-items:center;";
            const imgWrapper = document.createElement('div');
            imgWrapper.style.cssText = `width:60px;height:60px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;border:3px solid #fff;transition:border-color 1s;`;
            const img = document.createElement('img');
            img.src = user.profilePic || 'https://via.placeholder.com/60?text=?';
            img.style.cssText = "width:100%;height:100%;object-fit:cover;";
            imgWrapper.appendChild(img); div.appendChild(imgWrapper);
            setInterval(() => { imgWrapper.style.borderColor = randomColor(); }, 1000);
            const handleDiv = document.createElement('div');
            handleDiv.textContent = '@' + (user.handle || 'user');
            handleDiv.style.cssText = "max-width:70px;font-size:10px;color:#fff;margin-top:4px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
            div.appendChild(handleDiv);
            const followerDiv = document.createElement('div');
            followerDiv.style.cssText = "font-size:9px;color:#bbb;text-align:center;margin-top:2px;";
            div.appendChild(followerDiv);
            const button = document.createElement('button');
            button.style.cssText = "margin-top:4px;font-size:10px;padding:2px 6px;border-radius:4px;border:none;background:#2e89ff;color:#fff;cursor:pointer;text-align:center;";
            div.appendChild(button);
            const msg = document.createElement('span');
            msg.style.cssText = "color:#ff6b6b;font-size:10px;margin-top:2px;display:none;text-align:center;";
            div.appendChild(msg);

            async function updateButton() {
                const fSnap = await get(ref(db, `users/${uid}/followers`));
                followerDiv.textContent = count(fSnap.val()) + ' followers';
                if (!currentUser) { button.textContent = 'Follow'; button.style.background = '#2e89ff'; return; }
                const isFollowing = myFollowing.has(uid);
                button.textContent = isFollowing ? 'Following' : 'Follow';
                button.style.background = isFollowing ? '#4caf50' : '#2e89ff';
            }
            updateButton();

            button.addEventListener('click', async () => {
                if (!currentUser) { msg.textContent = "Only logged in users can follow"; msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 2000); return; }
                const spinnerIcon = createSpinner(); button.innerHTML = ''; button.appendChild(spinnerIcon); button.disabled = true;
                const path = ref(db, `following/${currentUser.uid}/${uid}`);
                const snapF = await get(path);
                if (!snapF.exists()) {
                    await set(path, true);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => (c || 0) + 1);
                    myFollowing.add(uid);
                } else {
                    await set(path, null);
                    await runTransaction(ref(db, `users/${uid}/followers`), c => Math.max((c || 0) - 1, 0));
                    myFollowing.delete(uid);
                }
                if (statFollowing) statFollowing.textContent = myFollowing.size;
                updateButton(); button.disabled = false;
            });
            featuredContainer.appendChild(div);
        });
    } catch (e) { console.error(e); }
}

/* ================= POLL STATE FOR LAZY LOADING ================= */
let allPollData = [];
let pollsDisplayed = 0;
const pollBatchSize = 3;

async function loadPolls() {
    if (!pollFeed) return;
    if (spinner) spinner.style.display = 'block';
    try {
        const snap = await get(ref(db, '/poll'));
        if (!snap.exists()) return;
        
        allPollData = shuffleArray(Object.entries(snap.val()));
        pollFeed.innerHTML = '';
        pollsDisplayed = 0;

        renderPollBatch();
    } catch (e) { 
        console.error(e); 
        showStatus('Error loading polls', 'error'); 
    } finally { 
        if (spinner) spinner.style.display = 'none'; 
    }
}

async function renderPollBatch() {
    const batch = allPollData.slice(pollsDisplayed, pollsDisplayed + pollBatchSize);
    if (batch.length === 0) return;

    let following = [];
    if (currentUser) {
        const followingSnap = await get(ref(db, `/following/${currentUser.uid}`));
        if (followingSnap.exists()) following = Object.keys(followingSnap.val());
    }

    batch.forEach(([id, data]) => renderPoll(id, data, following));
    pollsDisplayed += pollBatchSize;
}

async function renderPoll(pollId, data, following = []) {
    const card = document.createElement('div'); card.className = 'poll-card'; card.dataset.uid = data.uid;
    
    // --- Author Section ---
    const authorSection = document.createElement('div'); authorSection.className = 'poll-author';
    const authorLeft = document.createElement('div'); authorLeft.className = 'author-left';
    const profileImg = document.createElement('img'); profileImg.src = 'default-avatar.png';
    const authorHandle = document.createElement('span'); authorHandle.textContent = '@user';
    authorLeft.append(profileImg, authorHandle); authorSection.append(authorLeft);

    const actionBtn = document.createElement('button');
    if (currentUser?.uid === data.uid) {
        actionBtn.className = 'delete-btn'; actionBtn.textContent = 'Delete';
        actionBtn.addEventListener('click', () => { deletePollId = pollId; confirmPopup.style.display = 'flex'; });
    } else {
        actionBtn.className = 'follow-btn';
        const isFollowing = following.includes(data.uid);
        actionBtn.textContent = isFollowing ? 'Following' : 'Follow';
        if (isFollowing) actionBtn.classList.add('following');
        
        actionBtn.addEventListener('click', async () => {
            if (!currentUser) { showStatus('Login required', 'error'); return; }
            actionBtn.disabled = true;
            actionBtn.innerHTML = '<div class="spinner-small"></div>'; 

            const followRef = ref(db, `/users/${data.uid}/followers/${currentUser.uid}`);
            const followingRef = ref(db, `/following/${currentUser.uid}/${data.uid}`);
            const snap = await get(followRef);
            let state = !snap.exists();

            try {
                if (state) { 
                    await update(followRef, { timestamp: Date.now() }); 
                    await update(followingRef, { timestamp: Date.now() }); 
                } else { 
                    await remove(followRef); 
                    await remove(followingRef); 
                }
                document.querySelectorAll(`.poll-card[data-uid="${data.uid}"] .follow-btn`).forEach(btn => {
                    btn.disabled = false;
                    btn.textContent = state ? 'Following' : 'Follow';
                    btn.classList.toggle('following', state);
                });
            } catch (err) {
                actionBtn.disabled = false;
                actionBtn.textContent = isFollowing ? 'Following' : 'Follow';
            }
        });
    }
    authorSection.append(actionBtn); card.appendChild(authorSection);

    get(ref(db, `/users/${data.uid}`)).then(uSnap => {
        const u = uSnap.val() || {}; 
        profileImg.src = u.profilePic || 'default-avatar.png'; 
        authorHandle.textContent = '@' + (u.handle || 'user');
        if (u.followers && Object.keys(u.followers).length >= 1000) {
            const badge = document.createElement('img'); 
            badge.src = 'https://img.icons8.com/stickers/100/verified-badge.png';
            badge.className = 'verified-badge'; badge.style.cssText = 'width:16px;height:16px;margin-left:4px;'; 
            authorHandle.appendChild(badge);
        }
    });

    const title = document.createElement('h2'); title.textContent = data.question; card.appendChild(title);

    // --- Stats & View Comments Header ---
    const statsHeader = document.createElement('div');
    statsHeader.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;';
    
    const counter = document.createElement('div');
    counter.className = 'comment-counter';
    counter.style.fontSize = '12px';
    counter.textContent = 'Comments: 0';
    
    const viewCommentsBtn = document.createElement('button');
    viewCommentsBtn.textContent = 'VIEW COMMENTS';
    viewCommentsBtn.style.cssText = 'background:var(--accent); color:black; border:none; padding:4px 10px; border-radius:6px; font-weight:900; font-size:10px; cursor:pointer;';
    viewCommentsBtn.onclick = () => window.openComments(pollId, 'poll'); 
    
    statsHeader.append(counter, viewCommentsBtn);
    card.appendChild(statsHeader);

    // --- Votes Section ---
    const ul = document.createElement('ul'); card.appendChild(ul);
    data.options.forEach((opt, idx) => {
        const li = document.createElement('li'); 
        li.innerHTML = `<div class="vote-bar"></div><div class="vote-label"><span>${opt}</span><span>0 votes</span></div>`;
        ul.appendChild(li);
        li.addEventListener('click', async () => {
            if (!currentUser) { showStatus('Login required', 'error'); return; }
            const userVoteRef = ref(db, `/pollVotes/${pollId}/${currentUser.uid}`);
            const votedSnap = await get(userVoteRef);
            if (votedSnap.exists()) { showStatus('You already voted', 'error'); return; }
            await runTransaction(ref(db, `/poll/${pollId}/votes/${idx}`), v => (v || 0) + 1);
            await update(userVoteRef, { option: idx });
        });
    });

    onValue(ref(db, `/poll/${pollId}/votes`), snap => {
        const votes = snap.val() || {}; const total = Object.values(votes).reduce((a, b) => a + b, 0) || 1;
        card.querySelectorAll('li').forEach((li, i) => {
            const c = votes[i] || 0; const p = Math.round((c / total) * 100);
            li.querySelector('.vote-bar').style.width = p + '%';
            li.querySelector('.vote-label span:last-child').textContent = `${c} votes (${p}%)`;
        });
    });

    // --- Inline Comment List (Read Only) ---
    const list = document.createElement('div'); 
    list.className = 'comments-list'; 
    list.style.cssText = 'height:100px; overflow-y:auto; border-top:1px solid #222; margin-top:5px; padding:5px 0;';
    card.appendChild(list);

    onValue(ref(db, `/pollComments/${pollId}`), async snap => {
        const comments = snap.val() || {}; list.innerHTML = '';
        const sorted = Object.entries(comments).sort((a, b) => a[1].timestamp - b[1].timestamp);
        counter.textContent = `Comments: ${sorted.length}`;
        
        for (const [key, c] of sorted) {
            const userSnap = await get(ref(db, `/users/${c.uid}`));
            const u = userSnap.val() || {};
            const div = document.createElement('div');
            div.style.cssText = 'font-size:11px; margin-bottom:4px; display:flex; align-items:center; gap:5px;';
            div.innerHTML = `<img src="${u.profilePic || 'default-avatar.png'}" style="width:18px;height:18px;border-radius:50%;"> 
                            <span><strong>@${u.handle || 'user'}</strong>: ${c.text}</span>`;
            list.appendChild(div);
        }
        list.scrollTop = list.scrollHeight;
    });

    // --- Removed Input Form ---
    // User must click "VIEW COMMENTS" to add a new comment

    // --- Footer ---
    const footer = document.createElement('div'); footer.style.cssText = 'display:flex;justify-content:space-between;font-size:10px;opacity:0.5;margin-top:10px;';
    const timeSpan = document.createElement('span'); timeSpan.textContent = timeAgo(data.timestamp || Date.now());
    const viewsSpan = document.createElement('span'); viewsSpan.textContent = 'Views: 0';
    footer.append(timeSpan, viewsSpan); card.appendChild(footer);
    
    runTransaction(ref(db, `/pollViews/${pollId}`), v => (v || 0) + 1).then(tx => { 
        viewsSpan.textContent = `Views: ${tx.snapshot.val()}`; 
    });

    pollFeed.appendChild(card);
}

/* ================= FEED (POSTS) LOGIC ================= */
/* ================= FEED (POSTS) LOGIC ================= */
async function startUniverse() {
    const snap = await get(ref(db, 'post'));
    if (!snap.exists()) return;
    // Shuffle posts and reset feed
    allPostIds = Object.entries(snap.val()).sort(() => Math.random() - 0.5);
    const feed = document.getElementById('feed'); 
    if (feed) feed.innerHTML = '';
    displayedCount = 0; 
    renderBatch();
}

function renderBatch() {
    const feed = document.getElementById('feed'); 
    if (!feed) return;
    
    if (displayedCount >= allPostIds.length) { 
        document.getElementById('end-msg').style.display = 'block'; 
        return; 
    }
    
    const batch = allPostIds.slice(displayedCount, displayedCount + batchSize);
    
    batch.forEach(([id, post]) => {
        const card = document.createElement('div'); 
        card.className = 'card'; 
        feed.appendChild(card);

        // --- UPDATE VIEWS ON LOAD/REFRESH ---
        // This triggers immediately when the post appears in the batch
        runTransaction(ref(db, `post/${id}/views`), v => (v || 0) + 1);

        onValue(ref(db, `post/${id}`), (pSnap) => {
            const p = pSnap.val(); 
            if (!p) return;
            
            onValue(ref(db, `users/${p.uid}`), (uSnap) => {
                const u = uSnap.val() || {}; 
                const fc = count(u.followers); 
                const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
                
                card.innerHTML = `
                <div class="header">
                  <img src="${u.profilePic || ''}" class="avatar" onclick="window.location.href='/profile?user=${p.uid}'">
                  <div style="flex-grow:1; cursor:pointer;" onclick="window.location.href='/profile?user=${p.uid}'">
                    <div style="font-weight:900; display:flex; align-items:center; gap:4px;">@${u.handle || 'user'} ${fc >= 1000 ? '‚úÖ' : ''}</div>
                    <div style="font-size:10px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                  </div>
                  <button class="btn-action follow-btn-${p.uid} ${isF ? 'following' : ''}" onclick="doFollow('${p.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                </div>
                <img src="${p.image}" class="post-img" onclick="viewFull('${p.image}')" ondblclick="doLike('${id}')">
                <div class="glass-title-row"><h3 style="margin:0; font-size:17px; font-weight:900; color:white;">${p.title}</h3></div>
                <div style="padding:0 16px 15px 16px;">
                  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="display:flex; gap:20px;">
                      <div onclick="doLike('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="${(p.likes && auth.currentUser && p.likes[auth.currentUser.uid]) ? 'var(--red)' : 'white'}"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        ${p.likeCount || 0}
                      </div>
                      <div onclick="openComments('${id}')" style="cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:900;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="white"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        ${p.comments ? Object.keys(p.comments).length : 0}
                      </div>
                    </div>
                    <span style="font-size:10px; color:var(--text-dim); font-weight:900;">${timeAgo(p.timestamp)}</span>
                  </div>
                  <div style="font-size:10px; color:var(--accent); font-weight:900; margin-bottom:5px;">${p.views || 0} VIEWS ‚Ä¢ ${p.category?.toUpperCase()}</div>
                  <div style="font-size:14px; line-height:1.4;">${p.description ? p.description.substring(0, 70) : ''}... <span style="color:var(--accent); font-weight:900; cursor:pointer;" onclick="openReadMore('${id}')">Read More</span></div>
                </div>`;
            });
        });
    });
    displayedCount += batchSize;
}

/* ================= UPDATED MODAL VIEW LOGIC ================= */
// We removed the transaction from here so we don't double-count views
window.openReadMore = async (id) => {
    try {
        const snap = await get(ref(db, `post/${id}`));
        const p = snap.val();
        if (!p) return;

        document.getElementById('detTitle').innerText = p.title || "No Title";
        document.getElementById('detCategory').innerText = `CATEGORY: ${(p.category || 'General').toUpperCase()}`;
        document.getElementById('detStats').innerHTML = `
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">üëÅÔ∏è ${p.views || 0} Views</div>
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">‚ù§Ô∏è ${p.likeCount || 0} Likes</div>`;
        document.getElementById('detDesc').innerText = p.description || "";
        
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('detailsModal').classList.add('active');
    } catch(e) { console.error(e); }
};

/* ================= WINDOW GLOBALS & MODAL LOGIC ================= */
let currentModalType = 'post';

window.openComments = (id, type = 'post') => {
    currentActiveId = id;
    currentModalType = type;
    
    const dbPath = type === 'poll' ? `pollComments/${id}` : `post/${id}/comments`;
    const overlay = document.getElementById('overlay');
    const modal = document.getElementById('commentModal');
    
    if (overlay) overlay.style.display = 'block';
    if (modal) modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    const commentRef = ref(db, dbPath);
    onValue(commentRef, async (snap) => {
        const list = document.getElementById('commentList');
        if (!list) return;
        list.innerHTML = "";
        if (!snap.exists()) return;
        
        const entries = Object.entries(snap.val()).sort((a, b) => a[1].timestamp - b[1].timestamp);

        for (const [cid, c] of entries) {
            const uSnap = await get(ref(db, `users/${c.uid}`));
            const u = uSnap.val() || {};
            const fc = count(u.followers);
            const isF = auth.currentUser && u.followers?.[auth.currentUser.uid];
            
            let linkUI = "";
            if (c.text.includes("http")) {
                const urlMatch = c.text.match(/\bhttps?:\/\/\S+/gi);
                const url = urlMatch ? urlMatch[0] : "";
                linkUI = `
                    <div style="margin-top:10px; border:1px solid var(--border); border-radius:15px; overflow:hidden;">
                        <span style="font-size:10px; color:var(--red); font-weight:900; background:rgba(255,75,75,0.1); padding:5px; text-align:center; display:block;">‚ö†Ô∏è CLICK AT YOUR OWN RISK</span>
                        <iframe src="${url}" width="100%" height="120px" style="border:none; background:white;"></iframe>
                        <a href="https://otieu.com/4/7950037" target="_blank" style="background:var(--green); display:block; text-align:center; padding:10px; color:black; font-weight:900; text-decoration:none;">VISIT SECURELY</a>
                    </div>`;
            }

            list.innerHTML += `
                <div style="padding:15px 0; border-bottom:1px solid #222;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
                        <img src="${u.profilePic || 'default-avatar.png'}" style="width:35px; height:35px; border-radius:10px; cursor:pointer;" onclick="window.location.href='/profile?user=${c.uid}'">
                        <div style="flex-grow:1;">
                            <div style="font-weight:900; font-size:12px;">@${u.handle || 'user'} <span style="font-size:10px; color:#666; font-weight:400;">‚Ä¢ ${timeAgo(c.timestamp)}</span></div>
                            <div style="font-size:9px; color:var(--accent); font-weight:800;">${fc} Followers</div>
                        </div>
                        <button class="btn-action follow-btn-${c.uid} ${isF ? 'following' : ''}" style="min-width:75px; height:28px; font-size:8px;" onclick="doFollow('${c.uid}')">${isF ? 'FOLLOWING' : 'FOLLOW'}</button>
                        <button onclick="submitReport('${cid}', 'comment')" style="background:none; border:none; color:var(--red); font-weight:900; font-size:10px;">REPORT</button>
                    </div>
                    <div style="padding-left:45px; font-size:13px;">${c.text.replace(/\bhttps?:\/\/\S+/gi, '[Link Shared]')}</div>
                    <div style="padding-left:45px;">${linkUI}</div>
                </div>`;
        }
        list.scrollTop = list.scrollHeight;
    });
};

window.sendComment = async () => {
    // BLACKLIST CHECK
    if (window.isBlacklisted) return notify("Action Blocked: Your account is blacklisted.", "error");
    
    const input = document.getElementById('cInput');
    const val = input ? input.value.trim() : "";
    if (!val || !auth.currentUser || !currentActiveId) return;

    const path = currentModalType === 'poll' ? `pollComments/${currentActiveId}` : `post/${currentActiveId}/comments`;
    
    input.disabled = true;
    try {
        await push(ref(db, path), { uid: auth.currentUser.uid, text: val, timestamp: Date.now() });
        input.value = "";
    } catch(e) { console.error(e); }
    input.disabled = false;
    input.focus();
};

window.doLike = (id) => {
    if (!auth.currentUser) return notify("Login required", "error");
    // BLACKLIST CHECK
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted users cannot like.", "error");

    runTransaction(ref(db, `post/${id}`), (p) => {
        if (p) {
            p.likes = p.likes || {};
            if (p.likes[auth.currentUser.uid]) {
                delete p.likes[auth.currentUser.uid];
                p.likeCount = Math.max(0, (p.likeCount || 1) - 1);
            } else {
                p.likes[auth.currentUser.uid] = true;
                p.likeCount = (p.likeCount || 0) + 1;
            }
        }
        return p;
    });
};

window.openReadMore = async (id) => {
    try {
        const snap = await get(ref(db, `post/${id}`));
        const p = snap.val();
        if (!p) return;

        document.getElementById('detTitle').innerText = p.title || "No Title";
        document.getElementById('detCategory').innerText = `CATEGORY: ${(p.category || 'General').toUpperCase()}`;
        document.getElementById('detStats').innerHTML = `
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">üëÅÔ∏è ${p.views || 0} Views</div>
            <div style="background:var(--glass); padding:12px; border-radius:15px; text-align:center;">‚ù§Ô∏è ${p.likeCount || 0} Likes</div>`;
        document.getElementById('detDesc').innerText = p.description || "";
        
        const repBtn = document.getElementById('repBtnMain');
        if (repBtn) {
            repBtn.onclick = () => window.submitReport(id, 'post');
        }
        
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('detailsModal').classList.add('active');
    } catch(e) { console.error("Error opening details:", e); }
};

window.submitReport = async (tid, type) => {
    if(!auth.currentUser) return notify("Login required", "error");
    // BLACKLIST CHECK
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted users cannot report.", "error");

    await push(ref(db, 'reports'), { tid, type, reporter: auth.currentUser.uid, time: Date.now() });
    notify("Report submitted", "error");
};

window.viewFull = (src) => { 
    document.getElementById('fullImgSrc').src = src; 
    document.getElementById('fullImageModal').style.display = 'flex'; 
};

window.closeAllModals = () => {
    document.getElementById('overlay').style.display = 'none';
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    document.getElementById('fullImageModal').style.display = 'none';
    document.body.style.overflow = 'auto';
};



/* ================= AUTH & INITIAL LOAD ================= */
onAuthStateChanged(auth, async user => {
    currentUser = user || null;
    if (user) {
        const uid = user.uid;
        userLinkInput.value = `${location.origin}/profile?uid=${uid}`;
        
        // --- 1. START SECURITY & ANNOUNCEMENT WATCHER ---
        // This checks if the user is banned or blacklisted in real-time
        checkUserSecurity(user); 
        
        refreshStats();
        
        // Load social tab data early
        showSocialTab('followers'); 
        
        const snap = await get(ref(db, `users/${uid}`));
        const data = snap.val() || {};
        handleInput.value = data.handle || 'user';
        userBioTextarea.value = data.bio || '';
        
        if (data.profilePic) { 
            headerProfile.style.backgroundImage = `url(${data.profilePic})`; 
            panelProfilePic.style.backgroundImage = `url(${data.profilePic})`; 
        }
    } else {
        userLinkInput.value = 'Login to get link';
        const list = document.getElementById('socialList');
        if(list) list.innerHTML = '';
        // Reset blacklist status if logged out
        window.isBlacklisted = false;
    }
    loadFeaturedUsers();
    loadPolls();
    startUniverse();
});


// Confirm Popups
confirmNo?.addEventListener('click', () => { confirmPopup.style.display = 'none'; deletePollId = null; });
confirmYes?.addEventListener('click', async () => {
    if (!deletePollId) return;
    await remove(ref(db, `/poll/${deletePollId}`));
    await remove(ref(db, `/pollVotes/${deletePollId}`));
    await remove(ref(db, `/pollComments/${deletePollId}`));
    confirmPopup.style.display = 'none';
    loadPolls();
});

// Scroll Listener
window.onscroll = () => { 
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) {
        renderBatch(); 
        if (typeof renderPollBatch === 'function') renderPollBatch();
    }
};

/* --- STATE FOR SOCIAL LAZY LOAD --- */
let socialUids = [];
let socialDisplayedCount = 0;
const socialBatchSize = 10;
let currentSocialTab = 'followers';

// Helper function to render a single user row
function renderSocialItem(container, uid, userData, btnText) {
    const div = document.createElement('div');
    div.id = `social-row-${uid}`;
    div.style.cssText = "display:flex; align-items:center; gap:12px; background:#1a1a1a; padding:10px; border-radius:15px; margin-bottom:8px;";
    
    const isUnfollow = btnText === 'UNFOLLOW';
    const btnClass = isUnfollow ? 'background:#333; color:#ff4b4b;' : 'background:var(--accent); color:white;';

    div.innerHTML = `
        <img src="${userData.profilePic || 'https://i.imgur.com/cM3Givj.jpeg'}" style="width:40px;height:40px;border-radius:12px;object-fit:cover;cursor:pointer;" onclick="window.location.href='/profile?user=${uid}'">
        <div style="flex:1; overflow:hidden;">
            <div style="font-size:13px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:white;">@${userData.handle || 'user'}</div>
            <div style="font-size:10px; color:#666;">${count(userData.followers)} Followers</div>
        </div>
        <button id="socBtn-${uid}" style="border:none; border-radius:10px; padding:6px 12px; font-size:10px; font-weight:900; cursor:pointer; ${btnClass}">
            ${btnText}
        </button>
    `;

    const btn = div.querySelector(`#socBtn-${uid}`);
    btn.onclick = async () => {
        btn.disabled = true;
        btn.innerText = "...";
        
        await window.doFollow(uid); 

        // Fix: Update UI immediately based on tab context
        if (currentSocialTab === 'following') {
            div.remove(); // Remove immediately if unfollowing from following list
            if (container.children.length === 0) {
                container.innerHTML = `<p style="text-align:center; font-size:11px; color:#555; margin-top:20px;">No following yet</p>`;
            }
        } else {
            showSocialTab('followers'); // Refresh labels for followers tab
        }
    };

    container.appendChild(div);
}

/* --- FIXED SOCIAL TAB & GLOBAL FOLLOW SYNC --- */

window.showSocialTab = async (tab) => {
    const list = document.getElementById('socialList');
    const tabR = document.getElementById('tabFollowers');
    const tabG = document.getElementById('tabFollowing');
    if (!currentUser || !list) return;

    list.innerHTML = '<div class="spinner" style="display:block; margin:20px auto; border:2px solid var(--accent); border-top-color:transparent; width:20px; height:20px; border-radius:50%; animation:spin .6s linear infinite;"></div>';
    socialDisplayedCount = 0;
    currentSocialTab = tab;
    
    tabR.style.color = (tab === 'followers') ? 'var(--accent)' : '#555';
    tabG.style.color = (tab === 'following') ? 'var(--accent)' : '#555';

    const path = tab === 'followers' ? `users/${currentUser.uid}/followers` : `following/${currentUser.uid}`;
    const snap = await get(ref(db, path));
    
    if (!snap.exists() || Object.keys(snap.val()).length === 0) {
        list.innerHTML = `<p style="text-align:center; font-size:11px; color:#555; margin-top:20px;">No ${tab} yet</p>`;
        return;
    }

    socialUids = Object.keys(snap.val());
    list.innerHTML = ''; 
    renderSocialBatch(); 
};

async function renderSocialBatch() {
    const list = document.getElementById('socialList');
    if (socialDisplayedCount >= socialUids.length) return;

    const nextBatch = socialUids.slice(socialDisplayedCount, socialDisplayedCount + socialBatchSize);
    const myFollowingSnap = await get(ref(db, `following/${currentUser.uid}`));
    const myFollowing = myFollowingSnap.val() || {};

    for (const fUid of nextBatch) {
        const uSnap = await get(ref(db, `users/${fUid}`));
        const u = uSnap.val() || {};
        
        let btnText = (currentSocialTab === 'following') ? 'UNFOLLOW' : (myFollowing[fUid] ? 'FOLLOWING' : 'FOLLOW BACK');
        renderSocialItem(list, fUid, u, btnText);
    }
    socialDisplayedCount += socialBatchSize;
}

// THE MASTER FOLLOW FUNCTION (Universal Fix)
window.doFollow = async (uid) => {
    if (!currentUser) return notify("Login required", "error");
    if (window.isBlacklisted) return notify("Action Blocked: Blacklisted", "error");
    if (currentUser.uid === uid) return;

    // 1. Find ALL buttons for this user (Feed, Comments, and Social Tab)
    const allBtns = document.querySelectorAll(`.follow-btn-${uid}, #socBtn-${uid}`);
    
    // 2. Set loading state on all of them
    allBtns.forEach(b => { b.disabled = true; b.innerText = '...'; });

    try {
        const myFollowingRef = ref(db, `following/${currentUser.uid}/${uid}`);
        const snap = await get(myFollowingRef);
        const alreadyFollowing = snap.exists();
        
        const updates = {};
        if (alreadyFollowing) {
            updates[`following/${currentUser.uid}/${uid}`] = null;
            updates[`users/${uid}/followers/${currentUser.uid}`] = null;
        } else {
            updates[`following/${currentUser.uid}/${uid}`] = true;
            updates[`users/${uid}/followers/${currentUser.uid}`] = true;
        }

        await update(ref(db), updates);
        
        // 3. Update UI state for all buttons simultaneously
        const newState = !alreadyFollowing;
        allBtns.forEach(btn => {
            btn.disabled = false;
            
            // Logic for the Social Panel List
            if (btn.id.startsWith('socBtn-')) {
                if (currentSocialTab === 'following' && !newState) {
                    document.getElementById(`social-row-${uid}`)?.remove();
                } else {
                    btn.innerText = newState ? (currentSocialTab === 'following' ? 'UNFOLLOW' : 'FOLLOWING') : 'FOLLOW BACK';
                    btn.style.background = newState ? "#333" : "var(--accent)";
                }
            } 
            // Logic for Feed and Comment Modal
            else {
                btn.classList.toggle('following', newState);
                btn.innerText = newState ? 'FOLLOWING' : 'FOLLOW';
                btn.style.background = newState ? "#4caf50" : "var(--accent)";
                btn.style.color = newState ? "#000" : "#fff";
            }
        });

        refreshStats();
    } catch (e) { 
        console.error(e); 
        allBtns.forEach(b => { b.disabled = false; b.innerText = 'RETRY'; });
    }
};

document.getElementById('socialList').addEventListener('scroll', function(e) {
    const el = e.target;
    if (el.scrollHeight - el.scrollTop <= el.clientHeight + 50) {
        renderSocialBatch();
    }
});

/* --- FIXED SECURITY & ANNOUNCEMENT LOGIC --- */
window.isBlacklisted = false; // Global flag

async function checkUserSecurity(user) {
    if (!user) return;
    
    // 1. Real-time Security Watch
    // We target the specific securityStatus node for better performance
    onValue(ref(db, `users/${user.uid}/securityStatus`), (snap) => {
        const status = snap.val() || { type: 'clear' };

        if (status.type === 'banned') {
            showBanModal(status.reason || "Violation of terms");
        } else if (status.type === 'blacklisted') {
            window.isBlacklisted = true;
            // Notify only once per session
            if (!sessionStorage.getItem('notified_blacklist')) {
                notify("Account Blacklisted: Interactions restricted", "error");
                sessionStorage.setItem('notified_blacklist', 'true');
            }
        } else {
            window.isBlacklisted = false;
            sessionStorage.removeItem('notified_blacklist');
        }
    });

    // 2. Global & Personal Announcements
    const announceRef = ref(db, 'announcements');
    onValue(announceRef, (snap) => {
        if (!snap.exists()) return;
        
        snap.forEach(child => {
            const announcement = child.val();
            const announceId = child.key;
            
            // Check if user has already seen this specific announcement this session
            if (sessionStorage.getItem(`seen_announce_${announceId}`)) return;

            // Show if global OR if specifically for this user UID
            if (announcement.target === 'all' || announcement.target === user.uid) {
                showAnnouncement(announcement, announceId);
            }
        });
    });
}

function showBanModal(reason) {
    // We use document.write or a full-body replacement to ensure 
    // the user cannot "inspect element" and delete the modal to keep using the site.
    document.body.innerHTML = `
        <div style="position:fixed; inset:0; background:#000; display:flex; align-items:center; justify-content:center; z-index:99999; color:white; text-align:center; padding:20px; font-family:sans-serif;">
            <div style="position:absolute; inset:0; background:url('https://i.imgur.com/your-bg.jpg') center/cover; opacity:0.2; filter:blur(10px);"></div>
            <div style="position:relative; max-width:400px; background:rgba(20,20,20,0.8); backdrop-filter:blur(20px); padding:40px; border-radius:30px; border:1px solid #ff4b4b; box-shadow:0 0 50px rgba(255,75,75,0.2);">
                <div style="font-size:50px; margin-bottom:10px;">üö´</div>
                <h1 style="color:#ff4b4b; font-size:24px; font-weight:900; letter-spacing:1px;">ACCESS REVOKED</h1>
                <p style="margin:20px 0; color:#bbb; line-height:1.6;">You have been banned for:<br>
                <strong style="color:#fff; display:block; margin-top:10px; font-size:16px;">${reason}</strong></p>
                <button onclick="window.location.href='mailto:appeal@itzhoyoo.com?subject=Ban Appeal: ${auth.currentUser.uid}'" 
                        style="background:#ff4b4b; color:white; border:none; width:100%; padding:15px; border-radius:15px; font-weight:900; cursor:pointer; transition:0.3s;">
                    APPEAL THIS DECISION
                </button>
            </div>
        </div>`;
    // Stop all other background processes
    window.stop(); 
}

function showAnnouncement(data, id) {
    const notifyDiv = document.createElement('div');
    // Using var(--accent) for consistency with your existing theme
    notifyDiv.style.cssText = "position:fixed; top:20px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:var(--accent, #2e89ff); color:black; padding:15px; border-radius:20px; z-index:10000; box-shadow:0 10px 30px rgba(0,0,0,0.5); font-weight:900; display:flex; flex-direction:column; animation:slideDown 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);";
    
    notifyDiv.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(0,0,0,0.1); padding-bottom:5px; margin-bottom:8px;">
            <span style="font-size:10px; letter-spacing:1px;">üì¢ ITZHOYOO UPDATE</span>
            <button id="close-announce-${id}" style="background:none; border:none; font-size:20px; cursor:pointer; font-weight:bold;">&times;</button>
        </div>
        <p style="margin:0; font-size:13px; font-weight:700; line-height:1.4;">${data.message}</p>
    `;
    
    document.body.appendChild(notifyDiv);

    document.getElementById(`close-announce-${id}`).onclick = () => {
        notifyDiv.style.transform = "translateX(-50%) translateY(-100px)";
        notifyDiv.style.opacity = "0";
        setTimeout(() => {
            notifyDiv.remove();
            // Mark as seen so it doesn't reappear until the next login/session
            sessionStorage.setItem(`seen_announce_${id}`, 'true');
        }, 400);
    };
}

</script>

</main>
</body>
</html>