<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-select=no">
  <title>Create - RBX Community</title>
  <style>
    /* --- RESET & BASE --- */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none !important;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: "Gotham SSm", "Blinker", -apple-system, system-ui, sans-serif;
      background: radial-gradient(circle at top left, #1a1a2e, #0a0a0a);
      background-attachment: fixed;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      user-select: none;
      -webkit-user-select: none;
    }

    /* --- IOS LOADER --- */
    #ios-loader {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 100000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.8s ease;
    }
    .ios-tick-spinner { position: relative; width: 40px; height: 40px; }
    .ios-tick-spinner .bar {
      width: 3px; height: 10px; background: #636366; position: absolute;
      left: 50%; top: 50%; transform-origin: 50% 100%; border-radius: 2px;
      animation: ios-fade 1s linear infinite;
    }
    /* Spinner Animation */
    @keyframes ios-fade { from { background: #fff; } to { background: #2c2c2e; } }
    .bar:nth-child(1) { transform: translate(-50%, -150%) rotate(0deg); animation-delay: 0s; }
    .bar:nth-child(2) { transform: translate(-50%, -150%) rotate(30deg); animation-delay: -0.916s; }
    .bar:nth-child(3) { transform: translate(-50%, -150%) rotate(60deg); animation-delay: -0.833s; }
    .bar:nth-child(4) { transform: translate(-50%, -150%) rotate(90deg); animation-delay: -0.75s; }
    .bar:nth-child(5) { transform: translate(-50%, -150%) rotate(120deg); animation-delay: -0.666s; }
    .bar:nth-child(6) { transform: translate(-50%, -150%) rotate(150deg); animation-delay: -0.583s; }
    .bar:nth-child(7) { transform: translate(-50%, -150%) rotate(180deg); animation-delay: -0.5s; }
    .bar:nth-child(8) { transform: translate(-50%, -150%) rotate(210deg); animation-delay: -0.416s; }
    .bar:nth-child(9) { transform: translate(-50%, -150%) rotate(240deg); animation-delay: -0.333s; }
    .bar:nth-child(10) { transform: translate(-50%, -150%) rotate(270deg); animation-delay: -0.25s; }
    .bar:nth-child(11) { transform: translate(-50%, -150%) rotate(300deg); animation-delay: -0.166s; }
    .bar:nth-child(12) { transform: translate(-50%, -150%) rotate(330deg); animation-delay: -0.083s; }

    /* --- PROFILE CARD --- */
    .user-profile-card {
      width: 100%;
      max-width: 400px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 35px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 15px 35px rgba(0,0,0,0.4);
      text-align: center;
      margin-bottom: 25px;
    }

    .user-profile-card img {
      width: 90px;
      height: 90px;
      border-radius: 28px;
      object-fit: cover;
      border: 4px solid #00bfff;
      box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
      margin-bottom: 12px;
    }

    .user-profile-card h2 { margin: 0; font-size: 22px; font-weight: 800; }
    .user-profile-card p { margin: 5px 0 0; color: #00bfff; font-weight: 700; opacity: 0.9; }

    /* --- TAB SELECTOR --- */
    section.selector {
      display: flex;
      background: rgba(0, 0, 0, 0.4);
      padding: 6px;
      border-radius: 24px;
      gap: 5px;
      margin-bottom: 30px;
    }

    section.selector button {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 18px;
      background: transparent;
      color: #888;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    section.selector button.active {
      background: #00bfff;
      color: #000;
      transform: scale(1.05);
      box-shadow: 0 8px 15px rgba(0, 191, 255, 0.3);
    }

    /* --- CARDS & INPUTS --- */
    .type-fields { width: 100%; max-width: 450px; display: none; }
    .type-fields.active { display: block; animation: slideUp 0.4s ease; }

    @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

    .section-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 28px;
      padding: 22px;
      margin-bottom: 18px;
      border-bottom: 5px solid rgba(0,0,0,0.2);
    }

    .section-card h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #00bfff;
      margin: 0 0 12px 5px;
    }

    input, textarea, select {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 18px;
      padding: 16px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      transition: 0.2s;
    }

    input:focus { border-color: #00bfff; background: rgba(0,0,0,0.5); }

    /* --- CUSTOM IOS TOGGLE --- */
    .toggle-row { display: flex; justify-content: space-between; align-items: center; }
    .ios-switch {
      position: relative; display: inline-block; width: 50px; height: 28px;
    }
    .ios-switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; inset: 0;
      background: #333; transition: .4s; border-radius: 34px;
    }
    .slider:before {
      position: absolute; content: ""; height: 22px; width: 22px;
      left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background: #30d158; }
    input:checked + .slider:before { transform: translateX(22px); }

    /* --- UPLOAD PREVIEW --- */
    .upload-preview {
      width: 100%;
      height: 180px;
      background: rgba(0, 0, 0, 0.2);
      border: 3px dashed rgba(0, 191, 255, 0.2);
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
      color: #666; font-weight: 700;
    }
    .upload-preview img { width: 100%; height: 100%; object-fit: contain; }

    /* --- CREATE BUTTON --- */
    #createBtn {
      width: 100%;
      max-width: 450px;
      padding: 22px;
      border-radius: 25px;
      border: none;
      background: linear-gradient(180deg, #00cdff 0%, #00a2ff 100%);
      color: #fff;
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      border-bottom: 6px solid #007acc;
      margin: 20px 0 50px;
      cursor: pointer;
    }
    #createBtn:active { transform: translateY(4px); border-bottom-width: 2px; }

    /* --- UTILS --- */
    .hidden { display: none; }
    body.no-scroll {
  overflow: hidden;
  position: fixed;
  width: 100%;
}

  </style>
</head>
<body>
<div id="ios-loader">
  <div style="margin-bottom:30px;">
      <img src="https://i.imgur.com/cM3Givj.jpeg" style="max-width: 100px; border-radius: 22px; box-shadow: 0 10px 20px rgba(0,0,0,0.5);">
  </div>
  <div class="ios-tick-spinner">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
      <span id="load-pct" style="color: #fff; font-size: 10px; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">0%</span>
  </div>
</div>

<div class="user-profile-card">
  <img id="userProfilePic" src="default-avatar.png">
  <h2 id="userHandle">@Guest</h2>
  <p id="postCountDisplay">0 Posts</p>
</div>


<section class="selector">
  <button data-type="post" class="active">
    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M14 4H2v9h12V4zM2 3a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H2z"/></svg>
    <span>Post</span>
  </button>
  <button data-type="story">
    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0a8 8 0 1 0 8 8A8 8 0 0 0 8 0zm0 1a7 7 0 1 1-7 7A7 7 0 0 1 8 1z"/></svg>
    <span>Story</span>
  </button>
  <button data-type="poll">
    <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor"><path d="M6 2h4v12H6V2zM2 6h2v6H2V6z"/></svg>
    <span>Poll</span>
  </button>
</section>

<div class="type-fields active" data-type="post">
  <div class="section-card">
    <h2>Post Title</h2>
    <input type="text" id="postTitle" placeholder="Required (Max 24)" maxlength="24">
  </div>
  <div class="section-card">
    <h2>Description</h2>
    <textarea id="postDescription" rows="3" placeholder="Tell us about it... (Required)"></textarea>
  </div>
  <div class="section-card">
    <div style="display:flex; gap:10px;">
      <div style="flex:1;">
        <h2>Category</h2>
        <select id="postCategory">
          <option>Games</option><option>Accessories</option><option>Clothing</option><option>Scripts</option>
        </select>
      </div>
      <div style="flex:1;">
        <h2>Privacy</h2>
        <select id="postPrivacy">
          <option value="public">Public</option><option value="private">Private</option>
        </select>
      </div>
    </div>
  </div>
  <div class="section-card">
    <h2>Media</h2>
    <div class="upload-preview" onclick="document.getElementById('postImageInput').click()" id="postImagePreview">Tap to add Image *</div>
    <input type="file" id="postImageInput" class="hidden" accept="image/*">
  </div>
  <div class="section-card">
    <div class="toggle-row">
      <h2>Sponsored</h2>
      <label class="ios-switch">
        <input type="checkbox" id="postSponsored">
        <span class="slider"></span>
      </label>
    </div>
  </div>
</div>

<div class="type-fields" data-type="story" style="display:none;">
  <div class="section-card">
    <h2>Story Title</h2>
    <input type="text" id="storyTitle" placeholder="Required (Max 16)" maxlength="16">
  </div>
  <div class="section-card">
    <h2>Story Image</h2>
    <div class="upload-preview" onclick="document.getElementById('storyImageInput').click()" id="storyImagePreview">Select Media *</div>
    <input type="file" id="storyImageInput" class="hidden" accept="image/*">
  </div>
  <div class="section-card">
    <div class="toggle-row">
      <h2>Sponsored Story</h2>
      <label class="ios-switch">
        <input type="checkbox" id="storySponsored">
        <span class="slider"></span>
      </label>
    </div>
  </div>
</div>

<div class="type-fields" data-type="poll" style="display:none;">
  <div class="section-card">
    <h2>Question</h2>
    <input type="text" id="pollQuestion" placeholder="What do you think?">
  </div>
  <div class="section-card">
    <h2>Options</h2>
    <div id="pollOptionsContainer">
      <input type="text" class="pollOption" placeholder="Option 1" style="margin-bottom:8px;">
      <input type="text" class="pollOption" placeholder="Option 2">
    </div>
    <button type="button" id="addPollOption" style="background:transparent; border:none; color:#00bfff; font-weight:800; margin-top:10px; cursor:pointer;">+ Add Option</button>
  </div>
</div>

<button id="createBtn">Create Now</button>

<div id="ios-popup" style="position:fixed; top:-100px; left:50%; transform:translateX(-50%); width:90%; max-width:400px; background:rgba(255,255,255,0.1); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border-radius:20px; padding:15px; display:flex; align-items:center; gap:12px; z-index:200000; transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); border:1px solid rgba(255,255,255,0.2); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
    <div id="popup-icon" style="width:30px; height:30px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold;">!</div>
    <div id="popup-text" style="color:#fff; font-weight:600; font-size:14px;">Message here</div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, push, get, runTransaction, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9cd31082a5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* --- Global State --- */
let selectedType = 'post';
let currentUser = null;
const createBtn = document.getElementById('createBtn');

// UI Lock
document.body.style.overflow = 'hidden';

const sponsoredLinks = [
    "https://otieu.com/4/7197807", "https://otieu.com/4/8784016",
    "https://otieu.com/4/7216382", "https://otieu.com/4/7197806",
    "https://otieu.com/4/7950037", "https://otieu.com/4/7165724",
    "https://otieu.com/4/8272145"
];

/* --- Notification System --- */
function showPopup(msg, isError = false) {
    const popup = document.getElementById('ios-popup');
    const icon = document.getElementById('popup-icon');
    const text = document.getElementById('popup-text');
    if(!popup) return;
    text.innerText = msg;
    icon.style.background = isError ? "#ff453a" : "#30d158";
    icon.innerText = isError ? "✕" : "✓";
    popup.style.top = "20px";
    setTimeout(() => { popup.style.top = "-100px"; }, 3000);
}

/* --- UI Interactions --- */

document.querySelectorAll('section.selector button').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('section.selector button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedType = btn.getAttribute('data-type');
        document.querySelectorAll('.type-fields').forEach(f => {
            f.style.display = f.getAttribute('data-type') === selectedType ? 'block' : 'none';
        });
    });
});

document.getElementById('addPollOption')?.addEventListener('click', () => {
    const container = document.getElementById('pollOptionsContainer');
    const input = document.createElement('input');
    input.type = "text";
    input.className = 'pollOption';
    input.placeholder = `Option ${container.querySelectorAll('.pollOption').length + 1}`;
    input.style.cssText = "width:100%; margin-top:8px; padding:16px; background:rgba(0,0,0,0.3); border:2px solid rgba(255,255,255,0.1); border-radius:18px; color:#fff;";
    container.appendChild(input);
});

function setupPreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    if(!input) return;
    input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            document.getElementById(previewId).innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover; border-radius:18px;">`;
        }
    });
}
setupPreview('postImageInput', 'postImagePreview');
setupPreview('storyImageInput', 'storyImagePreview');

/* --- Data Handlers --- */

onAuthStateChanged(auth, async user => {
    if (user) {
        currentUser = user;
        
        // 1. Load Profile
        const userRef = ref(db, `users/${user.uid}`);
        const snap = await get(userRef);
        const data = snap.val() || {};
        
        if(document.getElementById('userHandle')) document.getElementById('userHandle').innerText = `@${data.handle || 'User'}`;
        if(data.profilePic) document.getElementById('userProfilePic').src = data.profilePic;

        // 2. Real-time Post Counter (FIXED ID: postCountDisplay)
        const postCountRef = ref(db, `users/${user.uid}/posts`);
        onValue(postCountRef, (snapshot) => {
            const count = snapshot.val() || 0;
            const display = document.getElementById('postCountDisplay');
            if(display) {
                display.innerText = `${count} Posts`;
            }
        });
    }

    // Hide Loader
    setTimeout(() => { 
        const loader = document.getElementById('ios-loader');
        if(loader) {
            loader.style.opacity = "0"; 
            setTimeout(() => {
                loader.remove();
                document.body.style.overflow = 'auto';
            }, 800);
        }
    }, 1200);
});

async function uploadToImgur(file) {
    const formData = new FormData();
    formData.append('image', file);
    try {
        const res = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: { Authorization: 'Client-ID 891e5bb4aa94282' },
            body: formData
        });
        const data = await res.json();
        return data.success ? data.data.link : null;
    } catch(e) { return null; }
}

/* --- Main Create Action --- */
createBtn.addEventListener('click', async () => {
    if (!currentUser) return showPopup("Login Required", true);
    
    createBtn.innerText = "PROCESSING...";
    createBtn.disabled = true;

    try {
        let payload = { uid: currentUser.uid, timestamp: Date.now(), type: selectedType };
        const getRandomLink = () => sponsoredLinks[Math.floor(Math.random() * sponsoredLinks.length)];

        if (selectedType === 'post') {
            const title = document.getElementById('postTitle').value.trim();
            const desc = document.getElementById('postDescription').value.trim();
            const file = document.getElementById('postImageInput').files[0];
            const isSpon = document.getElementById('postSponsored').checked;

            if (!title || !desc || !file) throw "All fields required!";
            
            payload.image = await uploadToImgur(file);
            if(!payload.image) throw "Upload failed!";
            payload.title = title;
            payload.description = desc;
            payload.category = document.getElementById('postCategory').value;
            payload.sponsored = isSpon;
            payload.link = isSpon ? getRandomLink() : "";
        } 
        
        else if (selectedType === 'story') {
            const title = document.getElementById('storyTitle').value.trim();
            const file = document.getElementById('storyImageInput').files[0];
            const isSpon = document.getElementById('storySponsored').checked;
            if (!title || !file) throw "Title and Image required!";
            payload.title = title;
            payload.image = await uploadToImgur(file);
            if(!payload.image) throw "Upload failed!";
            payload.sponsored = isSpon;
            payload.link = isSpon ? getRandomLink() : "";
        }

        else if (selectedType === 'poll') {
            const question = document.getElementById('pollQuestion').value.trim();
            const options = [...document.querySelectorAll('.pollOption')].map(o => o.value.trim()).filter(v => v);
            if (!question || options.length < 2) throw "Min 2 options required";
            payload.question = question;
            payload.options = options;
        }

        // 1. Save Post
        await push(ref(db, selectedType), payload);
        
        // 2. Increment Counter
        await runTransaction(ref(db, `users/${currentUser.uid}/posts`), (curr) => {
            return (curr || 0) + 1;
        });
        
        showPopup("Created Successfully!");
        
        // Wait 1.5s then reload
        setTimeout(() => location.reload(), 1500);

    } catch (e) {
        showPopup(e.message || e, true);
        createBtn.innerText = "Create Now";
        createBtn.disabled = false;
    }
});
</script>



</body>
</html>
